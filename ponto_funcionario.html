<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Rotas de Frota - Logística</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones Font Awesome (para botões) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Configuração de Fonte Padrão e Estilos Globais */
        :root {
            --primary-color: #3b82f6; /* blue-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            min-height: 100vh;
        }
        .container-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* blue-600 */
        }
        /* Garantir que a tabela seja responsiva com muitas colunas */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
        
        /* Estilo para a Janela Modal de Foto */
        .photo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .photo-modal-content {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            flex-direction: column;
        }
        .photo-modal-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 0.25rem;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start pt-10 pb-10">

    <div id="app-container" class="w-full max-w-full xl:max-w-6xl p-4 md:p-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">
            Sistema de Rastreamento de Rotas
        </h1>

        <!-- Botões de Navegação -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="show-driver-btn" class="px-6 py-2 rounded-lg font-semibold text-white bg-blue-500 hover:bg-blue-600 transition-colors">
                Motorista
            </button>
            <button id="show-admin-btn" class="px-6 py-2 rounded-lg font-semibold text-blue-500 border border-blue-500 hover:bg-blue-50 transition-colors">
                Administrativo
            </button>
        </div>

        <!-- Mensagens de Feedback/Erro -->
        <div id="message-area" class="text-center mb-4 p-3 rounded-lg hidden"></div>

        <!-- 1. Interface do Motorista -->
        <div id="driver-view" class="container-card">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Registro de Viagem</h2>
            
            <!-- Formulário de Saída (Visível se Não Estiver em Viagem) -->
            <div id="start-trip-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="driver-name" class="block text-sm font-medium text-gray-700">Nome do Motorista</label>
                        <input type="text" id="driver-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500" placeholder="Seu Nome Completo">
                    </div>
                    <div>
                        <label for="license-plate" class="block text-sm font-medium text-gray-700">Placa do Veículo</label>
                        <input type="text" id="license-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500 uppercase" placeholder="ABC1234">
                    </div>
                    <div>
                        <label for="km-start" class="block text-sm font-medium text-gray-700">KM Inicial (Odômetro)</label>
                        <input type="number" id="km-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: 55000">
                    </div>
                </div>

                <!-- Campo de Anexo de Foto de Saída -->
                <div class="mb-6 p-4 border border-blue-300 rounded-lg bg-blue-50">
                    <label for="photo-start" class="block text-base font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-camera mr-2"></i> 1. Foto OBRIGATÓRIA do Painel/Odômetro
                    </label>
                    <input type="file" id="photo-start" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'start')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    <p id="photo-start-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="startTrip()" class="w-full btn-primary bg-green-500 text-white py-3 rounded-lg text-lg font-bold shadow-md hover:bg-green-600">
                    <i class="fas fa-play"></i> Iniciar Saída
                </button>
                <p class="text-sm text-gray-500 mt-2 text-center">Será registrada a sua localização, hora e a foto do painel.</p>
            </div>

            <!-- Painel de Viagem em Andamento (Visível se Estiver em Viagem) -->
            <div id="trip-in-progress" class="hidden text-center p-6 border-2 border-dashed border-blue-300 bg-blue-50 rounded-lg">
                <h3 class="text-xl font-bold text-blue-700 mb-4">Viagem em Andamento!</h3>
                <p class="text-gray-600 mb-2">Motorista: <span id="current-driver-name" class="font-semibold"></span></p>
                <p class="text-gray-600 mb-4">Placa: <span id="current-license-plate" class="font-semibold"></span></p>

                <div class="flex justify-center items-baseline mb-6">
                    <span class="text-5xl font-extrabold text-blue-800" id="timer-display">00:00:00</span>
                </div>

                <label for="km-end" class="block text-sm font-medium text-gray-700 mb-2">KM Final (Odômetro)</label>
                <input type="number" id="km-end" class="mb-4 block w-full md:w-1/2 mx-auto rounded-md border-gray-300 shadow-sm p-3 border text-center focus:ring-blue-500 focus:border-blue-500" placeholder="KM de Chegada">

                 <!-- Campo de Anexo de Foto de Chegada -->
                <div class="mb-6 p-4 border border-red-300 rounded-lg bg-red-50">
                    <label for="photo-end" class="block text-base font-semibold text-gray-700 mb-2 flex items-center">
                        <i class="fas fa-camera mr-2"></i> 2. Foto OBRIGATÓRIA do Painel/Odômetro de Chegada
                    </label>
                    <input type="file" id="photo-end" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'end')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100"/>
                    <p id="photo-end-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="endTrip()" class="w-full btn-primary bg-red-500 text-white py-3 rounded-lg text-lg font-bold shadow-md hover:bg-red-600">
                    <i class="fas fa-stop"></i> Registrar Chegada e Finalizar Rota
                </button>
            </div>
        </div>

        <!-- 2. Interface Administrativa (Oculta Inicialmente) -->
        <div id="admin-view" class="container-card hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Painel Administrativo</h2>
            
            <!-- Login -->
            <div id="admin-login-area">
                <label for="admin-password" class="block text-sm font-medium text-gray-700">Senha de Acesso</label>
                <input type="password" id="admin-password" class="mt-1 block w-full md:w-96 rounded-md border-gray-300 shadow-sm p-3 border focus:ring-blue-500 focus:border-blue-500" placeholder="Senha">
                <button onclick="adminLogin()" class="mt-4 btn-primary bg-blue-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-blue-600">
                    Acessar
                </button>
                <p class="text-xs text-red-500 mt-2 hidden" id="login-error-message">Senha incorreta. (Senha padrão: admin123)</p>
            </div>

            <!-- Dashboard -->
            <div id="admin-dashboard" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Rotas Concluídas</h3>

                <!-- Filtros e Exportação -->
                <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex-grow">
                        <label for="filter-plate" class="block text-sm font-medium text-gray-700">Filtrar por Placa</label>
                        <input type="text" id="filter-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border uppercase" placeholder="Placa (ex: ABC1234)">
                    </div>
                    <div class="flex-grow">
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                        <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="flex-grow">
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Data Final</label>
                        <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                    </div>
                    <div class="flex-shrink-0 flex items-end">
                        <button onclick="applyAdminFilters()" class="btn-primary bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 w-full md:w-auto">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mb-4">
                     <button onclick="exportToCSV()" class="btn-primary bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700">
                        Exportar para Planilha (CSV)
                    </button>
                </div>

                <!-- Tabela de Dados -->
                <div class="overflow-x-auto">
                    <!-- Número de colunas: 12 (10 dados + 2 fotos) -->
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Motorista</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placa</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saída (Data/Hora)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local de Saída</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chegada (Data/Hora)</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Local de Chegada</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KM Inicial</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KM Final</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KM Total</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tempo</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Foto Saída</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Foto Chegada</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Colspan ajustado para 12 colunas -->
                            <tr><td colspan="12" class="p-4 text-center text-gray-500">Nenhuma rota encontrada ou carregando...</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        
        <!-- Janela Modal para Visualização da Foto -->
        <div id="photo-modal" class="photo-modal-overlay hidden" onclick="this.classList.add('hidden')">
            <div class="photo-modal-content" onclick="event.stopPropagation()">
                <button onclick="document.getElementById('photo-modal').classList.add('hidden')" class="self-end text-xl font-bold text-gray-700 hover:text-red-500 mb-2">
                    &times;
                </button>
                <img id="modal-image" src="" alt="Foto do Painel">
                <p id="modal-caption" class="mt-4 text-center text-gray-600"></p>
            </div>
        </div>

    </div>

    <!-- Scripts do Firebase e Lógica da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs para debug
        setLogLevel('Debug');

        // --- CONFIGURAÇÃO FIREBASE (COM AS SUAS INFORMAÇÕES) ---
        // OBS: Estou usando a mesma configuração anterior
        const firebaseConfig = {
            apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
            authDomain: "marcador-ponto-digital.firebaseapp.com",
            projectId: "marcador-ponto-digital",
            storageBucket: "marcador-ponto-digital.firebasestorage.app",
            messagingSenderId: "774324665760",
            appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5",
            measurementId: "G-W1QEJTCS1B"
        };
        
        const appId = firebaseConfig.appId;

        let app, db, auth;
        let userId = null;
        let currentTripDocId = localStorage.getItem('currentTripDocId'); 
        let timerInterval = null;
        const ADMIN_PASSWORD = "admin123"; 

        // Variáveis para armazenar as fotos em Base64 temporariamente
        let startPhotoBase64 = null;
        let endPhotoBase64 = null;

        const ROUTES_COLLECTION_PATH = `/artifacts/${appId}/public/data/driver_routes`;

        // Elementos DOM
        const driverView = document.getElementById('driver-view');
        const adminView = document.getElementById('admin-view');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLoginArea = document.getElementById('admin-login-area');
        const loginErrorMessage = document.getElementById('login-error-message');
        const messageArea = document.getElementById('message-area');
        const startTripForm = document.getElementById('start-trip-form');
        const tripInProgress = document.getElementById('trip-in-progress');
        const timerDisplay = document.getElementById('timer-display');
        const adminTableBody = document.getElementById('admin-table-body');
        const photoModal = document.getElementById('photo-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCaption = document.getElementById('modal-caption');

        // --- Funções Auxiliares ---

        function displayMessage(text, type = 'info') {
            messageArea.textContent = text;
            messageArea.className = 'text-center mb-4 p-3 rounded-lg block';
            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageArea.classList.add('bg-blue-100', 'text-blue-800');
            }
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove('block');
            }, 5000);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalização não é suportada pelo seu navegador.'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                        });
                    },
                    (error) => {
                        console.error("Erro na geolocalização:", error);
                        reject(new Error('Não foi possível obter a localização. Certifique-se de que a localização está ativada e tente novamente.'));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        async function getStreetAndNeighborhood(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'RotaFleetTrackerApp/1.0 (CanvasApp; contact: logistics@example.com)'
                    }
                });
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    let result = '';
                    const road = address.road || '';
                    const neighbourhood = address.suburb || address.neighbourhood || address.city_district || '';
                    const city = address.city || address.town || address.village || address.county || '';
                    
                    if (road) { result += road; }
                    if (road && neighbourhood) { result += `, ${neighbourhood}`; } else if (neighbourhood) { result += neighbourhood; }
                    if (!result && city) { result = city; }

                    return result || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
                }
            } catch (error) {
                console.error("Erro no Reverse Geocoding:", error);
            }
            return `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        }

        /**
         * Redimensiona a imagem para uma largura máxima e a converte para Base64.
         * Isso é crucial para tentar manter o tamanho do documento Firestore abaixo de 1MB.
         * @param {File} file O objeto File da imagem.
         * @param {number} maxWidth Largura máxima desejada.
         * @param {number} maxHeight Altura máxima desejada.
         * @returns {Promise<string>} A string Base64 da imagem redimensionada.
         */
        function resizeImageAndConvertToBase64(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                        // Calcula novas dimensões mantendo o aspecto
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        // Desenha a imagem redimensionada
                        ctx.drawImage(img, 0, 0, width, height);

                        // Converte para Base64 (qualidade 0.9 para JPG)
                        // Tentamos usar image/jpeg para menor tamanho
                        const base64String = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(base64String);
                    };
                    img.onerror = (e) => reject(new Error('Erro ao carregar a imagem.'));
                    img.src = event.target.result;
                };
                reader.onerror = (e) => reject(new Error('Erro ao ler o arquivo.'));
                reader.readAsDataURL(file);
            });
        }

        window.handleImageUpload = async function(event, type) {
            const fileInput = event.target;
            const statusElement = document.getElementById(`photo-${type}-status`);
            statusElement.textContent = 'Processando e redimensionando foto... Aguarde.';
            statusElement.classList.remove('text-gray-600', 'text-green-600');
            statusElement.classList.add('text-blue-600');

            if (fileInput.files.length === 0) {
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
                statusElement.textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                statusElement.classList.remove('text-blue-600');
                statusElement.classList.add('text-gray-600');
                return;
            }

            const file = fileInput.files[0];
            const MAX_SIZE = 800; // Largura/Altura máxima em pixels

            try {
                const base64 = await resizeImageAndConvertToBase64(file, MAX_SIZE, MAX_SIZE);
                
                if (type === 'start') {
                    startPhotoBase64 = base64;
                } else {
                    endPhotoBase64 = base64;
                }
                
                // Exibe o tamanho aproximado (em KB)
                const sizeKB = Math.round(base64.length * 0.75 / 1024); 
                statusElement.textContent = `Foto anexada e redimensionada! (~${sizeKB} KB)`;
                statusElement.classList.remove('text-blue-600', 'text-red-600');
                statusElement.classList.add('text-green-600');

            } catch (error) {
                console.error("Erro no processamento da imagem:", error);
                displayMessage('Erro ao processar a foto. Tente novamente ou use uma imagem menor.', 'error');
                statusElement.textContent = 'Erro ao processar a foto.';
                statusElement.classList.remove('text-blue-600', 'text-green-600');
                statusElement.classList.add('text-red-600');
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
                fileInput.value = ''; // Limpa o input
            }
        }


        // --- Funções de Estado e UI ---

        function updateDriverUI(tripData = null) {
            if (tripData) {
                startTripForm.classList.add('hidden');
                tripInProgress.classList.remove('hidden');

                document.getElementById('current-driver-name').textContent = tripData.driverName;
                document.getElementById('current-license-plate').textContent = tripData.licensePlate;

                // Resetar fotos de chegada
                document.getElementById('photo-end').value = '';
                document.getElementById('photo-end-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-end-status').classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-end-status').classList.add('text-gray-600');
                endPhotoBase64 = null;


                clearInterval(timerInterval);
                const startTimeMs = tripData.startTime.toDate().getTime();
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - startTimeMs) / 1000);
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);

            } else {
                startTripForm.classList.remove('hidden');
                tripInProgress.classList.add('hidden');
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00:00';
                
                // Limpar todos os campos e variáveis temporárias de foto ao resetar a UI
                document.getElementById('driver-name').value = '';
                document.getElementById('license-plate').value = '';
                document.getElementById('km-start').value = '';
                document.getElementById('photo-start').value = '';
                document.getElementById('photo-start-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-start-status').classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-start-status').classList.add('text-gray-600');
                startPhotoBase64 = null;
            }
        }

        window.viewPhoto = function(base64Data, caption) {
            if (base64Data) {
                modalImage.src = base64Data;
                modalCaption.textContent = caption;
                photoModal.classList.remove('hidden');
            } else {
                displayMessage('Foto não disponível ou não anexada para esta rota.', 'error');
            }
        }

        function renderAdminTable(routes) {
            adminTableBody.innerHTML = ''; // Limpa a tabela

            if (routes.length === 0) {
                // Colspan ajustado para 12 colunas
                adminTableBody.innerHTML = '<tr><td colspan="12" class="p-4 text-center text-gray-500">Nenhuma rota concluída encontrada para o filtro atual.</td></tr>';
                return;
            }

            routes.forEach(route => {
                const totalKm = route.kmEnd - route.kmStart;
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const endTimeStr = route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const elapsedTimeStr = route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A';
                
                const startAddress = route.startLocation?.address || `Lat: ${route.startLocation?.lat.toFixed(4)}`;
                const endAddress = route.endLocation?.address || `Lat: ${route.endLocation?.lat.toFixed(4)}`;
                
                // Botões de Visualização de Foto
                const startPhotoBtn = route.startPhoto 
                    ? `<button onclick="viewPhoto('${route.startPhoto}', 'Foto de Saída da Placa ${route.licensePlate}')" class="text-white bg-blue-500 hover:bg-blue-600 p-2 rounded-md text-sm"><i class="fas fa-eye"></i></button>`
                    : `<span class="text-gray-400 text-xs">Sem foto</span>`;
                
                const endPhotoBtn = route.endPhoto
                    ? `<button onclick="viewPhoto('${route.endPhoto}', 'Foto de Chegada da Placa ${route.licensePlate}')" class="text-white bg-blue-500 hover:bg-blue-600 p-2 rounded-md text-sm"><i class="fas fa-eye"></i></button>`
                    : `<span class="text-gray-400 text-xs">Sem foto</span>`;


                const newRow = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${route.driverName}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${route.licensePlate}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${startTimeStr}</td>
                        <td class="px-3 py-4 text-sm text-gray-700 max-w-xs truncate">${startAddress}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${endTimeStr}</td>
                        <td class="px-3 py-4 text-sm text-gray-700 max-w-xs truncate">${endAddress}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${route.kmStart ? route.kmStart.toFixed(1) : 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${route.kmEnd ? route.kmEnd.toFixed(1) : 'N/A'}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${totalKm.toFixed(1)} km</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-blue-600">${elapsedTimeStr}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-center">${startPhotoBtn}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-center">${endPhotoBtn}</td>
                    </tr>
                `;
                adminTableBody.innerHTML += newRow;
            });
        }

        // --- Funções de Persistência (Firestore) ---

        let allRoutesData = []; 

        async function listenForCurrentTrip() {
            if (!db || !userId) return;

            // ... (A lógica de monitoramento de viagem em andamento é a mesma) ...

            // 1. Tenta monitorar o documento salvo localmente
            if (currentTripDocId) {
                const docRef = doc(db, ROUTES_COLLECTION_PATH, currentTripDocId);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().status === 'In Progress') {
                        updateDriverUI(docSnap.data());
                    } else {
                        currentTripDocId = null;
                        localStorage.removeItem('currentTripDocId');
                        updateDriverUI(null);
                    }
                }, (error) => {
                    console.error("Erro ao monitorar viagem atual:", error);
                    updateDriverUI(null);
                });
            } else {
                // 2. Se não houver ID local, tenta encontrar uma viagem 'In Progress' para este usuário
                const q = query(
                    collection(db, ROUTES_COLLECTION_PATH),
                    where('userId', '==', userId),
                    where('status', '==', 'In Progress')
                );
                
                onSnapshot(q, (snapshot) => {
                    if (!snapshot.empty) {
                        const tripDoc = snapshot.docs[0];
                        currentTripDocId = tripDoc.id;
                        localStorage.setItem('currentTripDocId', tripDoc.id);
                        updateDriverUI(tripDoc.data());
                    } else {
                        currentTripDocId = null;
                        localStorage.removeItem('currentTripDocId');
                        updateDriverUI(null);
                    }
                }, (error) => {
                    console.error("Erro ao buscar viagem em andamento:", error);
                    updateDriverUI(null);
                });
            }
        }

        async function listenForAdminRoutes() {
            if (!db) return;

            const q = query(
                collection(db, ROUTES_COLLECTION_PATH),
                where('status', '==', 'Completed')
            );
            
            onSnapshot(q, (snapshot) => {
                allRoutesData = [];
                snapshot.forEach((doc) => {
                    allRoutesData.push({ id: doc.id, ...doc.data() });
                });
                applyAdminFilters(); 
            }, (error) => {
                console.error("Erro ao monitorar rotas administrativas:", error);
                // Colspan alterado para 12
                adminTableBody.innerHTML = '<tr><td colspan="12" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            });
        }


        // --- Lógica do Motorista ---

        window.startTrip = async function() {
            if (!db || !userId) {
                displayMessage('Sistema não inicializado. Verifique a conexão com o Firebase.', 'error');
                return;
            }

            const driverName = document.getElementById('driver-name').value.trim();
            const licensePlate = document.getElementById('license-plate').value.trim().toUpperCase();
            const kmStart = parseFloat(document.getElementById('km-start').value);

            if (!driverName || !licensePlate || isNaN(kmStart) || kmStart <= 0) {
                displayMessage('Por favor, preencha todos os campos corretamente: Nome, Placa e KM Inicial válido (> 0).', 'error');
                return;
            }
            
            // VALIDAÇÃO OBRIGATÓRIA DA FOTO DE SAÍDA
            if (!startPhotoBase64) {
                 displayMessage('A foto do painel/odômetro na SAÍDA é obrigatória. Por favor, anexe a foto.', 'error');
                 return;
            }

            displayMessage('Buscando localização, endereço e salvando foto de saída...', 'info');

            try {
                const location = await getGeolocation();
                const address = await getStreetAndNeighborhood(location.lat, location.lon);
                
                const now = Timestamp.now();
                const newRouteRef = doc(collection(db, ROUTES_COLLECTION_PATH));

                const newTripData = {
                    driverName: driverName,
                    licensePlate: licensePlate,
                    kmStart: kmStart,
                    startTime: now,
                    startLocation: {
                        ...location,
                        address: address
                    },
                    // NOVA PROPRIEDADE
                    startPhoto: startPhotoBase64, 
                    userId: userId, 
                    status: 'In Progress',
                    kmEnd: null,
                    endTime: null,
                    endLocation: null,
                    endPhoto: null, // NOVA PROPRIEDADE
                    elapsedTimeSeconds: null,
                };

                await setDoc(newRouteRef, newTripData);

                currentTripDocId = newRouteRef.id;
                localStorage.setItem('currentTripDocId', currentTripDocId);

                // Limpa a foto temporária de SAÍDA (apenas o base64, o input é limpo pela UI reset)
                startPhotoBase64 = null; 

                displayMessage(`Saída registrada para ${licensePlate} em ${address} (com foto)!`, 'success');

            } catch (error) {
                console.error("Erro ao iniciar a viagem:", error);
                displayMessage(`Falha ao registrar saída. ${error.message || 'Verifique o console para detalhes.'} 
                                Atenção: Se a foto for muito grande, mesmo redimensionada, pode ocorrer erro.`, 'error');
            }
        }

        window.endTrip = async function() {
            if (!db || !currentTripDocId) {
                displayMessage('Nenhuma viagem em andamento para finalizar.', 'error');
                return;
            }

            const kmEnd = parseFloat(document.getElementById('km-end').value);

            if (isNaN(kmEnd) || kmEnd <= 0) {
                displayMessage('Por favor, insira um KM Final válido.', 'error');
                return;
            }
            
            // VALIDAÇÃO OBRIGATÓRIA DA FOTO DE CHEGADA
            if (!endPhotoBase64) {
                 displayMessage('A foto do painel/odômetro na CHEGADA é obrigatória. Por favor, anexe a foto.', 'error');
                 return;
            }

            displayMessage('Buscando localização final, endereço e salvando foto de chegada...', 'info');

            try {
                const docRef = doc(db, ROUTES_COLLECTION_PATH, currentTripDocId);
                const currentTripSnapshot = await getDocs(query(collection(db, ROUTES_COLLECTION_PATH), where('__name__', '==', currentTripDocId)));

                if (currentTripSnapshot.empty) {
                    displayMessage('Viagem não encontrada no banco de dados. Limpando estado local.', 'error');
                    localStorage.removeItem('currentTripDocId');
                    currentTripDocId = null;
                    return;
                }

                const currentTripData = currentTripSnapshot.docs[0].data();
                
                if (kmEnd < currentTripData.kmStart) {
                    displayMessage(`O KM Final (${kmEnd}) deve ser maior que o KM Inicial (${currentTripData.kmStart}).`, 'error');
                    return;
                }
                
                const endLocation = await getGeolocation();
                const endAddress = await getStreetAndNeighborhood(endLocation.lat, endLocation.lon);
                
                const endTime = Timestamp.now();
                
                const startTimeMs = currentTripData.startTime.toDate().getTime();
                const elapsedTimeSeconds = Math.floor((endTime.toDate().getTime() - startTimeMs) / 1000);

                const updateData = {
                    kmEnd: kmEnd,
                    endTime: endTime,
                    endLocation: {
                        ...endLocation,
                        address: endAddress
                    },
                    elapsedTimeSeconds: elapsedTimeSeconds,
                    // NOVA PROPRIEDADE
                    endPhoto: endPhotoBase64, 
                    status: 'Completed', 
                };

                await updateDoc(docRef, updateData);

                // Limpa o estado local
                localStorage.removeItem('currentTripDocId');
                currentTripDocId = null;
                endPhotoBase64 = null; // Limpa a foto temporária de CHEGADA

                displayMessage(`Viagem finalizada com sucesso em ${endAddress} (com foto)! Tempo: ${formatTime(elapsedTimeSeconds)}`, 'success');

            } catch (error) {
                console.error("Erro ao finalizar a viagem:", error);
                displayMessage(`Falha ao registrar chegada. ${error.message || 'Verifique o console para detalhes.'} 
                                Atenção: Se a foto for muito grande, mesmo redimensionada, pode ocorrer erro.`, 'error');
            }
        }

        // --- Lógica Administrativa (Filtros e Exportação mantidos, apenas renderAdminTable foi alterado) ---

        window.adminLogin = function() {
            const password = document.getElementById('admin-password').value;
            if (password === ADMIN_PASSWORD) {
                adminLoginArea.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                loginErrorMessage.classList.add('hidden');
                listenForAdminRoutes(); 
                displayMessage('Acesso administrativo concedido.', 'success');
            } else {
                loginErrorMessage.classList.remove('hidden');
                displayMessage('Senha incorreta. Tente novamente.', 'error');
            }
        }

        window.applyAdminFilters = function() {
            const plate = document.getElementById('filter-plate').value.trim().toUpperCase();
            const startDateStr = document.getElementById('filter-start-date').value;
            const endDateStr = document.getElementById('filter-end-date').value;

            let filteredData = allRoutesData;

            if (plate) {
                filteredData = filteredData.filter(route => route.licensePlate.includes(plate));
            }

            if (startDateStr) {
                const startOfDay = new Date(startDateStr);
                startOfDay.setHours(0, 0, 0, 0);
                const startTimestamp = startOfDay.getTime();
                
                filteredData = filteredData.filter(route => 
                    route.startTime && route.startTime.toDate().getTime() >= startTimestamp
                );
            }

            if (endDateStr) {
                const endOfDay = new Date(endDateStr);
                endOfDay.setHours(23, 59, 59, 999);
                const endTimestamp = endOfDay.getTime();

                filteredData = filteredData.filter(route => 
                    route.startTime && route.startTime.toDate().getTime() <= endTimestamp
                );
            }
            
            filteredData.sort((a, b) => b.startTime.toMillis() - a.startTime.toMillis());

            renderAdminTable(filteredData);
        }

        window.exportToCSV = function() {
            // Usa os dados atualmente filtrados
            const routesToExport = allRoutesData.filter(route => {
                // Lógica de filtro re-aplicada para exportação
                const plate = document.getElementById('filter-plate').value.trim().toUpperCase();
                const startDateStr = document.getElementById('filter-start-date').value;
                const endDateStr = document.getElementById('filter-end-date').value;

                let matchesPlate = plate ? route.licensePlate.includes(plate) : true;
                
                let matchesStartDate = true;
                if (startDateStr) {
                    const startOfDay = new Date(startDateStr);
                    matchesStartDate = route.startTime && route.startTime.toDate().getTime() >= startOfDay.setHours(0, 0, 0, 0);
                }

                let matchesEndDate = true;
                if (endDateStr) {
                    const endOfDay = new Date(endDateStr);
                    matchesEndDate = route.startTime && route.startTime.toDate().getTime() <= endOfDay.setHours(23, 59, 59, 999);
                }

                return matchesPlate && matchesStartDate && matchesEndDate;
            }).map(route => {
                const totalKm = (route.kmEnd - route.kmStart).toFixed(1);
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const endTimeStr = route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const elapsedTimeStr = route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A';
                
                const startAddress = route.startLocation?.address || 'N/A';
                const endAddress = route.endLocation?.address || 'N/A';
                
                // NOTA: Base64 é muito grande para CSV, apenas exportaremos as URLs de dados (que também são muito grandes, mas servem como referência)
                const startPhotoRef = route.startPhoto ? 'Anexado (Base64)' : 'N/A'; 
                const endPhotoRef = route.endPhoto ? 'Anexado (Base64)' : 'N/A'; 


                return [
                    route.driverName, 
                    route.licensePlate, 
                    startTimeStr, 
                    startAddress,
                    startPhotoRef, // NOVO: Referência da foto de saída
                    endTimeStr, 
                    endAddress,
                    endPhotoRef, // NOVO: Referência da foto de chegada
                    totalKm, 
                    elapsedTimeStr,
                    route.kmStart, 
                    route.kmEnd,
                    route.startLocation ? route.startLocation.lat : 'N/A',
                    route.startLocation ? route.startLocation.lon : 'N/A',
                    route.endLocation ? route.endLocation.lat : 'N/A',
                    route.endLocation ? route.endLocation.lon : 'N/A',
                ].map(item => `"${item}"`).join(';'); // Usa ponto e vírgula como separador
            });

            if (routesToExport.length === 0) {
                displayMessage('Não há dados para exportar com os filtros atuais.', 'error');
                return;
            }

            // Atualiza o cabeçalho do CSV
            const header = [
                "Motorista", "Placa", "Data_Hora_Saida", "Local_Saida", "Foto_Saida", "Data_Hora_Chegada", "Local_Chegada", "Foto_Chegada",
                "KM_Total_Rodado", "Tempo_Decorrido", "KM_Inicial", "KM_Final", 
                "Local_Saida_Lat", "Local_Saida_Lon", "Local_Chegada_Lat", "Local_Chegada_Lon"
            ];
            
            const csvContent = [header.join(';'), ...routesToExport].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `rotas_exportadas_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            displayMessage('Dados exportados com sucesso!', 'success');
        }

        // --- Inicialização ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        listenForCurrentTrip(); 
                        console.log(`Usuário autenticado: ${user.uid}`);
                    } else {
                        userId = null;
                        console.error('Usuário não autenticado.');
                        displayMessage('Falha na autenticação inicial. Recarregue a página.', 'error');
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                displayMessage(`Falha ao conectar com o banco de dados. Verifique o console.`, 'error');
            }
        }
        
        // --- Navegação de Views (mantidas) ---
        window.showDriverView = function() {
            driverView.classList.remove('hidden');
            adminView.classList.add('hidden');
            document.getElementById('show-driver-btn').classList.remove('border-blue-500', 'text-blue-500', 'bg-blue-50');
            document.getElementById('show-driver-btn').classList.add('bg-blue-500', 'text-white');
            document.getElementById('show-admin-btn').classList.add('border-blue-500', 'text-blue-500', 'bg-blue-50');
            document.getElementById('show-admin-btn').classList.remove('bg-blue-500', 'text-white');
        }

        window.showAdminView = function() {
            driverView.classList.add('hidden');
            adminView.classList.remove('hidden');
            document.getElementById('show-admin-btn').classList.remove('border-blue-500', 'text-blue-500', 'bg-blue-50');
            document.getElementById('show-admin-btn').classList.add('bg-blue-500', 'text-white');
            document.getElementById('show-driver-btn').classList.add('border-blue-500', 'text-blue-500', 'bg-blue-50');
            document.getElementById('show-driver-btn').classList.remove('bg-blue-500', 'text-white');
        }

        // Event Listeners para navegação
        document.getElementById('show-driver-btn').addEventListener('click', window.showDriverView);
        document.getElementById('show-admin-btn').addEventListener('click', window.showAdminView);

        // Inicia o Firebase e define a view inicial
        initFirebase();
        showDriverView();
    </script>
</body>
</html>