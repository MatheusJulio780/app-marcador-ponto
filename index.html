<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tempero da Casa</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        :root {
            --primary: #ff4757;
            --bg-app: #f1f2f6;
            --bg-card: #ffffff;
            --text-dark: #2f3542;
            --success: #2ed573;
            --pix-color: #32bcad;
            --driver-color: #2f3542;
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--bg-app); color: var(--text-dark); }

        /* --- UI COMPONENTS --- */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #747d8c; }
        .btn-pix { background: var(--pix-color); color: white; }
        .btn-driver { background: var(--driver-color); color: white; }
        .btn-danger { background: #ff6b81; color: white; }
        .btn-success { background: var(--success); color: white; }
        
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #dfe4ea; border-radius: 12px; background: #f8f9fa; font-size: 0.95rem; outline: none; }
        
        .card { background: var(--bg-card); padding: 20px; border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hidden { display: none !important; }

        /* --- CLIENTE --- */
        #app-client { max-width: 500px; margin: 0 auto; min-height: 100vh; background: white; position: relative; padding-bottom: 100px;}
        .hero-banner { background: var(--primary); height: 100px; border-radius: 0 0 25px 25px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; position: relative; }
        #btn-login-access { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display:flex; align-items:center; justify-content:center; }

        .menu-grid { padding: 0 20px; }
        .size-selector { display: flex; background: #f1f2f6; padding: 4px; border-radius: 12px; margin-bottom: 15px; }
        .size-opt { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: 600; color: #747d8c; transition: 0.2s; }
        .size-opt.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .total-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); border-radius: 20px 20px 0 0; z-index: 900; max-width: 500px; margin: 0 auto; right: 0; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 1.2rem; font-weight: 700; }

        /* --- STATUS --- */
        #panel-status { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 30px 20px; overflow-y: auto; text-align: center; }
        .status-line { height: 6px; background: #dfe4ea; width: 100%; margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        .status-progress { height: 100%; background: var(--success); width: 0%; transition: 1s ease; }
        .pix-alert-card { background: #fff3cd; border: 2px solid #ffc107; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; text-align: center; }

        /* --- ADMIN & DRIVER --- */
        #app-admin, #app-driver { display: none; min-height: 100vh; background: #dfe6e9; display: flex; }
        .sidebar { width: 250px; background: #2d3436; color: white; padding: 20px; display: flex; flex-direction: column; position: fixed; height: 100%; }
        .main-content { margin-left: 250px; flex: 1; padding: 20px; width: calc(100% - 250px); }
        .nav-btn { background: transparent; color: #b2bec3; text-align: left; margin-bottom: 5px; border-radius: 8px; padding: 10px; width: 100%; }
        .nav-btn.active { background: rgba(255,255,255,0.1); color: white; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .card-pix-pending { background: #fff0f6; border: 2px solid var(--pix-color); }

        /* TABLE REPORTS */
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .report-table th { background: #2d3436; color: white; }
        .report-table tr:hover { background: #f1f2f6; }

        @media (max-width: 768px) {
            #app-admin, #app-driver { flex-direction: column; }
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; width: 100%; }
            .admin-grid { grid-template-columns: 1fr; }
            .report-table { display: block; overflow-x: auto; }
        }

        #admin-map-container { height: 300px; width: 100%; border-radius: 12px; margin-top: 15px; }
        .qr-placeholder { width: 200px; height: 200px; background: #f0f0f0; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc; }
    </style>
</head>
<body>

<div id="app-client">
    <div id="view-order">
        <div class="hero-banner">
            Tempero da Casa ü•ò
            <button id="btn-login-access"><i class="fas fa-lock"></i></button>
        </div>
        
        <div class="menu-grid">
            <div class="card">
                <label><strong>Quem est√° pedindo?</strong></label>
                <input type="text" id="client-name" placeholder="Seu nome completo">
            </div>

            <div class="card">
                <label><strong>Escolha o Prato</strong></label>
                <select id="dish-select"><option value="">Carregando card√°pio...</option></select>
                <div class="size-selector">
                    <div class="size-opt" id="s-p" data-size="P">P</div>
                    <div class="size-opt active" id="s-m" data-size="M">M</div>
                    <div class="size-opt" id="s-g" data-size="G">G</div>
                </div>
            </div>

            <div class="card">
                <label><strong>Entrega ou Retirada?</strong></label>
                <select id="delivery-method">
                    <option value="retirada">Retirada no Balc√£o</option>
                    <option value="entrega">Entrega Delivery</option>
                </select>
                <div id="district-container" class="hidden">
                    <label style="margin-top:10px; display:block;">Selecione o Bairro:</label>
                    <select id="district-select"><option value="">Carregando bairros...</option></select>
                </div>
            </div>

            <div class="card">
                <label><strong>Pagamento</strong></label>
                <select id="payment-method">
                    <option value="dinheiro">Dinheiro (Trazer troco)</option>
                    <option value="credito">Cart√£o de Cr√©dito (+ R$ 2,00)</option>
                    <option value="debito">Cart√£o de D√©bito (+ R$ 1,00)</option>
                    <option value="pix">Pix (Aprova√ß√£o Necess√°ria)</option>
                </select>
            </div>
        </div>

        <div class="total-bar">
            <div class="price-row"><span>Total</span><span id="total-display">R$ 0,00</span></div>
            <div id="fee-display" style="font-size:0.8rem; color:#777; text-align:right;"></div>
            <button class="btn btn-primary" id="btn-confirm-order">Confirmar Pedido <i class="fas fa-arrow-right"></i></button>
        </div>
    </div>

    <div id="panel-status" class="hidden">
        <h2 style="color: var(--primary);">Status do Pedido</h2>
        
        <div class="card" id="status-card-ui" style="background: #fff8f9; border: 1px solid #ffdde1;">
            <h1 id="status-icon" style="margin: 0; font-size: 3rem;">üïí</h1>
            <h3 id="status-text" style="margin: 10px 0;">Aguardando...</h3>
            <p id="status-desc" style="font-size: 0.9rem; color: #777;">...</p>
        </div>

        <div class="status-tracker">
            <div class="status-line"><div class="status-progress" id="progress-bar"></div></div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa;">
                <span>Pedido</span><span>Preparo</span><span>Entrega</span><span>Fim</span>
            </div>
        </div>
        
        <div class="card" style="text-align: left;">
            <p><strong>Pedido:</strong> <span id="st-dish"></span></p>
            <p><strong>Total:</strong> <span id="st-total"></span></p>
            <p id="st-addr-block" class="hidden"><strong>Endere√ßo:</strong> <br><span id="st-addr"></span></p>
        </div>

        <button id="btn-client-cancel" class="btn btn-danger hidden">‚ùå Cancelar Pedido</button>
        <button id="btn-new-order" class="btn btn-primary hidden">Fazer Novo Pedido</button>
    </div>
</div>

<div id="modal-address" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Endere√ßo</h3>
        <p>Bairro: <strong id="modal-district-display"></strong></p>
        <input type="text" id="addr-street" placeholder="Rua e N√∫mero">
        <input type="text" id="addr-ref" placeholder="Ponto de Refer√™ncia">
        
        <button class="btn btn-outline" id="btn-geo">
            <i class="fas fa-map-marker-alt"></i> Usar minha localiza√ß√£o atual
        </button>
        <p id="geo-status" style="font-size:0.8rem; margin-top:5px; color:#666;"></p>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-primary" id="btn-save-addr">Continuar</button>
            <button class="btn btn-outline" id="btn-close-addr">Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-pix" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="color: var(--pix-color);">Pagamento Pix</h3>
        <p style="font-size:0.9rem;">Escaneie o QR Code e realize o pagamento.</p>
        <div class="qr-placeholder"><i class="fas fa-qrcode" style="font-size:4rem; color:#ccc;"></i></div>
        <div style="background:#f1f2f6; padding:10px; border-radius:8px; font-size:0.7rem; margin-bottom:15px; word-break:break-all;">
            00020126580014BR.GOV.BCB.PIX0136CHAVEPIX@EMAIL.COM52040000
        </div>
        <button class="btn btn-pix" id="btn-pix-copy">üìã Copiar Chave</button>
        <button class="btn btn-primary" id="btn-pix-paid">‚úÖ J√° realizei o pagamento</button>
        <button class="btn btn-outline" id="btn-cancel-pix" style="margin-top:10px; border:none;">Cancelar</button>
    </div>
</div>

<div id="modal-login" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Acesso Restrito</h3>
        <p style="font-size:0.8rem; color:#777;">Admin: 452505 | Entregador: moto123</p>
        <input type="password" id="login-pass" placeholder="Senha" style="text-align: center;">
        <button class="btn btn-primary" id="btn-do-login">Entrar</button>
        <button class="btn btn-outline" id="btn-close-login">Voltar</button>
    </div>
</div>

<div id="modal-map-admin" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:600px; width:95%;">
        <h3>Localiza√ß√£o</h3>
        <div id="admin-map-container"></div>
        <button class="btn btn-primary" id="btn-close-map" style="margin-top:15px;">Fechar</button>
    </div>
</div>

<div id="app-admin" class="hidden">
    <div class="sidebar">
        <h2>Painel Admin</h2>
        <button class="nav-btn active" data-tab="orders">üì¶ Pedidos</button>
        <button class="nav-btn" data-tab="menu">üçî Card√°pio</button>
        <button class="nav-btn" data-tab="districts">üõµ Bairros</button>
        <button class="nav-btn" data-tab="reports">üìä Relat√≥rios</button> <button class="nav-btn btn-logout" style="margin-top:auto; color:#ff6b81;">Sair</button>
    </div>
    <div class="main-content">
        
        <div id="tab-orders">
            <h3>Pedidos Ativos</h3>
            <div id="admin-orders-grid" class="admin-grid"></div>
        </div>

        <div id="tab-menu" class="hidden">
            <h3>Card√°pio</h3>
            <div class="card">
                <input type="text" id="menu-name" placeholder="Nome">
                <div style="display:flex; gap:5px;">
                    <input type="number" id="menu-p" placeholder="P">
                    <input type="number" id="menu-m" placeholder="M">
                    <input type="number" id="menu-g" placeholder="G">
                </div>
                <button class="btn btn-success" id="btn-add-menu">Adicionar Prato</button>
            </div>
            <div id="admin-menu-list"></div>
        </div>

        <div id="tab-districts" class="hidden">
            <h3>Bairros</h3>
            <div class="card">
                <input type="text" id="dist-name" placeholder="Nome Bairro">
                <input type="number" id="dist-price" placeholder="Taxa R$">
                <button class="btn btn-primary" id="btn-add-dist">Adicionar Bairro</button>
            </div>
            <div id="admin-districts-list"></div>
        </div>

        <div id="tab-reports" class="hidden">
            <h3>Relat√≥rio de Vendas</h3>
            <div class="card">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex:1;">
                        <label>Data Inicial</label>
                        <input type="date" id="rep-start" style="margin:0;">
                    </div>
                    <div style="flex:1;">
                        <label>Data Final</label>
                        <input type="date" id="rep-end" style="margin:0;">
                    </div>
                    <button class="btn btn-primary" style="width:auto; margin:0;" id="btn-filter-rep">Filtrar</button>
                    <button class="btn btn-success" style="width:auto; margin:0;" id="btn-export-rep">Baixar Excel</button>
                </div>
            </div>
            
            <div class="card" style="padding:0;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Cliente</th>
                            <th>Prato</th>
                            <th>Valor</th>
                            <th>Pagamento</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="report-body">
                        <tr><td colspan="6" style="text-align:center;">Selecione as datas e clique em Filtrar</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="app-driver" class="hidden">
    <div class="sidebar" style="background: #2f3542;">
        <h2>Entregas üõµ</h2>
        <p style="color:#a4b0be; font-size:0.9rem;">Painel do Motoboy</p>
        <button class="nav-btn btn-logout" style="margin-top:auto; color:#ff6b81;">Sair</button>
    </div>
    <div class="main-content">
        <h3>Pedidos Prontos para Entrega</h3>
        <div id="driver-orders-grid" class="admin-grid"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, query, orderBy, deleteDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB9NyBVa1Ha_42kwos09SV5VTN7NQWqHjM",
      authDomain: "tempero-da-casa-a2217.firebaseapp.com",
      projectId: "tempero-da-casa-a2217",
      storageBucket: "tempero-da-casa-a2217.firebasestorage.app",
      messagingSenderId: "92967322711",
      appId: "1:92967322711:web:88d151d9345f9191a8cf12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentSize = 'M';
    let tempGeo = null;
    let tempAddress = null;
    let localMenu = [];
    let localDistricts = [];
    let map = null;
    let reportDataCache = []; // Para armazenar dados do relatorio

    const getEl = (id) => document.getElementById(id);
    const hide = (id) => getEl(id).classList.add('hidden');
    const show = (id) => getEl(id).classList.remove('hidden');

    async function init() {
        onSnapshot(collection(db, "menu"), (snap) => {
            localMenu = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderClientMenu();
            if(!getEl('app-admin').classList.contains('hidden')) renderAdminMenu();
        });

        onSnapshot(collection(db, "districts"), (snap) => {
            localDistricts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderClientDistricts();
            if(!getEl('app-admin').classList.contains('hidden')) renderAdminDistricts();
        });

        const activeOrderId = localStorage.getItem('activeOrderId');
        if(activeOrderId) trackOrder(activeOrderId);
    }
    init();

    // --- CLIENTE --- (Mantido igual)
    function renderClientMenu() {
        const sel = getEl('dish-select');
        sel.innerHTML = '<option value="">Selecione o prato...</option>';
        localMenu.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.innerText = item.name;
            sel.appendChild(opt);
        });
    }

    function renderClientDistricts() {
        const sel = getEl('district-select');
        sel.innerHTML = '<option value="">Selecione o bairro...</option>';
        localDistricts.forEach((d, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.innerText = `${d.name} (+ R$ ${d.price})`;
            sel.appendChild(opt);
        });
    }

    getEl('dish-select').onchange = calcTotal;
    getEl('delivery-method').onchange = () => {
        const method = getEl('delivery-method').value;
        method === 'entrega' ? show('district-container') : hide('district-container');
        calcTotal();
    };
    getEl('payment-method').onchange = calcTotal;
    getEl('district-select').onchange = calcTotal;

    document.querySelectorAll('.size-opt').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.size-opt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentSize = btn.dataset.size;
            calcTotal();
        }
    });

    function calcTotal() {
        const dishId = getEl('dish-select').value;
        const method = getEl('delivery-method').value;
        const pay = getEl('payment-method').value;
        let total = 0;
        let fees = [];

        if(dishId) {
            const prato = localMenu.find(m => m.id === dishId);
            if(prato) total += parseFloat(prato[currentSize.toLowerCase()] || 0);
        }

        if(method === 'entrega') {
            const idx = getEl('district-select').value;
            if(idx !== "") total += parseFloat(localDistricts[idx].price);
        }

        if(pay === 'credito') { total += 2; fees.push("+ R$ 2 Cr√©dito"); }
        if(pay === 'debito') { total += 1; fees.push("+ R$ 1 D√©bito"); }

        getEl('total-display').innerText = `R$ ${total.toFixed(2)}`;
        getEl('fee-display').innerText = fees.join(' ');
        return total;
    }

    getEl('btn-confirm-order').onclick = () => {
        const name = getEl('client-name').value;
        const dishId = getEl('dish-select').value;
        const method = getEl('delivery-method').value;

        if(!name || !dishId) return alert("Preencha nome e prato");
        
        if(method === 'entrega') {
            const idx = getEl('district-select').value;
            if(idx === "") return alert("Escolha o bairro");
            getEl('modal-district-display').innerText = localDistricts[idx].name;
            show('modal-address');
            tempGeo = null;
            getEl('geo-status').innerText = "";
        } else {
            finalizePaymentLogic(null);
        }
    };

    getEl('btn-geo').onclick = () => {
        const status = getEl('geo-status');
        status.innerText = "Buscando...";
        status.style.color = "orange";
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                tempGeo = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                status.innerText = "‚úÖ Localiza√ß√£o encontrada!";
                status.style.color = "green";
            }, (err) => {
                status.innerText = "‚ùå Erro ao buscar. Digite manualmente.";
                status.style.color = "red";
            }, { enableHighAccuracy: true });
        } else { status.innerText = "‚ùå GPS n√£o suportado."; }
    };

    getEl('btn-close-addr').onclick = () => hide('modal-address');
    getEl('btn-save-addr').onclick = () => {
        const street = getEl('addr-street').value;
        const ref = getEl('addr-ref').value;
        const idx = getEl('district-select').value;
        if(!street) return alert("Digite rua e n√∫mero");
        tempAddress = { street, ref, geo: tempGeo, district: localDistricts[idx].name };
        hide('modal-address');
        finalizePaymentLogic(tempAddress);
    };

    function finalizePaymentLogic(addr) {
        if(getEl('payment-method').value === 'pix') show('modal-pix');
        else createOrder(addr, 'pending');
    }

    getEl('btn-pix-copy').onclick = () => { navigator.clipboard.writeText("00020126580014BR.GOV.BCB.PIX0136CHAVEPIX@EMAIL.COM52040000"); alert("Chave Copiada!"); };
    getEl('btn-pix-paid').onclick = () => { hide('modal-pix'); createOrder(tempAddress, 'awaiting_payment'); };
    getEl('btn-cancel-pix').onclick = () => hide('modal-pix');

    async function createOrder(addr, initialStatus) {
        const dishId = getEl('dish-select').value;
        const prato = localMenu.find(m => m.id === dishId);
        
        const orderData = {
            client: getEl('client-name').value,
            dish: prato.name,
            size: currentSize,
            total: calcTotal(),
            method: getEl('delivery-method').value,
            payment: getEl('payment-method').value,
            address: addr,
            status: initialStatus,
            timestamp: new Date().toISOString()
        };

        try {
            const docRef = await addDoc(collection(db, "orders"), orderData);
            localStorage.setItem('activeOrderId', docRef.id);
            trackOrder(docRef.id);
        } catch (e) { alert("Erro: " + e.message); }
    }

    function trackOrder(id) {
        hide('view-order');
        show('panel-status');
        
        onSnapshot(doc(db, "orders", id), (doc) => {
            if(!doc.exists()) { localStorage.removeItem('activeOrderId'); location.reload(); return; }
            const data = doc.data();
            
            getEl('st-dish').innerText = `${data.dish} (${data.size})`;
            getEl('st-total').innerText = `R$ ${data.total.toFixed(2)}`;
            if(data.address) { show('st-addr-block'); getEl('st-addr').innerText = `${data.address.street} - ${data.address.district}`; }

            const bar = getEl('progress-bar');
            const icon = getEl('status-icon');
            const txt = getEl('status-text');
            const desc = getEl('status-desc');
            const cardUI = getEl('status-card-ui');
            const btnCancel = getEl('btn-client-cancel');

            cardUI.className = 'card';
            cardUI.style.background = "#fff8f9";

            if(data.status === 'awaiting_payment' || data.status === 'pending') show('btn-client-cancel');
            else hide('btn-client-cancel');

            if(data.status === 'awaiting_payment') {
                bar.style.width = '5%'; bar.style.background = '#ffd32a';
                icon.innerText = '‚ö†Ô∏è'; txt.innerText = 'AGUARDANDO PIX';
                desc.innerText = 'Restaurante conferindo pagamento...';
                cardUI.classList.add('pix-alert-card');
            } else if(data.status === 'pending') {
                bar.style.width = '10%'; bar.style.background = '#ffa502';
                icon.innerText = '‚è≥'; txt.innerText = 'Na Cozinha'; desc.innerText = 'Pedido na fila.';
            } else if(data.status === 'prep') {
                bar.style.width = '40%'; bar.style.background = '#ffa502';
                icon.innerText = 'üî•'; txt.innerText = 'Em Preparo'; desc.innerText = 'Cozinhando...';
            } else if(data.status === 'delivery') {
                bar.style.width = '80%'; bar.style.background = '#2ed573';
                icon.innerText = 'üõµ'; txt.innerText = 'Saiu p/ Entrega'; desc.innerText = 'Entregador a caminho.';
            } else if(data.status === 'done') {
                bar.style.width = '100%'; bar.style.background = '#2ed573';
                icon.innerText = '‚úÖ'; txt.innerText = 'Entregue!'; desc.innerText = 'Obrigado!'; show('btn-new-order');
            } else if(data.status === 'cancelled') {
                bar.style.width = '0%'; bar.style.background = 'red';
                icon.innerText = '‚ùå'; txt.innerText = 'Cancelado'; desc.innerText = 'Pedido cancelado.'; show('btn-new-order');
            }

            btnCancel.onclick = async () => { if(confirm("Cancelar pedido?")) await updateDoc(doc(db, "orders", id), { status: 'cancelled' }); };
        });
    }
    getEl('btn-new-order').onclick = () => { localStorage.removeItem('activeOrderId'); location.reload(); }

    // --- LOGIN ---
    getEl('btn-login-access').onclick = () => show('modal-login');
    getEl('btn-close-login').onclick = () => hide('modal-login');
    getEl('btn-do-login').onclick = () => {
        const pass = getEl('login-pass').value;
        hide('modal-login'); hide('app-client');
        if(pass === '452505') { show('app-admin'); getEl('app-admin').style.display = 'flex'; setupAdminListeners(); }
        else if(pass === 'moto123') { show('app-driver'); getEl('app-driver').style.display = 'flex'; setupDriverListeners(); }
        else { alert('Senha errada'); location.reload(); }
    };
    document.querySelectorAll('.btn-logout').forEach(b => b.onclick = () => location.reload());

    // --- ADMIN ---
    document.querySelectorAll('.nav-btn[data-tab]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            ['orders','menu','districts','reports'].forEach(t => hide('tab-'+t)); // Esconde todos
            show('tab-' + btn.dataset.tab);
        };
    });

    function setupAdminListeners() {
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const grid = getEl('admin-orders-grid');
            grid.innerHTML = '';
            snap.forEach(docSnap => {
                const o = docSnap.data();
                const oid = docSnap.id;
                if(o.status === 'done' || o.status === 'cancelled') return;

                const div = document.createElement('div');
                div.className = 'card';
                if(o.status === 'awaiting_payment') div.classList.add('card-pix-pending');

                let mapBtn = '';
                if(o.address && o.address.geo) mapBtn = `<button class="btn btn-outline" style="font-size:0.8rem; margin-top:5px;" id="map-${oid}">üó∫Ô∏è Ver Mapa</button>`;

                let actionButtons = '';
                if (o.status === 'awaiting_payment') {
                    actionButtons = `<p style="color:#e84118; font-weight:bold;">‚ö†Ô∏è PIX PENDENTE</p><button class="btn btn-pix" onclick="window.upStatus('${oid}','pending')">üí∞ Confirmar Pix</button><button class="btn btn-outline" style="color:red;" onclick="window.upStatus('${oid}','cancelled')">‚ùå Recusar</button>`;
                } else {
                    actionButtons = `<div style="display:flex; gap:5px; margin-top:10px;"><button class="btn btn-outline" onclick="window.upStatus('${oid}','prep')">üî• Preparar</button><button class="btn btn-outline" style="color:red;" onclick="window.upStatus('${oid}','cancelled')">‚ùå Cancelar</button></div>`;
                }

                div.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>${o.client}</strong><span style="font-weight:bold; color:var(--primary)">${o.status.toUpperCase()}</span></div><p>${o.dish} (${o.size})</p><p>R$ ${o.total.toFixed(2)} - <strong>${o.payment}</strong></p>${o.method === 'entrega' ? `<div style="background:#f1f2f6; p:5px; border-radius:5px; font-size:0.9rem;">üìç ${o.address.street} <br> ${o.address.district} ${mapBtn}</div>` : 'Retirada'}${actionButtons}`;
                grid.appendChild(div);
                if(o.address && o.address.geo) setTimeout(() => { getEl(`map-${oid}`).onclick = () => openMap(o.address.geo, o.client); }, 100);
            });
        });
        renderAdminMenu(); renderAdminDistricts();
    }

    // --- REPORT LOGIC (NOVO) ---
    getEl('btn-filter-rep').onclick = async () => {
        const start = getEl('rep-start').value;
        const end = getEl('rep-end').value;
        if(!start || !end) return alert("Selecione datas");

        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        
        reportDataCache = []; // Limpa cache
        const tbody = getEl('report-body');
        tbody.innerHTML = '';

        snap.forEach(doc => {
            const o = doc.data();
            const dateOnly = o.timestamp.split('T')[0];
            
            if(dateOnly >= start && dateOnly <= end) {
                reportDataCache.push(o); // Salva para exportar
                
                const dateFmt = new Date(o.timestamp).toLocaleString('pt-BR');
                tbody.innerHTML += `
                    <tr>
                        <td>${dateFmt}</td>
                        <td>${o.client}</td>
                        <td>${o.dish}</td>
                        <td>R$ ${o.total.toFixed(2)}</td>
                        <td>${o.payment}</td>
                        <td>${o.status}</td>
                    </tr>
                `;
            }
        });

        if(reportDataCache.length === 0) tbody.innerHTML = '<tr><td colspan="6">Nenhum pedido neste per√≠odo.</td></tr>';
    };

    getEl('btn-export-rep').onclick = () => {
        if(reportDataCache.length === 0) return alert("Filtre primeiro para ter dados.");
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Data;Cliente;Prato;Tamanho;Total;Pagamento;Status;Endereco\n"; // Header

        reportDataCache.forEach(o => {
            const date = new Date(o.timestamp).toLocaleString('pt-BR');
            const addr = o.address ? `${o.address.street} - ${o.address.district}` : "Retirada";
            // Substituir ; por , para n√£o quebrar CSV
            const row = `${date};${o.client};${o.dish};${o.size};${o.total.toFixed(2)};${o.payment};${o.status};${addr}`;
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "relatorio_vendas.csv");
        document.body.appendChild(link);
        link.click();
    };


    // --- ENTREGADOR (NOVO VISUAL DE PAGAMENTO) ---
    function setupDriverListeners() {
        const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const grid = getEl('driver-orders-grid');
            grid.innerHTML = '';
            snap.forEach(docSnap => {
                const o = docSnap.data();
                const oid = docSnap.id;
                if(o.status !== 'prep' && o.status !== 'delivery') return;
                if(o.method !== 'entrega') return;

                const div = document.createElement('div');
                div.className = 'card';
                div.style.borderLeft = "5px solid #2f3542";

                let mapBtn = '';
                if(o.address && o.address.geo) mapBtn = `<button class="btn btn-outline" style="font-size:0.8rem; margin-top:5px;" id="dmap-${oid}">üó∫Ô∏è Ver Mapa</button>`;

                // LOGICA DE EXIBI√á√ÉO DE PAGAMENTO PARA O MOTOBOY
                let payDisplay = '';
                if(o.payment === 'pix') {
                    // Se chegou aqui, o admin ja confirmou o pix
                    payDisplay = `<div style="background:#d1fae5; color:#065f46; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin:10px 0; border:1px solid #34d399;">‚úÖ PIX J√Å PAGO</div>`;
                } else {
                    // Dinheiro ou Cart√£o
                    payDisplay = `<div style="background:#fee2e2; color:#b91c1c; padding:10px; border-radius:8px; text-align:center; font-weight:bold; margin:10px 0; border:1px solid #fca5a5;">üí∞ COBRAR: ${o.payment.toUpperCase()}<br>Valor: R$ ${o.total.toFixed(2)}</div>`;
                }

                let driverAction = '';
                if(o.status === 'prep') driverAction = `<button class="btn btn-driver" onclick="window.upStatus('${oid}','delivery')">üõµ Pegar Pedido (Sair)</button>`;
                else if(o.status === 'delivery') driverAction = `<button class="btn btn-success" onclick="window.upStatus('${oid}','done')">‚úÖ Pedido Entregue</button>`;

                div.innerHTML = `<h3>${o.client}</h3><p style="font-size:1.1rem; font-weight:bold;">${o.status.toUpperCase()}</p><div style="background:#f1f2f6; padding:10px; margin:10px 0; border-radius:8px;">üìç ${o.address.street}<br>Ref: ${o.address.ref}<br><strong>${o.address.district}</strong>${mapBtn}</div>${payDisplay}${driverAction}`;
                grid.appendChild(div);
                if(o.address && o.address.geo) setTimeout(() => { getEl(`dmap-${oid}`).onclick = () => openMap(o.address.geo, o.client); }, 100);
            });
        });
    }

    // Globais
    window.upStatus = async (id, status) => { await updateDoc(doc(db, "orders", id), { status: status }); };
    function openMap(geo, name) { show('modal-map-admin'); if(map) map.remove(); setTimeout(() => { map = L.map('admin-map-container').setView([geo.lat, geo.lng], 16); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); L.marker([geo.lat, geo.lng]).addTo(map).bindPopup(name).openPopup(); }, 200); }
    getEl('btn-close-map').onclick = () => hide('modal-map-admin');

    // CRUD Admin
    function renderAdminMenu() {
        const list = getEl('admin-menu-list'); list.innerHTML = '';
        localMenu.forEach(m => { list.innerHTML += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;"><b>${m.name}</b> <small>P:${m.p} M:${m.m} G:${m.g}</small><button style="color:red; border:none; bg:none;" onclick="window.delItem('menu','${m.id}')">X</button></div>`; });
    }
    function renderAdminDistricts() {
        const list = getEl('admin-districts-list'); list.innerHTML = '';
        localDistricts.forEach(d => { list.innerHTML += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;"><b>${d.name}</b> <span>R$ ${d.price}</span><button style="color:red; border:none; bg:none;" onclick="window.delItem('districts','${d.id}')">X</button></div>`; });
    }
    getEl('btn-add-menu').onclick = async () => { const name = getEl('menu-name').value; if(!name) return; await addDoc(collection(db, "menu"), { name: name, p: getEl('menu-p').value, m: getEl('menu-m').value, g: getEl('menu-g').value }); getEl('menu-name').value = ''; };
    getEl('btn-add-dist').onclick = async () => { const name = getEl('dist-name').value; if(!name) return; await addDoc(collection(db, "districts"), { name: name, price: getEl('dist-price').value }); getEl('dist-name').value = ''; };
    window.delItem = async (col, id) => { if(confirm('Excluir?')) await deleteDoc(doc(db, col, id)); };

</script>
</body>
</html>
