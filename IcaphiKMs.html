<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IcaphiKms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #3b82f6; --accent: #06b6d4; 
            --glass-bg: rgba(15, 23, 42, 0.75); 
            --glass-border: rgba(255, 255, 255, 0.08); 
            --pc-cols: 4;
        }
        
        /* Fundo Otimizado: Gradientes est√°ticos ao inv√©s de anima√ß√µes complexas em full-screen */
        body { 
            background-color: #020617;
            background-image: 
                radial-gradient(circle at top right, rgba(6, 182, 212, 0.15), transparent 40%),
                radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.15), transparent 40%);
            background-attachment: fixed;
            margin: 0; color: #f8fafc; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        /* Anima√ß√£o simplificada (GPU Friendly) */
        body::after {
            content: ""; position: fixed; inset: 0; z-index: -1;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJub25lIiAvPjwvc3ZnPg=='); /* Placeholder leve */
            background: radial-gradient(circle at 50% 50%, rgba(30, 58, 138, 0.1), transparent 60%);
            animation: pulse-bg 8s ease-in-out infinite alternate;
            pointer-events: none;
            will-change: opacity, transform;
        }
        @keyframes pulse-bg { 0% {opacity: 0.5; transform: scale(1);} 100% {opacity: 0.8; transform: scale(1.1);} }

        /* Vidro Otimizado: Menos blur para evitar lag */
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); 
        }
        
        /* Otimiza√ß√£o de Performance de Anima√ß√£o */
        .modal-container { 
            position: relative; width: 95%; max-width: 420px; background: rgba(15, 23, 42, 0.98); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; 
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6); margin: auto; overflow: hidden; 
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            will-change: transform, opacity;
        }

        @keyframes slideUpFade { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .input-style { background: rgba(30, 41, 59, 0.6) !important; border: 1px solid rgba(255, 255, 255, 0.05) !important; color: #fff !important; width: 100%; padding: 16px; border-radius: 16px; outline: none; font-size: 15px; transition: border-color 0.2s; }
        .input-style:focus { border-color: var(--primary) !important; background: rgba(30, 41, 59, 0.9) !important; }

        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%); border-radius: 16px; font-weight: 800; color: white; padding: 18px; text-transform: uppercase; width: 100%; letter-spacing: 1.2px; border: none; transition: transform 0.1s; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3); }
        .btn-primary:active { transform: scale(0.98); }

        .admin-card { 
            background: rgba(30, 41, 59, 0.4); 
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.05); 
            padding: 20px; margin-bottom: 16px; position: relative; overflow: hidden; 
            animation: slideUpFade 0.4s ease-out backwards;
            content-visibility: auto; /* Otimiza√ß√£o de renderiza√ß√£o navegador */
        }
        .admin-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, #10b981, #34d399); }
        .admin-card.em-curso::before { background: linear-gradient(to bottom, #f59e0b, #fbbf24); }

        #main-loader { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; pointer-events: none; }
        .loader-ring { width: 40px; height: 40px; border: 3px solid rgba(59, 130, 246, 0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s infinite linear; will-change: transform; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .viewer-overlay { position: fixed; inset: 0; z-index: 5000; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .viewer-overlay.active { opacity: 1; pointer-events: all; }
        .viewer-content { width: 95%; max-width: 800px; height: auto; max-height: 85vh; background: #0f172a; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }

        .file-box { border: 2px dashed rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); transition: all 0.2s; }
        .file-box.attached { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
        .filter-btn { padding: 8px 14px; border-radius: 12px; font-size: 10px; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); color: #64748b; background: rgba(15, 23, 42, 0.4); }
        .filter-btn.active { background: #1d4ed8; color: white; border-color: #3b82f6; }

        details > summary { list-style: none; cursor: pointer; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 8px; font-weight: bold; text-transform: uppercase; font-size: 11px; color: #94a3b8; }
        details > div { padding: 15px; background: rgba(0,0,0,0.2); font-size: 12px; color: #cbd5e1; line-height: 1.6; }

        .time-badge { background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; color: #cbd5e1; display: flex; items-center; gap: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .hidden { display: none !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .pulsing { animation: pulse-red 2s infinite; color: #fbbf24 !important; border-color: #fbbf24 !important; background: rgba(251, 191, 36, 0.1) !important; }
        .w-full-pc { max-width: 100% !important; padding: 30px; }
        .grid-pc { display: grid; grid-template-columns: repeat(var(--pc-cols), 1fr); gap: 15px; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: transparent; } ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="p-3 selection:bg-blue-500 selection:text-white">
    
    <div id="main-loader">
        <div class="loader-ring"></div>
        <p class="mt-4 text-[10px] font-black text-blue-500 uppercase tracking-[3px]">Carregando...</p>
    </div>

    <div id="popup-foto" class="viewer-overlay" onclick="fecharPopup('popup-foto')">
        <div class="viewer-content" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-white/10 flex justify-between items-center bg-slate-900">
                <span class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2"><i data-lucide="image" class="w-4 h-4 text-blue-400"></i> Foto</span>
                <button onclick="fecharPopup('popup-foto')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="bg-black flex-1 flex items-center justify-center p-2"><img id="img-viewer" class="max-w-full max-h-[70vh] rounded-lg object-contain"></div>
        </div>
    </div>

    <div id="popup-gps" class="viewer-overlay" onclick="fecharPopup('popup-gps')">
        <div class="viewer-content !h-[80vh]" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-white/10 flex justify-between items-center bg-slate-900">
                <span class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2"><i data-lucide="map-pin" class="w-4 h-4 text-red-500"></i> Localiza√ß√£o</span>
                <button onclick="fecharPopup('popup-gps')" class="text-slate-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <iframe id="iframe-gps" class="w-full h-full border-none bg-slate-800"></iframe>
        </div>
    </div>

    <div id="app-wrap" class="max-w-[420px] mx-auto relative z-10 transition-all duration-300 ease-out">
        
        <header class="flex justify-between items-center py-4 mb-2">
            <div>
                <h1 class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 uppercase tracking-tighter drop-shadow-sm">ICAPHI KMS</h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em] mt-0.5 ml-1">By: Matheus Julio</p>
            </div>
            <div class="flex gap-2">
                <button onclick="alternarModoPC()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors" title="Modo PC"><i data-lucide="monitor" class="w-4 h-4"></i></button>
                <button id="btn-sino" onclick="abrirModalNotif()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors relative">
                    <i data-lucide="bell" class="w-4 h-4"></i>
                    <span id="notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-amber-500 rounded-full"></span>
                </button>
                <button onclick="acessoAdmin()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors"><i data-lucide="shield-check" class="w-4 h-4"></i></button>
            </div>
        </header>

        <main id="tela-inicio" class="space-y-5">
            <div class="modal-container">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-black uppercase flex items-center gap-2 text-white"><i data-lucide="zap" class="text-cyan-400 fill-cyan-400/20"></i> Nova Rota</h2>
                    <button onclick="document.getElementById('modal-extrato-login').classList.remove('hidden')" class="px-3 py-1.5 rounded-full text-[9px] font-bold uppercase text-cyan-400 border border-cyan-500/30 bg-cyan-950/30 hover:bg-cyan-900/50 transition-all">Hist√≥rico</button>
                </div>
                <div class="space-y-3">
                    <div class="relative">
                        <select id="tipo-servico" class="input-style appearance-none font-bold text-slate-300">
                            <option>Saida Dia</option><option>Apoio</option><option>Segunda Viagem</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-5 text-slate-500 pointer-events-none w-5 h-5"></i>
                    </div>
                    <input type="text" id="motorista" placeholder="Nome do Condutor" class="input-style placeholder-slate-500">
                    <input type="text" id="placa" placeholder="Placa do Ve√≠culo" class="input-style placeholder-slate-500">
                    <input type="number" id="km-inicio" placeholder="KM Painel" class="input-style placeholder-slate-500 font-mono">
                    <label id="lbl-foto-inicio" class="file-box flex flex-col items-center justify-center w-full h-24 rounded-2xl cursor-pointer group">
                        <div class="p-2 bg-slate-800/50 rounded-full mb-1 group-hover:bg-cyan-500 group-hover:text-white transition-colors text-slate-400 border border-white/5"><i data-lucide="camera" class="w-5 h-5"></i></div>
                        <span id="txt-foto" class="text-[9px] font-bold text-slate-400 uppercase group-hover:text-white transition-colors">Foto Painel</span>
                        <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto', 'lbl-foto-inicio')">
                    </label>
                    <button onclick="iniciarViagem()" class="btn-primary mt-1 flex items-center justify-center gap-2">Iniciar Rota <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                </div>
            </div>
            <button onclick="document.getElementById('modal-tutorial').classList.remove('hidden')" class="w-full text-center text-[10px] font-bold text-slate-600 uppercase tracking-[2px] hover:text-slate-400 transition-colors flex items-center justify-center gap-2 pb-4">
                <i data-lucide="help-circle" class="w-3 h-3"></i> Como usar?
            </button>
        </main>

        <main id="tela-em-curso" class="hidden space-y-5">
            <div class="modal-container text-center border-amber-500/20 shadow-none">
                <div class="inline-flex items-center gap-2 mb-6 bg-amber-500/10 py-1.5 px-4 rounded-full border border-amber-500/20">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                    <p id="info-viagem-ativa" class="text-amber-500 font-black text-[10px] uppercase tracking-widest"></p>
                </div>
                <div class="py-8 bg-black/30 rounded-[24px] mb-6 border border-white/5 relative overflow-hidden">
                    <div id="cronometro-motorista" class="relative text-5xl font-black tracking-tighter text-white font-mono">00:00:00</div>
                    <p class="relative text-[9px] text-slate-500 font-bold uppercase mt-2 tracking-widest">Tempo Decorrido</p>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="document.getElementById('modal-complementos').classList.remove('hidden')" class="p-3 bg-slate-800/40 hover:bg-slate-700/60 rounded-xl font-bold text-[9px] uppercase border border-white/10 text-slate-300 transition-all flex flex-col items-center gap-2"><i data-lucide="plus-circle" class="w-5 h-5 text-blue-400"></i> Adicionar Ocorr√™ncia</button>
                    <button onclick="location.reload()" class="p-3 bg-slate-800/40 hover:bg-slate-700/60 rounded-xl font-bold text-[9px] uppercase border border-white/10 text-slate-300 transition-all flex flex-col items-center gap-2"><i data-lucide="refresh-cw" class="w-5 h-5 text-emerald-400"></i> Atualizar Dados</button>
                </div>
                <div class="bg-slate-900/30 p-4 rounded-[20px] border border-white/5">
                    <input type="number" id="km-fim" placeholder="KM Final" class="input-style text-center mb-4 text-xl font-bold font-mono !border-slate-700/50">
                    <label id="lbl-foto-fim" class="file-box flex flex-col items-center justify-center w-full h-20 rounded-xl mb-4 cursor-pointer">
                        <div class="flex items-center gap-2 text-slate-400"><i data-lucide="camera" class="w-4 h-4"></i><span id="txt-foto-fim" class="text-[9px] font-bold uppercase">Foto Chegada</span></div>
                        <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto-fim', 'lbl-foto-fim')">
                    </label>
                    <button onclick="encerrarViagem()" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 p-4 rounded-xl font-black uppercase text-white shadow-lg transition-all text-sm tracking-wider flex items-center justify-center gap-2"><i data-lucide="stop-circle" class="w-5 h-5"></i> Finalizar</button>
                </div>
            </div>
        </main>

        <main id="tela-admin" class="hidden pb-32">
            <div class="sticky top-0 bg-slate-900/80 backdrop-blur-md border-b border-white/10 py-3 z-40 px-2 -mx-2 mb-4 shadow-xl">
                <div class="flex justify-between items-center mb-3">
                    <button onclick="mudarTela('inicio')" class="px-3 py-2 bg-slate-800/50 border border-white/10 rounded-xl text-slate-300 text-[10px] font-bold uppercase hover:bg-white/10 transition-all flex items-center gap-2"><i data-lucide="arrow-left" class="w-3 h-3"></i> Voltar</button>
                    
                    <div class="flex gap-2 items-center">
                        <div id="grid-controls" class="hidden mr-2 bg-slate-800/50 rounded-lg p-1 border border-white/10">
                            <span class="text-[9px] uppercase font-bold text-slate-500 px-2">Grade:</span>
                            <select onchange="mudarGrade(this.value)" class="bg-transparent text-xs text-white font-bold outline-none cursor-pointer">
                                <option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option>
                            </select>
                        </div>
                        <button onclick="abrirModalGerarCodigo()" class="w-9 h-9 flex items-center justify-center text-cyan-400 bg-cyan-500/10 rounded-lg border border-cyan-500/20 hover:bg-cyan-500/20 transition-all" title="Gerar Senha"><i data-lucide="key" class="w-4 h-4"></i></button>
                        <button onclick="abrirModalNotifAdmin()" class="w-9 h-9 flex items-center justify-center text-amber-500 bg-amber-500/10 rounded-lg border border-amber-500/20 hover:bg-amber-500/20 transition-all" title="Avisos"><i data-lucide="megaphone" class="w-4 h-4"></i></button>
                        <button onclick="document.getElementById('modal-export').classList.remove('hidden')" class="w-9 h-9 flex items-center justify-center text-emerald-500 bg-emerald-500/10 rounded-lg border border-emerald-500/20 hover:bg-emerald-500/20 transition-all" title="Excel"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="flex gap-2 mb-3 overflow-x-auto pb-1 scrollbar-hide">
                    <button onclick="filtrarStatus('todos')" id="filt-todos" class="filter-btn active">Todos</button>
                    <button onclick="filtrarStatus('em_curso')" id="filt-em_curso" class="filter-btn">Em Rota</button>
                    <button onclick="filtrarStatus('finalizada')" id="filt-finalizada" class="filter-btn">Finalizados</button>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-3.5 text-slate-500 w-4 h-4"></i>
                    <input type="text" id="busca-admin" oninput="renderizarAdmin()" placeholder="Buscar motorista, placa..." class="input-style !pl-10 !py-2.5 !text-sm !rounded-xl !bg-slate-900/50">
                </div>
            </div>
            <div id="lista-viagens" class="space-y-4 px-1"></div>
        </main>

        <div id="modal-tutorial" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]">
            <div class="modal-container !max-w-md h-[80vh] flex flex-col p-0 bg-[#0f172a]">
                <div class="p-4 border-b border-white/10 bg-slate-900 flex justify-between items-center"><h3 class="font-black text-blue-400 uppercase text-sm">Central de Ajuda</h3><button onclick="fecharModal('modal-tutorial')"><i data-lucide="x" class="text-slate-400"></i></button></div>
                <div class="p-4 overflow-y-auto space-y-2">
                    <details><summary>1. Iniciar e Finalizar Viagem</summary><div>Preencha <b>Tipo de Servi√ßo</b>, <b>Nome</b>, <b>Placa</b> e <b>KM Inicial</b>.<br>√â <b>obrigat√≥rio</b> tirar a foto do painel. Clique em "Iniciar Rota".<br>Ao chegar, insira o <b>KM Final</b>, tire a foto de chegada e clique em "Finalizar".<br>Na tela de sucesso, clique no bot√£o verde do <b>WhatsApp</b> para enviar o relat√≥rio completo.</div></details>
                    <details><summary>2. Visualizar Extrato (Hist√≥rico)</summary><div>Na tela inicial, clique no bot√£o "Hist√≥rico".<br>Insira a Placa do ve√≠culo e o <b>C√≥digo de 4 d√≠gitos</b> (fornecido pelo gestor).<br>Voc√™ ver√° todas as viagens, KMs totais e poder√° ver as fotos de in√≠cio e fim.</div></details>
                    <details><summary>3. Ocorr√™ncias e Abastecimento</summary><div>Durante a viagem (tela com cron√¥metro), clique em <b>"Adicionar Ocorr√™ncia"</b>.<br>Selecione o tipo (Abastecimento, Ped√°gio, Pneu Furado) e descreva os detalhes (litros, valor, local).</div></details>
                    <details><summary>4. Outras Fun√ß√µes</summary><div><b>Sincronizar:</b> Atualiza os dados caso a internet falhe.<br><b>Sino:</b> Veja avisos importantes da administra√ß√£o.<br><b>Modo PC:</b> No √≠cone de monitor no topo, o layout se adapta para computadores.</div></details>
                </div>
            </div>
        </div>

        <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass z-[1800]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="text-emerald-400 font-bold uppercase text-sm flex items-center gap-2"><i data-lucide="database"></i> Gerenciar Dados</h3><button onclick="fecharModal('modal-export')"><i data-lucide="x" class="text-slate-400"></i></button></div><p class="text-[10px] text-slate-400 mb-2 uppercase font-bold">Selecione o Per√≠odo:</p><div class="grid grid-cols-2 gap-3 mb-6"><input type="date" id="data-exp-inicio" class="input-style !p-3 text-center !text-xs"><input type="date" id="data-exp-fim" class="input-style !p-3 text-center !text-xs"></div><button onclick="gerarExcel()" class="btn-primary !bg-none !bg-emerald-600 hover:!bg-emerald-500 mb-3 shadow-lg shadow-emerald-900/30 !py-3 !text-xs">Baixar Relat√≥rio Excel</button><button onclick="excluirPeriodoSelecionado()" class="w-full py-3 border border-red-500/30 bg-red-500/10 text-red-400 rounded-xl text-[10px] font-bold uppercase hover:bg-red-500/20 transition-colors flex items-center justify-center gap-2"><i data-lucide="trash" class="w-3 h-3"></i> Excluir per√≠odo</button></div></div>
        
        <div id="modal-sucesso-viagem" class="hidden fixed inset-0 flex items-center justify-center glass z-[5000]"><div class="modal-container text-center border-emerald-500/30"><div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="check" class="text-emerald-400 w-10 h-10"></i></div><h3 class="text-xl font-black text-white uppercase mb-2">Sucesso!</h3><p class="text-slate-400 text-xs mb-8">Viagem finalizada com seguran√ßa.</p><button id="btn-share-wpp" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold uppercase p-4 rounded-xl flex items-center justify-center gap-3 mb-3 text-xs"><i data-lucide="message-circle" class="w-5 h-5"></i> Enviar WhatsApp</button><button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold uppercase p-3 rounded-xl text-xs">Voltar</button></div></div>
        
        <div id="modal-tabela-extrato" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]">
            <div class="modal-container !max-w-4xl h-[90vh] flex flex-col p-0 overflow-hidden bg-[#0f172a]">
                <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-900">
                    <div><h3 class="text-white font-black uppercase text-xs">Extrato Completo</h3><p id="extrato-placa-titulo" class="text-[9px] text-cyan-400 font-bold uppercase mt-0.5">Carregando...</p></div>
                    <button onclick="fecharModal('modal-tabela-extrato')" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x" class="text-slate-400 w-5 h-5"></i></button>
                </div>
                <div class="flex-1 overflow-auto bg-slate-950/50">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900/90 sticky top-0 z-10 backdrop-blur-sm">
                            <tr>
                                <th class="p-3 text-[9px] uppercase text-slate-500 font-bold">Motorista/Tipo</th>
                                <th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">KM Ini</th>
                                <th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">KM Fim</th>
                                <th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">Total</th>
                                <th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-extrato" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="modal-gerar-codigo" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]"><div class="modal-container text-center"><i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-gerar-codigo')"></i><h3 class="text-cyan-400 font-black uppercase text-sm mb-6">Acesso Condutor</h3><select id="gc-placa-select" class="input-style mb-4 font-bold text-center appearance-none"></select><div id="display-codigo-gerado" class="hidden py-6 bg-black/40 rounded-2xl text-5xl font-black text-white tracking-[8px] mb-4 font-mono border border-cyan-500/20">0000</div><button onclick="processarGeracaoCodigo()" class="btn-primary mt-2">GERAR SENHA</button></div></div>
        <div id="modal-extrato-login" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container text-center"><i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-extrato-login')"></i><h3 class="text-white font-black uppercase text-sm mb-6">Login Hist√≥rico</h3><input type="text" id="login-placa-manual" placeholder="PLACA" class="input-style mb-3 text-center uppercase font-bold tracking-widest"><input type="tel" id="login-codigo" placeholder="SENHA" class="input-style mb-6 text-center tracking-[10px] font-bold text-xl" maxlength="4"><button onclick="validarAcessoExtrato()" class="btn-primary">ENTRAR</button></div></div>
        <div id="modal-gerenciar-notif" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]"><div class="modal-container"><div class="flex justify-between mb-4"><h3 class="font-bold uppercase text-amber-500 text-xs">Novo Comunicado</h3><i data-lucide="x" class="text-slate-400 cursor-pointer" onclick="fecharModal('modal-gerenciar-notif')"></i></div><textarea id="notif-texto" placeholder="Mensagem..." class="input-style h-24 mb-4 resize-none text-sm"></textarea><button onclick="salvarNotificacao()" class="btn-primary !bg-none !bg-amber-600 hover:!bg-amber-500 mb-6 text-white text-xs !py-3">PUBLICAR</button><div id="lista-notif-admin" class="max-h-40 overflow-auto space-y-2 pr-2"></div></div></div>
        <div id="modal-notificacoes" class="hidden fixed inset-0 flex items-center justify-center glass z-[3500]"><div class="modal-container h-[60vh] flex flex-col"><div class="flex justify-between mb-6"><h3 class="font-black text-amber-500 uppercase text-sm">Mural</h3><i data-lucide="x" class="text-slate-400 cursor-pointer" onclick="fecharModal('modal-notificacoes')"></i></div><div id="lista-notificacoes-motorista" class="space-y-3 overflow-y-auto pr-2"></div></div></div>
        <div id="modal-ver-obs" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container h-[60vh] flex flex-col"><div class="flex justify-between mb-4"><h3 class="font-bold text-blue-500 uppercase text-sm">Ocorr√™ncias</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-ver-obs')"></i></div><div id="conteudo-obs-admin" class="space-y-3 overflow-auto"></div></div></div>
        <div id="modal-complementos" class="hidden fixed inset-0 flex items-center justify-center glass z-[1500]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="font-bold uppercase text-sm text-white">Novo Evento</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-complementos')"></i></div><select id="comp-tipo" class="input-style mb-4 appearance-none text-sm"><option>Observa√ß√£o</option><option>Abastecimento</option><option>Ped√°gio</option><option>Pneu Furado</option><option>Parada Policial</option></select><textarea id="comp-obs" placeholder="Detalhes..." class="input-style h-24 mb-6 text-sm"></textarea><button onclick="salvarObservacaoMotorista()" class="btn-primary !py-3 text-xs">SALVAR</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc, updateDoc, Timestamp, arrayUnion, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U", authDomain: "marcador-ponto-digital.firebaseapp.com", projectId: "marcador-ponto-digital", storageBucket: "marcador-ponto-digital.firebasestorage.app", messagingSenderId: "774324665760", appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let listaGlobalViagens = [], listaNotificacoes = [], filtroAdminAtual = 'todos', isFirstLoadNotif = true;

        window.fecharModal = (id) => document.getElementById(id).classList.add('hidden');
        window.mudarTela = (t) => { document.querySelectorAll('main').forEach(m => m.classList.add('hidden')); document.getElementById('tela-' + t).classList.remove('hidden'); lucide.createIcons(); };
        window.fotoTirada = (idTxt, idContainer) => { document.getElementById(idTxt).innerText = 'OK, ANEXADO'; document.getElementById(idContainer).classList.add('attached'); };
        const showLoader = () => { document.getElementById('main-loader').style.display = 'flex'; setTimeout(() => document.getElementById('main-loader').style.opacity = '1', 10); };
        const hideLoader = () => { const l = document.getElementById('main-loader'); l.style.opacity = '0'; setTimeout(() => l.style.display = 'none', 500); };
        window.alternarModoPC = () => { const w = document.getElementById('app-wrap'), l = document.getElementById('lista-viagens'), c = document.getElementById('grid-controls'); w.classList.toggle('max-w-[420px]'); w.classList.toggle('w-full-pc'); w.classList.toggle('!max-w-full'); l.classList.toggle('grid-pc'); l.classList.toggle('space-y-4'); if(w.classList.contains('w-full-pc')) c.classList.remove('hidden'); else c.classList.add('hidden'); };
        window.mudarGrade = (n) => { document.documentElement.style.setProperty('--pc-cols', n); };
        window.filtrarStatus = (s) => { filtroAdminAtual = s; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); document.getElementById('filt-' + s).classList.add('active'); renderizarAdmin(); };
        window.fecharPopup = (id) => { document.getElementById(id).classList.remove('active'); };
        window.verFoto = (url) => { if(!url) return alert("Foto indispon√≠vel"); document.getElementById('img-viewer').src = url; document.getElementById('popup-foto').classList.add('active'); };
        window.verGps = (coords) => { if(!coords || coords === '0,0') return alert("Localiza√ß√£o indispon√≠vel."); const [lat, lon] = coords.split(','); document.getElementById('iframe-gps').src = `https://maps.google.com/maps?q=${lat},${lon}&t=&z=15&ie=UTF8&iwloc=&output=embed`; document.getElementById('popup-gps').classList.add('active'); };

        window.validarAcessoExtrato = async () => {
            const p = document.getElementById('login-placa-manual').value.toUpperCase().trim();
            const c = document.getElementById('login-codigo').value.trim();
            const dr = await getDoc(doc(db, "codigos_acesso", p));
            if(dr.exists() && String(dr.data().codigo) === c) {
                document.getElementById('extrato-placa-titulo').innerText = "Ve√≠culo: " + p;
                const historico = listaGlobalViagens.filter(v => v.placa.toUpperCase().trim() === p);
                document.getElementById('corpo-extrato').innerHTML = historico.map(v => `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                        <td class="p-3 text-[10px] text-white font-bold">
                            ${v.nome}<br>
                            <span class="text-cyan-400 font-normal opacity-70">${v.tipoServico} ‚Ä¢ ${new Date(v.dataInicio.toMillis()).toLocaleDateString()}</span>
                        </td>
                        <td class="p-3 text-center text-[10px] text-slate-300 font-mono">${v.kmInicio}</td>
                        <td class="p-3 text-center text-[10px] text-slate-300 font-mono">${v.kmFim || '...'}</td>
                        <td class="p-3 text-center text-[10px] text-emerald-400 font-black font-mono">${v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '-'}</td>
                        <td class="p-3 text-center flex justify-center gap-1">
                            <button onclick="compartilharWpp('${v.id}')" class="p-1.5 bg-[#25D366]/20 text-[#25D366] rounded-lg hover:bg-[#25D366]/30" title="WhatsApp"><i data-lucide="message-circle" class="w-3 h-3"></i></button>
                            <button onclick="verFoto('${v.fotoInicio}')" class="p-1.5 bg-blue-500/10 text-blue-400 rounded-lg hover:bg-blue-500/20" title="Sa√≠da"><i data-lucide="log-out" class="w-3 h-3"></i></button>
                            <button onclick="verFoto('${v.fotoFim}')" class="p-1.5 bg-emerald-500/10 text-emerald-400 rounded-lg hover:bg-emerald-500/20" title="Chegada"><i data-lucide="flag" class="w-3 h-3"></i></button>
                        </td>
                    </tr>`).join('');
                fecharModal('modal-extrato-login'); document.getElementById('modal-tabela-extrato').classList.remove('hidden'); lucide.createIcons();
            } else { alert("Acesso negado."); }
        };

        window.renderizarAdmin = () => {
            const container = document.getElementById('lista-viagens');
            const busca = document.getElementById('busca-admin').value.toLowerCase();
            container.innerHTML = "";
            
            // Limitando a renderiza√ß√£o para os 50 √∫ltimos itens se n√£o houver busca, para n√£o travar
            let dadosFiltrados = listaGlobalViagens.filter(v => (v.nome.toLowerCase().includes(busca) || v.placa.toLowerCase().includes(busca)) && (filtroAdminAtual === 'todos' || v.status === filtroAdminAtual));
            if(!busca && filtroAdminAtual === 'todos') dadosFiltrados = dadosFiltrados.slice(0, 50);

            dadosFiltrados.forEach(v => {
                const isE = v.status === 'em_curso';
                const horaIni = v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '--:--';
                const horaFim = v.dataFim ? new Date(v.dataFim.toMillis()).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '...';
                
                container.innerHTML += `
                <div class="admin-card ${isE ? 'em-curso' : ''}">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="px-2 py-0.5 rounded text-[8px] font-black uppercase tracking-wider mb-1 inline-block ${isE ? 'bg-amber-500/10 text-amber-500' : 'bg-emerald-500/10 text-emerald-500'}">${isE ? 'EM ROTA' : 'FINALIZADA'} ‚Ä¢ ${v.tipoServico || 'Geral'}</span>
                            <h2 class="text-lg font-black uppercase text-white leading-tight">${v.nome}</h2>
                            <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">${v.placa} ‚Ä¢ ${v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleDateString() : ''}</p>
                        </div>
                        <div class="flex gap-1">
                             <button onclick="compartilharWpp('${v.id}')" class="text-emerald-400 bg-emerald-500/5 p-2 rounded-lg hover:bg-emerald-500/10"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                             <button onclick="excluirCard('${v.id}')" class="text-red-400 bg-red-500/5 p-2 rounded-lg hover:bg-red-500/10"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4 px-1">
                        <div class="time-badge"><i data-lucide="clock" class="w-3 h-3 text-blue-400"></i> Sa√≠da: ${horaIni}</div>
                        <div class="w-8 h-[1px] bg-white/10"></div>
                        <div class="time-badge"><i data-lucide="flag" class="w-3 h-3 text-emerald-400"></i> Chegada: ${horaFim}</div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center mb-4 bg-slate-900/50 p-3 rounded-xl border border-white/5">
                        <div><p class="text-[8px] text-slate-500 uppercase font-bold mb-0.5">In√≠cio</p><p class="font-bold text-white text-sm font-mono">${v.kmInicio}</p></div>
                        <div class="border-l border-white/5"><p class="text-[8px] text-slate-500 uppercase font-bold mb-0.5">Fim</p><p class="font-bold text-white text-sm font-mono">${v.kmFim || '-'}</p></div>
                        <div class="border-l border-white/5"><p class="text-[8px] text-cyan-500 uppercase font-bold mb-0.5">Total</p><p class="font-bold text-cyan-400 text-sm font-mono">${v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '-'}</p></div>
                    </div>
                    <div id="admin-timer-${v.id}" class="text-2xl font-black text-center mb-4 ${isE ? 'text-amber-500' : 'text-slate-600'} font-mono tracking-tighter drop-shadow-sm">${isE ? '00:00:00' : (v.duracao || '--')}</div>
                    <div class="grid grid-cols-4 gap-2 text-[9px] font-bold uppercase">
                        <button onclick="verGps('${v.locInicio}')" class="glass p-2 rounded-lg flex flex-col items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="map-pin" class="w-3 h-3 text-blue-500"></i> Sa√≠da</button>
                        <button onclick="verGps('${v.locFim}')" class="glass p-2 rounded-lg flex flex-col items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="map-pin" class="w-3 h-3 text-red-500"></i> Chegada</button>
                        <button onclick="verFoto('${v.fotoInicio}')" class="glass p-2 rounded-lg flex flex-col items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="image" class="w-3 h-3 text-blue-500"></i> Sa√≠da</button>
                        <button onclick="verFoto('${v.fotoFim}')" class="glass p-2 rounded-lg flex flex-col items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="image" class="w-3 h-3 text-red-500"></i> Chegada</button>
                    </div>
                    <button onclick="abrirObsAdmin('${v.id}')" class="w-full mt-2 bg-slate-800/30 text-slate-400 text-[9px] py-2 rounded-lg hover:bg-slate-800 uppercase font-bold border border-white/5">${v.historico_obs?.length > 0 ? `<span class="text-amber-400">Ver ${v.historico_obs.length} Ocorr√™ncias</span>` : 'Nenhuma Ocorr√™ncia'}</button>
                </div>`;
            });
            lucide.createIcons();
        };

        window.gerarExcel = () => {
            if(listaGlobalViagens.length === 0) return alert("Sem dados.");
            const exportData = listaGlobalViagens.map(v => ({ Data: v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleDateString() : '', Hora_Saida: v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleTimeString() : '', Hora_Chegada: v.dataFim ? new Date(v.dataFim.toMillis()).toLocaleTimeString() : '', Tipo: v.tipoServico, Motorista: v.nome, Placa: v.placa, KM_Inicial: v.kmInicio, KM_Final: v.kmFim || '', Total_KM: v.kmFim ? v.kmFim - v.kmInicio : '', Dura√ß√£o: v.duracao || '', Status: v.status }));
            const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Frota"); XLSX.writeFile(wb, "Relatorio_Frota_Icaphi.xlsx");
        };

        window.excluirPeriodoSelecionado = async () => {
            const ini = document.getElementById('data-exp-inicio').value; const fim = document.getElementById('data-exp-fim').value; if(!ini || !fim) return alert("Selecione as datas.");
            if(confirm(`Apagar TUDO de ${ini} at√© ${fim}?`)) { showLoader(); const dIni = new Date(ini + "T00:00:00"); const dFim = new Date(fim + "T23:59:59"); const q = query(collection(db, "viagens"), where("dataInicio", ">=", Timestamp.fromDate(dIni)), where("dataInicio", "<=", Timestamp.fromDate(dFim))); const snaps = await getDocs(q); await Promise.all(snaps.docs.map(d => deleteDoc(doc(db, "viagens", d.id)))); hideLoader(); alert("Limpeza conclu√≠da."); fecharModal('modal-export'); }
        };

        window.iniciarViagem = async () => {
            const n = document.getElementById('motorista').value, p = document.getElementById('placa').value.toUpperCase().replace(/\s/g, ''), k = document.getElementById('km-inicio').value, f = document.getElementById('foto-inicio').files[0], t = document.getElementById('tipo-servico').value;
            if(!n || !p || !k || !f) return alert("Preencha tudo e tire a foto!"); 
            showLoader(); 
            try {
                const pos = await obterPosicao();
                // AQUI: Usando compress√£o otimizada para evitar erro de mem√≥ria
                const fotoComprimida = await comprimir(f);
                const d = await addDoc(collection(db, "viagens"), { nome: n, placa: p, kmInicio: Number(k), fotoInicio: fotoComprimida, dataInicio: Timestamp.now(), locInicio: `${pos.coords.latitude},${pos.coords.longitude}`, status: "em_curso", tipoServico: t, historico_obs: [] });
                localStorage.setItem('v_id', d.id); location.reload();
            } catch (error) {
                hideLoader();
                alert("Erro ao salvar: Tente tirar uma foto com resolu√ß√£o menor ou feche outros apps.");
                console.error(error);
            }
        };

        window.encerrarViagem = async () => {
            const id = localStorage.getItem('v_id'), kf = document.getElementById('km-fim').value, ff = document.getElementById('foto-fim').files[0];
            if(!kf || !ff) return alert("Preencha KM final e Foto."); 
            showLoader(); 
            try {
                const pos = await obterPosicao(); 
                const duracao = document.getElementById('cronometro-motorista').innerText;
                const fotoComprimida = await comprimir(ff);
                const docRef = doc(db, "viagens", id); const snap = await getDoc(docRef); 
                await updateDoc(docRef, { kmFim: Number(kf), fotoFim: fotoComprimida, status: "finalizada", duracao: duracao, dataFim: Timestamp.now(), locFim: `${pos.coords.latitude},${pos.coords.longitude}` });
                localStorage.removeItem('v_id'); hideLoader();
                const dIni = new Date(snap.data().dataInicio.toMillis());
                const txt = `*RELAT√ìRIO DE VIAGEM*%0A---------------------------%0Aüöó Ve√≠culo: ${snap.data().placa}%0Aüë§ Condutor: ${snap.data().nome}%0Aüìù Tipo: ${snap.data().tipoServico}%0AüìÖ Data: ${dIni.toLocaleDateString()}%0A‚è∞ Sa√≠da: ${dIni.toLocaleTimeString()}%0AüèÅ Chegada: ${new Date().toLocaleTimeString()}%0A---------------------------%0A‚ñ∂ KM Inicial: ${snap.data().kmInicio}%0A‚èπ KM Final: ${kf}%0Aüìè Total: ${(Number(kf)-snap.data().kmInicio).toFixed(1)} km%0A‚è± Dura√ß√£o: ${duracao}`;
                document.getElementById('btn-share-wpp').onclick = () => window.open(`https://api.whatsapp.com/send?text=${txt}`); document.getElementById('modal-sucesso-viagem').classList.remove('hidden');
            } catch (error) {
                hideLoader();
                alert("Erro de mem√≥ria. Tente novamente.");
            }
        };

        window.compartilharWpp = (id) => { 
            const v = listaGlobalViagens.find(x=>x.id===id); 
            const dIni = new Date(v.dataInicio.toMillis()); const dFim = v.dataFim ? new Date(v.dataFim.toMillis()) : null; const hFim = dFim ? dFim.toLocaleTimeString() : 'Em andamento'; const kmFim = v.kmFim || '...'; const total = v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '...';
            const txt = `*RESUMO DE FROTA*%0A---------------------------%0Aüöó Placa: ${v.placa}%0Aüë§ Motorista: ${v.nome}%0Aüìù Tipo: ${v.tipoServico}%0AüìÖ Data: ${dIni.toLocaleDateString()}%0A‚è∞ Sa√≠da: ${dIni.toLocaleTimeString()}%0AüèÅ Chegada: ${hFim}%0A---------------------------%0A‚ñ∂ KM Inicial: ${v.kmInicio}%0A‚èπ KM Final: ${kmFim}%0Aüìè Total: ${total} km%0A‚è± Tempo: ${v.duracao || '--'}`;
            window.open(`https://api.whatsapp.com/send?text=${txt}`); 
        };

        window.abrirModalGerarCodigo = () => { const p = [...new Set(listaGlobalViagens.map(v => v.placa.trim().toUpperCase()).filter(x=>x))].sort(); document.getElementById('gc-placa-select').innerHTML = p.map(x => `<option>${x}</option>`).join(''); document.getElementById('display-codigo-gerado').classList.add('hidden'); document.getElementById('modal-gerar-codigo').classList.remove('hidden'); };
        window.processarGeracaoCodigo = async () => { const p = document.getElementById('gc-placa-select').value; const c = Math.floor(1000+Math.random()*9000); await setDoc(doc(db, "codigos_acesso", p), { codigo: String(c), placa: p }); document.getElementById('display-codigo-gerado').innerText = c; document.getElementById('display-codigo-gerado').classList.remove('hidden'); };
        window.abrirModalNotifAdmin = () => { document.getElementById('modal-gerenciar-notif').classList.remove('hidden'); renderizarNotificacoesAdmin(); };
        window.renderizarNotificacoesAdmin = () => { document.getElementById('lista-notif-admin').innerHTML = listaNotificacoes.map(n => `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/10 mb-2"><span class="text-[10px] text-slate-300 w-4/5">${n.texto}</span><button onclick="excluirNotificacao('${n.id}')" class="text-red-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join(''); lucide.createIcons(); };
        window.salvarNotificacao = async () => { const t = document.getElementById('notif-texto').value; if(t) { await addDoc(collection(db, "notificacoes"), { texto: t, criadoEm: Date.now() }); document.getElementById('notif-texto').value = ""; } };
        window.excluirNotificacao = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, "notificacoes", id)); };
        window.abrirModalNotif = () => { document.getElementById('btn-sino').classList.remove('pulsing'); document.getElementById('notif-badge').classList.add('hidden'); document.getElementById('modal-notificacoes').classList.remove('hidden'); };
        const obterPosicao = () => new Promise(r => navigator.geolocation.getCurrentPosition(r, () => r({coords:{latitude:0,longitude:0}}), {enableHighAccuracy: false, timeout: 5000}));
        
        // FUN√á√ÉO DE COMPRESS√ÉO CORRIGIDA (EVITA ERRO DE MEM√ìRIA)
        const comprimir = (f) => new Promise((resolve, reject) => { 
            const rd = new FileReader(); 
            rd.readAsDataURL(f); 
            rd.onload = e => { 
                const i = new Image(); 
                i.src = e.target.result; 
                i.onload = () => { 
                    // Reduzindo resolu√ß√£o m√°xima para 720px para economizar RAM
                    const maxW = 720; 
                    const scale = maxW / i.width; 
                    const canvas = document.createElement('canvas'); 
                    canvas.width = maxW; 
                    canvas.height = i.height * scale; 
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(i, 0, 0, canvas.width, canvas.height); 
                    // Reduzindo qualidade para 0.5 (leve e leg√≠vel)
                    resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                };
                i.onerror = reject;
            };
            rd.onerror = reject;
        });

        const calcularTempo = (i) => { const d = Math.floor((Date.now()-i)/1000); return new Date(d*1000).toISOString().substr(11,8); };
        window.acessoAdmin = () => { if(prompt("Senha:") === "60010774") mudarTela('admin'); };
        window.salvarObservacaoMotorista = async () => { const id = localStorage.getItem('v_id'); await updateDoc(doc(db, "viagens", id), { historico_obs: arrayUnion({tipo: document.getElementById('comp-tipo').value, texto: document.getElementById('comp-obs').value, hora: new Date().toLocaleTimeString()}) }); fecharModal('modal-complementos'); alert("Salvo!"); };
        window.abrirObsAdmin = (id) => { const v = listaGlobalViagens.find(x => x.id === id); document.getElementById('conteudo-obs-admin').innerHTML = v.historico_obs?.map(o=>`<div class='p-3 bg-slate-900 border border-white/10 rounded-lg mb-2'><p class='text-[9px] text-cyan-500 font-bold uppercase'>${o.tipo} ‚Ä¢ ${o.hora}</p><p class='text-xs text-slate-300'>${o.texto}</p></div>`).join('') || "<p class='text-center text-slate-500 text-xs py-4'>Sem registros.</p>"; document.getElementById('modal-ver-obs').classList.remove('hidden'); };
        window.excluirCard = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "viagens", id)); };

        // INIT
        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => { listaGlobalViagens = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderizarAdmin(); });
        onSnapshot(collection(db, "notificacoes"), (snap) => { listaNotificacoes = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.criadoEm - a.criadoEm); document.getElementById('lista-notificacoes-motorista').innerHTML = listaNotificacoes.map(n => `<div class='p-3 bg-white/5 rounded-xl border-l-2 border-amber-500 mb-2'><p class='text-[9px] text-amber-500 font-bold mb-1'>${new Date(n.criadoEm).toLocaleDateString()}</p><p class='text-xs text-slate-300'>${n.texto}</p></div>`).join(''); if(!document.getElementById('modal-gerenciar-notif').classList.contains('hidden')) renderizarNotificacoesAdmin(); if (!isFirstLoadNotif && snap.docChanges().some(c => c.type === 'added')) { document.getElementById('btn-sino').classList.add('pulsing'); document.getElementById('notif-badge').classList.remove('hidden'); } isFirstLoadNotif = false; });
        setInterval(() => { listaGlobalViagens.filter(v => v.status === 'em_curso').forEach(v => { const el = document.getElementById(`admin-timer-${v.id}`); if(el) el.innerText = calcularTempo(v.dataInicio.toMillis()); }); }, 1000);
        window.addEventListener('load', async () => { lucide.createIcons(); hideLoader(); const vid = localStorage.getItem('v_id'); if(vid) { try { const s = await getDoc(doc(db, "viagens", vid)); if(s.exists() && s.data().status === 'em_curso') { mudarTela('em-curso'); document.getElementById('info-viagem-ativa').innerText = "EM ROTA: " + s.data().placa; setInterval(() => document.getElementById('cronometro-motorista').innerText = calcularTempo(s.data().dataInicio.toMillis()), 1000); } else { localStorage.removeItem('v_id'); } } catch(e) {} } });
    </script>
</body>
</html>
