<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogDrive Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; }
        .input-style { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; width: 100%; padding: 0.75rem; border-radius: 0.75rem; outline: none; font-size: 14px; }
        .btn-primary { background: #2563eb; transition: all 0.2s; }
        .glass-modal { background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(12px); z-index: 100; }
        .badge-em-viagem { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header id="header-main" class="flex justify-between items-center py-6">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-blue-500 italic">LOG<span class="text-white">DRIVE</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Controle de Frota</p>
        </div>
        <button onclick="acessoAdmin()" class="p-3 card border-slate-700 active:bg-slate-800 transition">
            <i data-lucide="shield-lock" class="text-blue-400 w-5 h-5"></i>
        </button>
    </header>

    <main id="tela-inicio" class="space-y-6">
        <div class="card p-6 shadow-2xl border-t-4 border-t-blue-600">
            <h2 class="text-lg font-semibold mb-5 flex items-center gap-2">
                <i data-lucide="play" class="text-emerald-400 fill-emerald-400 w-4 h-4"></i> Iniciar Viagem
            </h2>
            <div class="space-y-4">
                <input type="text" id="motorista" placeholder="Nome do Motorista" class="input-style">
                <input type="text" id="placa" placeholder="Placa do Carro" class="input-style uppercase font-mono">
                <input type="number" id="km-inicio" placeholder="KM Inicial do Od√¥metro" class="input-style">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                    <i data-lucide="camera" class="text-slate-500 mb-2"></i>
                    <span class="text-sm text-slate-400" id="label-foto-inicio">Foto do Painel (In√≠cio)</span>
                    <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-inicio')">
                </label>
                <button onclick="iniciarViagem()" id="btn-iniciar" class="w-full btn-primary py-4 rounded-xl font-bold">INICIAR AGORA</button>
            </div>
        </div>
    </main>

    <main id="tela-viagem" class="hidden space-y-8 py-10 text-center">
        <div class="relative flex flex-col items-center justify-center">
            <div class="w-64 h-64 rounded-full border-4 border-blue-600/10 border-t-blue-500 animate-spin absolute"></div>
            <div class="w-56 h-56 rounded-full flex flex-col items-center justify-center bg-slate-900 z-10">
                <h3 id="cronometro-motorista" class="text-5xl font-mono font-bold">00:00:00</h3>
            </div>
        </div>
        <div class="card p-6 border-t-4 border-t-red-600 text-left">
            <p id="info-viagem-ativa" class="text-[10px] text-slate-500 mb-4 uppercase font-bold text-center"></p>
            <input type="number" id="km-fim" placeholder="KM Final" class="input-style mb-4">
            <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-700 rounded-xl mb-6 bg-slate-800/20 cursor-pointer">
                <span class="text-sm text-slate-400" id="label-foto-fim">Foto do Painel (Fim)</span>
                <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-fim')">
            </label>
            <button onclick="finalizarViagem()" id="btn-finalizar" class="w-full bg-red-600 py-4 rounded-xl font-bold">ENCERRAR VIAGEM</button>
        </div>
    </main>

    <main id="tela-admin" class="hidden space-y-4 pb-10">
        <div class="flex items-center justify-between sticky top-0 bg-[#020617] py-4 z-20">
            <button onclick="mudarTela('inicio')" class="p-2 bg-slate-800 rounded-lg"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-bold text-blue-500">Hist√≥rico Admin</h2>
            <button onclick="abrirModalExport()" class="p-3 bg-emerald-600 rounded-xl"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i></button>
        </div>
        <div id="lista-viagens" class="space-y-4"></div>
    </main>

    <main id="tela-resumo" class="hidden space-y-6 py-10">
        <div id="dados-resumo-render" class="space-y-6">
            </div>
    </main>

    <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4 shadow-2xl">
            <h3 class="font-bold text-center text-lg">Exportar Relat√≥rio</h3>
            <div>
                <label class="text-[10px] text-slate-500 uppercase font-bold">Filtrar Placa</label>
                <select id="select-placa-export" class="input-style mt-1"></select>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Data In√≠cio</label>
                    <input type="date" id="data-exp-inicio" class="input-style mt-1 text-xs">
                </div>
                <div>
                    <label class="text-[10px] text-slate-500 uppercase font-bold">Data Fim</label>
                    <input type="date" id="data-exp-fim" class="input-style mt-1 text-xs">
                </div>
            </div>
            <button onclick="gerarExcel()" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">BAIXAR EXCEL</button>
            <button onclick="fecharModalExport()" class="w-full text-slate-500 text-sm">Cancelar</button>
        </div>
    </div>

    <div id="modal-img" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-4" onclick="this.classList.add('hidden')">
        <img id="img-full" class="rounded-2xl max-h-[80vh]">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
            authDomain: "marcador-ponto-digital.firebaseapp.com",
            projectId: "marcador-ponto-digital",
            storageBucket: "marcador-ponto-digital.firebasestorage.app",
            messagingSenderId: "774324665760",
            appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let idAtual = localStorage.getItem('logdrive_viagem_id');
        let resumoObjeto = JSON.parse(localStorage.getItem('logdrive_resumo')) || {};
        let textoResumoGlobal = ""; 

        const SENHA_ADMIN = "60010774";

        const formatarTempo = (s) => {
            const h = Math.floor(s / 3600).toString().padStart(2, '0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${h}:${m}:${sec}`;
        };

        window.mudarTela = (tela) => {
            ['tela-inicio', 'tela-viagem', 'tela-admin', 'tela-resumo'].forEach(t => document.getElementById(t).classList.add('hidden'));
            document.getElementById('tela-' + tela).classList.remove('hidden');
            lucide.createIcons();
        };

        window.previewFoto = (input, labelId) => {
            if (input.files?.[0]) document.getElementById(labelId).innerText = "Foto Selecionada ‚úÖ";
        };

        const compressImage = (file) => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const w = 800; const scale = w / img.width;
                    canvas.width = w; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    res(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });

        const getLoc = () => new Promise(res => {
            navigator.geolocation.getCurrentPosition(p => res(`${p.coords.latitude},${p.coords.longitude}`), () => res("Sem GPS"), {enableHighAccuracy: true});
        });

        window.acessoAdmin = () => {
            if(prompt("Senha:") === SENHA_ADMIN) mudarTela('admin');
        };

        window.verFoto = (src) => {
            document.getElementById('img-full').src = src;
            document.getElementById('modal-img').classList.remove('hidden');
        };

        window.excluirViagem = async (id) => {
            if(confirm("Deseja apagar este registro?")) await deleteDoc(doc(db, "viagens", id));
        };

        window.iniciarViagem = async () => {
            const n = document.getElementById('motorista').value;
            const p = document.getElementById('placa').value;
            const k = document.getElementById('km-inicio').value;
            const f = document.getElementById('foto-inicio').files[0];
            if(!n || !p || !k || !f) return alert("Preencha todos os campos!");
            
            const btn = document.getElementById('btn-iniciar');
            btn.disabled = true;
            const fotoC = await compressImage(f);
            const loc = await getLoc();
            const agora = new Date();
            
            const docRef = await addDoc(collection(db, "viagens"), {
                nome: n, placa: p, kmInicio: parseFloat(k), fotoInicio: fotoC, locInicio: loc, status: 'em_curso', dataInicio: agora
            });
            
            localStorage.setItem('logdrive_viagem_id', docRef.id);
            localStorage.setItem('logdrive_resumo', JSON.stringify({nome: n, placa: p, kmInicio: parseFloat(k)}));
            location.reload();
        };

        window.finalizarViagem = async () => {
            const kF = document.getElementById('km-fim').value;
            const f = document.getElementById('foto-fim').files[0];
            if(!kF || !f) return alert("Insira o KM final e a foto!");
            
            const btn = document.getElementById('btn-finalizar');
            btn.disabled = true;
            const fotoC = await compressImage(f);
            const loc = await getLoc();
            const dur = document.getElementById('cronometro-motorista').innerText;
            const dist = parseFloat(kF) - resumoObjeto.kmInicio;

            await updateDoc(doc(db, "viagens", idAtual), {
                kmFim: parseFloat(kF), dispersao: dist, fotoFim: fotoC, locFim: loc, status: 'finalizada', dataFim: new Date(), duracao: dur
            });

            textoResumoGlobal = `üìä *LOGDRIVE PRO*\nüë§ *Motorista:* ${resumoObjeto.nome}\nüöó *Placa:* ${resumoObjeto.placa.toUpperCase()}\n‚è±Ô∏è *Tempo:* ${dur}\nüõ£Ô∏è *KM Total:* ${dist.toFixed(1)} km`;

            localStorage.removeItem('logdrive_viagem_id');
            localStorage.removeItem('logdrive_resumo');
            
            document.getElementById('dados-resumo-render').innerHTML = `
                <div class="card p-6 bg-slate-900/50 space-y-2">
                    <h2 class="text-xl font-bold border-b border-slate-800 pb-2">Resumo da Viagem</h2>
                    <p class="text-slate-400">Motorista: <span class="text-white">${resumoObjeto.nome}</span></p>
                    <p class="text-slate-400">Placa: <span class="text-white font-mono">${resumoObjeto.placa.toUpperCase()}</span></p>
                    <p class="text-slate-400">KM Total: <span class="text-emerald-400 font-bold">${dist.toFixed(1)} km</span></p>
                    <p class="text-slate-400">Tempo: <span class="text-blue-400 font-mono">${dur}</span></p>
                </div>
                <div class="space-y-3">
                    <button onclick="compartilharResumo()" class="w-full bg-blue-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                        <i data-lucide="share-2"></i> COMPARTILHAR
                    </button>
                    <button onclick="location.reload()" class="w-full bg-slate-800 py-4 rounded-xl font-bold">VOLTAR AO IN√çCIO</button>
                </div>
            `;
            mudarTela('resumo');
        };

        window.compartilharResumo = () => {
            if (navigator.share) {
                navigator.share({ text: textoResumoGlobal });
            } else {
                alert("Resumo copiado:\n\n" + textoResumoGlobal);
            }
        };

        window.abrirModalExport = async () => {
            const select = document.getElementById('select-placa-export');
            select.innerHTML = '<option value="TODAS">Todas as Placas</option>';
            const querySnapshot = await getDocs(collection(db, "viagens"));
            const placas = new Set();
            querySnapshot.forEach(d => placas.add(d.data().placa.toUpperCase()));
            placas.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('modal-export').classList.remove('hidden');
        };

        window.fecharModalExport = () => document.getElementById('modal-export').classList.add('hidden');

        window.gerarExcel = async () => {
            const dIni = document.getElementById('data-exp-inicio').value;
            const dFim = document.getElementById('data-exp-fim').value;
            const pSel = document.getElementById('select-placa-export').value;
            const qS = await getDocs(query(collection(db, "viagens"), orderBy("dataInicio", "desc")));
            let dados = [];
            qS.forEach(docSnap => {
                const v = docSnap.data();
                const dataV = v.dataInicio?.toDate();
                let matchData = true;
                if(dIni && dFim) {
                    const s = new Date(dIni + "T00:00:00");
                    const e = new Date(dFim + "T23:59:59");
                    matchData = dataV >= s && dataV <= e;
                }
                let matchPlaca = pSel === "TODAS" || v.placa.toUpperCase() === pSel;
                if(matchData && matchPlaca) {
                    dados.push({ Motorista: v.nome, Placa: v.placa, Data: dataV?.toLocaleDateString(), Inicio: v.kmInicio, Fim: v.kmFim || "", Total: v.dispersao?.toFixed(1) || 0, Duracao: v.duracao || "" });
                }
            });
            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Viagens");
            XLSX.writeFile(wb, `LogDrive_${new Date().getTime()}.xlsx`);
            fecharModalExport();
        };

        setInterval(() => {
            const agora = new Date().getTime();
            document.querySelectorAll('.cronometro-ativo-admin').forEach(el => {
                const inicio = parseInt(el.getAttribute('data-inicio'));
                const diff = Math.floor((agora - inicio) / 1000);
                el.innerText = formatarTempo(diff);
            });
        }, 1000);

        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => {
            const list = document.getElementById('lista-viagens');
            list.innerHTML = "";
            snap.forEach(d => {
                const v = d.data();
                const inicioMS = v.dataInicio?.toDate().getTime();
                const dataFormatada = v.dataInicio?.toDate().toLocaleDateString('pt-BR');
                const isEmCurso = v.status === 'em_curso';
                
                list.innerHTML += `
                    <div class="card p-5 mb-4 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg uppercase">${v.nome}</h3>
                                <p class="text-blue-400 font-mono text-xs uppercase">${v.placa}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] px-2 py-1 rounded-full font-bold uppercase ${isEmCurso ? 'badge-em-viagem' : 'bg-emerald-500/10 text-emerald-500 border border-emerald-500/20'}">
                                    ${isEmCurso ? 'Em Viagem' : 'Conclu√≠do'}
                                </span>
                                <button onclick="excluirViagem('${d.id}')" class="text-slate-700 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        <div class="bg-slate-950/40 p-3 rounded-xl text-center mb-4 border border-slate-800/50">
                            <p class="text-[9px] text-slate-500 uppercase tracking-widest mb-1">Tempo de Viagem</p>
                            <span class="font-mono text-xl font-bold ${isEmCurso ? 'text-blue-400 cronometro-ativo-admin' : 'text-slate-300'}" 
                                  data-inicio="${inicioMS}">
                                ${isEmCurso ? '00:00:00' : v.duracao}
                            </span>
                        </div>

                        <div class="grid grid-cols-2 gap-4 text-xs mb-4">
                            <div>
                                <p class="text-slate-500 uppercase text-[9px]">KM Inicial</p>
                                <p class="font-bold text-sm text-slate-200">${v.kmInicio} km</p>
                            </div>
                            <div>
                                <p class="text-slate-500 uppercase text-[9px]">KM Final</p>
                                <p class="font-bold text-sm text-slate-200">${v.kmFim ? v.kmFim + ' km' : '--'}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button onclick="verFoto('${v.fotoInicio}')" class="bg-slate-800/50 hover:bg-slate-800 py-2.5 rounded-lg font-bold text-[10px] uppercase transition">Foto In√≠cio</button>
                            ${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="bg-slate-800/50 hover:bg-slate-800 py-2.5 rounded-lg font-bold text-[10px] uppercase transition">Foto Fim</button>` : ''}
                        </div>

                        <div class="flex justify-between items-center text-[10px] text-slate-600 border-t border-slate-800/50 pt-3 mt-2">
                             <div class="flex gap-3">
                                <span onclick="window.open('http://googleusercontent.com/maps.google.com/?q=${v.locInicio}')" class="cursor-pointer hover:text-blue-400 flex items-center gap-1">üìç In√≠cio</span>
                                ${v.locFim ? `<span onclick="window.open('http://googleusercontent.com/maps.google.com/?q=${v.locFim}')" class="cursor-pointer hover:text-emerald-400 flex items-center gap-1">üìç Fim</span>` : ''}
                            </div>
                            <span>${dataFormatada}</span>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        });

        window.addEventListener('load', async () => {
            if (idAtual) {
                const docSnap = await getDoc(doc(db, "viagens", idAtual));
                if (docSnap.exists() && docSnap.data().status === 'em_curso') {
                    const d = docSnap.data();
                    mudarTela('viagem');
                    document.getElementById('info-viagem-ativa').innerText = `${d.nome} ‚Ä¢ ${d.placa}`;
                    setInterval(() => {
                        const diff = Math.floor((new Date().getTime() - d.dataInicio.toDate().getTime()) / 1000);
                        document.getElementById('cronometro-motorista').innerText = formatarTempo(diff);
                    }, 1000);
                }
            }
            lucide.createIcons();
        });
    </script>
</body>
</html>
