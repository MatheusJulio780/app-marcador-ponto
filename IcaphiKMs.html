<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICAPHI - KMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NOVO AZUL/CIANO (Substitui o Roxo)
                        'cianoblue': {
                            50: '#F0F9FF',
                            100: '#E0F2FE',
                            200: '#BAE6FD',
                            600: '#06B6D4', // Ciano Primário - Clean & Modern
                            700: '#0891B2', // Ciano Hover
                        },
                        // Verde (Teal/Ciano) mantido para sucesso
                        'teal': {
                            600: '#0D9488', 
                            700: '#0F766E', 
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Configuração de Fonte Padrão e Estilos Globais */
        :root {
            /* Cores de Liquid Glass Sofisticadas (Ciano/Azul) */
            --primary-color: #06B6D4; /* Ciano-600 */
            --primary-hover: #0891B2; /* Ciano-700 */
            --success-color: #0D9488; /* Teal-600 */
            --success-hover: #0F766E; /* Teal-700 */
            --text-dark: #1f2937; 
            /* Efeito de Vidro: Mais transparente e claro */
            --glass-bg: rgba(255, 255, 255, 0.3); /* Mais transparente */
            --glass-border: rgba(255, 255, 255, 0.6); /* Borda mais brilhante */
        }
        body {
            font-family: 'Poppins', sans-serif;
            /* Fundo Gradiente Neutro e Claro (iOS-like) */
            background: linear-gradient(135deg, #e7edf3 0%, #f7f9fc 100%);
            min-height: 100vh;
            color: var(--text-dark); 
            transition: background 0.5s ease;
        }
        
        /* Estilo Principal: O Card "Liquid Glass" Aprimorado */
        .container-card {
            /* Efeito Liquid Glass (Glassmorphism) */
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%); /* Blur mais forte */
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            padding: 2.5rem; 
            border-radius: 24px; /* Mais arredondado */
            /* Borda sutil para simular o brilho do vidro */
            border: 1px solid var(--glass-border); 
            /* Sombra suave e longa para maior profundidade */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.05), 
                        0 20px 40px rgba(0, 0, 0, 0.08),
                        inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
        }
        .container-card:hover {
            transform: translateY(-4px); /* Elevação mais perceptível */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08), 
                        0 25px 50px rgba(0, 0, 0, 0.12),
                        inset 0 0 0 1px rgba(255, 255, 255, 0.3);
        }

        /* Títulos e Destaques */
        h1, h2, h3 {
            color: var(--text-dark);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5); /* Sombra de luz para as letras */
        }

        /* Botões Base (Aplica a transição e formato) */
        .btn-base {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Curva mais suave */
            border-radius: 14px; /* Mais arredondado */
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        /* Botão Primário (Ciano/Azul) - Efeito Gradiente 'Gelado' */
        .btn-primary {
            background: linear-gradient(145deg, var(--primary-color), var(--primary-hover));
            color: white;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
        }
        .btn-primary:hover {
            background: linear-gradient(145deg, var(--primary-hover), var(--primary-color));
            transform: scale(1.02);
            box-shadow: 0 6px 15px rgba(6, 182, 212, 0.5);
        }

        /* Botão de Sucesso (Teal/Ciano) - Efeito Gradiente 'Verde-Água' */
        .btn-success {
             background: linear-gradient(145deg, var(--success-color), var(--success-hover));
             box-shadow: 0 4px 12px rgba(13, 148, 136, 0.4);
        }
        .btn-success:hover {
            background: linear-gradient(145deg, var(--success-hover), var(--success-color));
            transform: scale(1.02);
             box-shadow: 0 6px 15px rgba(13, 148, 136, 0.5);
        }

        /* Botões de Navegação (Motorista/Admin) - Efeito Cápsula de Vidro */
        .nav-btn {
            border-radius: 10px;
            transition: all 0.4s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
            border: 1px solid rgba(6, 182, 212, 0.4);
            background-color: rgba(255, 255, 255, 0.7); /* Base de vidro mais opaca */
            padding: 10px 24px;
        }
        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px); /* Efeito de click-out */
            box-shadow: 0 4px 10px rgba(6, 182, 212, 0.3);
            border-color: var(--primary-color);
        }
        .nav-btn:not(.active):hover {
            background-color: rgba(6, 182, 212, 0.1); /* Brilho Ciano no hover */
            color: var(--primary-color);
            transform: scale(1.02);
            border-color: var(--primary-hover);
        }
        
        /* Cronômetro com efeito de brilho Ciano */
        .text-highlight {
            color: var(--primary-color);
            font-variant-numeric: tabular-nums; 
            text-shadow: 
                0 0 8px rgba(6, 182, 212, 0.7),
                0 0 15px rgba(6, 182, 212, 0.5);
            animation: pulse-glow 2s infinite alternate; 
        }

        @keyframes pulse-glow {
            from { text-shadow: 0 0 8px rgba(6, 182, 212, 0.7); }
            to { text-shadow: 0 0 18px rgba(6, 182, 212, 0.9), 0 0 25px rgba(6, 182, 212, 0.6); }
        }

        /* Transição de Seções (Fade & Slide Suave) - Sofisticado */
        .view-section {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Curva 'Ease-Out Quad' para suavidade */
        }
        .view-section.hidden {
            opacity: 0;
            transform: translateY(20px); /* Desliza de baixo para cima */
        }

        /* Campos de Input (Para combinar com Glass) */
        input:not([type="file"]) {
            border: 1px solid rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input:not([type="file"]):focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2); /* Sombra Ciano no foco */
            background-color: white; 
        }

        /* --- CORREÇÃO E ANIMAÇÃO DO MODAL POP-UP --- */
        .photo-modal-overlay {
            /* Garante que o modal cubra toda a tela */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Fundo escuro e com blur */
            background-color: rgba(0, 0, 0, 0.85); 
            backdrop-filter: blur(12px); 
            z-index: 1000; /* Garante que fique acima de todo o conteúdo */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Transição para fade in/out */
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 1rem;
        }

        .photo-modal-overlay.visible {
            opacity: 1;
        }

        .photo-modal-content {
            /* Card que contém a imagem */
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 90vw;
            max-height: 90vh;
            background: rgba(255, 255, 255, 0.05); /* Fundo sutilmente claro */
            padding: 1.5rem;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* Configuração da Animação (Começa pequeno) */
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Springy effect */
        }
        
        .photo-modal-overlay.visible .photo-modal-content {
            transform: scale(1); /* Expande ao abrir */
        }
        
        #modal-image {
            max-width: 100%;
            max-height: 80vh; /* Limita a altura da imagem */
            border-radius: 12px;
            object-fit: contain; /* Garante que a imagem caiba sem cortar */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-start pt-10 pb-10">

    <div id="app-container" class="w-full max-w-full xl:max-w-7xl p-4 md:p-6">
        
        

        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8">
            Gerênciamento de KMs - ICAPHI Transportes
        </h1>

        <div class="flex justify-center space-x-4 mb-8">
  
            
            <button id="show-driver-btn" class="font-semibold nav-btn active" onclick="showDriverView()">
                Motorista
            </button>
            <button id="show-admin-btn" class="font-semibold nav-btn" onclick="showAdminView()">
                Administrativo
            </button>
        </div>

    
        <div id="message-area" class="text-center mb-4 p-3 rounded-lg hidden"></div>

        <div id="driver-view" class="container-card view-section">
           
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-2">Registro de Viagem</h2>
            
            <div id="start-trip-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              
                    <div>
   
                        <label for="driver-name" class="block text-sm font-medium text-gray-700">Nome do Motorista</label>
                        <input type="text" id="driver-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-cianoblue-600 focus:border-cianoblue-600" placeholder="Seu Nome Completo">
                    </div>
   
          
                    <div>
                        <label for="license-plate" class="block text-sm font-medium text-gray-700">Placa do Veículo</label>
                        <input type="text" id="license-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-cianoblue-600 focus:border-cianoblue-600 uppercase" placeholder="ABC1234">
             
                    </div>
    
                 <div>
                        <label for="km-start" class="block text-sm font-medium text-gray-700">KM Inicial (Odômetro)</label>
                        <input type="number" id="km-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-cianoblue-600 focus:border-cianoblue-600" placeholder="Ex: 55000">
   
             
                    </div>
                </div>

                <div class="mb-6 p-4 border border-cianoblue-300 rounded-xl bg-cianoblue-50/50 backdrop-blur-sm">
                    <label for="photo-start" class="block text-base font-semibold text-gray-700 mb-2 flex items-center">
     
           
                        <i class="fas fa-camera mr-2 text-cianoblue-600"></i> 1. Foto OBRIGATÓRIA do Painel/Odômetro
                    </label>
                    <input type="file" id="photo-start" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'start')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cianoblue-100/70 file:text-cianoblue-700 hover:file:bg-cianoblue-200/70"/>
            
     
                    <p id="photo-start-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="startTrip()" class="w-full btn-base btn-success text-white py-3 rounded-lg text-lg font-bold shadow-md">
                    <i class="fas fa-play"></i> Iniciar Saída
                </button>
               
 
                <p class="text-sm text-gray-600 mt-2 text-center">Será registrada a sua localização, hora e a foto do painel.</p>
            </div>

            <div id="trip-in-progress" class="hidden text-center p-6 border-2 border-dashed border-cianoblue-300 rounded-xl bg-cianoblue-50/50">
                <h3 class="text-xl font-bold text-cianoblue-700 mb-4">Viagem em Andamento!</h3>
       
                 <p class="text-gray-700 mb-2">Motorista: <span id="current-driver-name" 
 class="font-semibold"></span></p>
                <p class="text-gray-700 mb-4">Placa: <span id="current-license-plate" class="font-semibold"></span></p>

                <div class="flex justify-center items-baseline mb-6">
                    <span class="text-6xl font-extrabold text-highlight" id="timer-display">00:00:00</span>
                </div>

     
                 <label 
 for="km-end" class="block text-sm font-medium text-gray-700 mb-2">KM Final (Odômetro)</label>
                <input type="number" id="km-end" class="mb-4 block w-full md:w-1/2 mx-auto rounded-md border-gray-300 shadow-sm p-3 border text-center focus:ring-cianoblue-600 focus:border-cianoblue-600" placeholder="KM de Chegada">

                 <div class="mb-6 p-4 border border-gray-400 rounded-xl bg-gray-100/50 backdrop-blur-sm">
                    <label for="photo-end" class="block text-base font-semibold text-gray-700 mb-2 flex items-center">
       
                        <i class="fas fa-camera mr-2 text-gray-600"></i> 2. Foto OBRIGATÓRIA do Painel/Odômetro de Chegada
                    </label>
                 
    <input type="file" id="photo-end" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'end')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200/70 file:text-gray-700 hover:file:bg-gray-300/70"/>
           
                    <p id="photo-end-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="endTrip()" class="w-full btn-base btn-primary text-white py-3 rounded-lg text-lg font-bold shadow-md">
                    <i class="fas fa-stop"></i> Registrar Chegada e Finalizar Rota
                </button>
            </div>
 
 
        </div>

        <div id="admin-view" class="container-card view-section hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-2">Painel Administrativo</h2>
            
            <div id="admin-login-area">
          
               <label for="admin-password" class="block text-sm font-medium text-gray-700">Senha de Acesso</label>
     
                <input type="password" id="admin-password" class="mt-1 block w-full md:w-96 rounded-md border-gray-300 shadow-sm p-3 border focus:ring-cianoblue-600 focus:border-cianoblue-600" placeholder="Senha">
                <button onclick="adminLogin()" class="mt-4 btn-base btn-primary py-2 px-6 rounded-lg font-semibold">
                    Acessar
              
   </button>
               
  <p class="text-xs text-red-500 mt-2 hidden" id="login-error-message">Senha incorreta. (Acesso somento do administrativo)</p>
            </div>

            <div id="admin-dashboard" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Rotas Concluídas</h3>

                <div 
 class="flex flex-col md:flex-row gap-4 mb-6 p-4 rounded-xl bg-gray-100/50 backdrop-blur-sm border border-gray-200">
                 
                    <div class="flex-grow">
                        <label for="filter-plate" class="block text-sm font-medium text-gray-700">Filtrar por Placa</label>
                        <input type="text" id="filter-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border uppercase focus:ring-cianoblue-600 focus:border-cianoblue-600" placeholder="Placa (ex: ABC1234)">
                    </div>
    
                 <div class="flex-grow">
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700">Data Inicial</label>
                        <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cianoblue-600 focus:border-cianoblue-600">
                
     </div>
                    <div class="flex-grow">
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Data Final</label>
                      
                       
                        <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cianoblue-600 focus:border-cianoblue-600">
                    </div>
                    <div class="flex-shrink-0 flex items-end">
                        <button onclick="applyAdminFilters()" class="btn-base btn-primary py-2 px-4 rounded-lg font-semibold w-full md:w-auto">
           
 
                         Aplicar Filtros
                        </button>
                    </div>
                </div>

               
  <div class="flex justify-end mb-4">
   
                    <button onclick="exportToCSV()" class="btn-base btn-success text-white py-2 px-4 rounded-lg font-semibold">
                        Exportar para Planilha (CSV)
                    </button>
                </div>

 
        
               <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                
         <thead class="bg-gray-100/70 backdrop-blur-sm">
                           
  <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Motorista</th>
                       
           <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Placa</th>
                 
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">KM Total</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tempo</th>
  
                                <th class="px-2 
 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Saída (Data/Hora)</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Chegada (Data/Hora)</th>
                    
             <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">KM Inicial</th>
          
                       <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">KM Final</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Local Saída</th>
                           
          <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Local Chegada</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Foto Saída</th>
               
                  <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Foto Chegada</th>
   
                              <th class="px-2 py-3 text-center text-xs font-medium 
 text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
      
                   </thead>
          
               <tbody id="admin-table-body" class="bg-white/70 divide-y divide-gray-200/50">
                            <tr><td colspan="13" class="p-4 text-center text-gray-500">Nenhuma rota encontrada ou carregando...</td></tr>
                        </tbody>
                    </table>
  
               </div>

            </div>
        </div>
    
     
        <div id="photo-modal" class="photo-modal-overlay hidden" onclick="closePhotoModal()">
            <div class="photo-modal-content" onclick="event.stopPropagation()">
                <button onclick="closePhotoModal()" class="self-end text-3xl font-bold text-white hover:text-cianoblue-500 mb-2 transition-colors">
                    &times;
                </button>
                <img id="modal-image" src="" alt="Foto do Painel">
                <p id="modal-caption" class="mt-4 text-center text-gray-300"></p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importando deleteDoc
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs para debug
        setLogLevel('Debug');
        // --- CONFIGURAÇÃO FIREBASE ---
        const providedConfig = {
             apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
             authDomain: "marcador-ponto-digital.firebaseapp.com",
             projectId: "marcador-ponto-digital",
             storageBucket: "marcador-ponto-digital.firebasestorage.app",
             messagingSenderId: "774324665760",
             appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5",
 
 
             measurementId: "G-W1QEJTCS1B"
        };
        // Usa a configuração injetada pelo ambiente (se disponível e for um objeto válido), caso contrário, usa a configuração fornecida pelo usuário.
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '' && __firebase_config.trim() !== '{}') {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Erro ao fazer parse da configuração injetada, usando a configuração do usuário.", e);
                firebaseConfig = providedConfig;
            }
        } else {
            firebaseConfig = providedConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        let app, db, auth;
        let userId = null;
        let currentTripDocId = localStorage.getItem('currentTripDocId'); 
        let timerInterval = null;
        const ADMIN_PASSWORD = "60010774";
        // Variáveis para armazenar as fotos em Base64 temporariamente
        let startPhotoBase64 = null;
        let endPhotoBase64 = null;

        const ROUTES_COLLECTION_PATH = `/artifacts/${appId}/public/data/driver_routes`;

        // Elementos DOM
        const driverView = document.getElementById('driver-view');
        const adminView = document.getElementById('admin-view');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLoginArea = document.getElementById('admin-login-area');
        const loginErrorMessage = document.getElementById('login-error-message');
        const messageArea = document.getElementById('message-area');
        const startTripForm = document.getElementById('start-trip-form');
        const tripInProgress = document.getElementById('trip-in-progress');
        const timerDisplay = document.getElementById('timer-display');
        const adminTableBody = document.getElementById('admin-table-body');
        const photoModal = document.getElementById('photo-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCaption = document.getElementById('modal-caption');

        // --- Funções Auxiliares ---

        function displayMessage(text, type = 'info') {
            messageArea.textContent = text;
            messageArea.className = 'text-center mb-4 p-3 rounded-lg block font-semibold';
            if (type === 'success') {
                messageArea.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-800');
            } else {
                // CORRIGIDO: Ciano/Azul para mensagens info
                messageArea.classList.add('bg-cianoblue-100', 'text-cianoblue-800'); 
            }
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove('block');
            }, 5000);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalização não é suportada pelo seu navegador.'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                        });
                    },
                    (error) => {
                        console.error("Erro na geolocalização:", error);
                        reject(new Error('Não foi possível obter a localização. Certifique-se de que a localização está ativada e tente novamente.'));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        /**
         * CORRIGIDO: Esta função agora tenta construir o endereço completo 
         * (Rua, Número, Bairro, Cidade/Município) de forma mais robusta 
         * usando os dados de geocodificação reversa do Nominatim.
         */
        async function getStreetAndNeighborhood(lat, lon) {
            // Usando Nominatim como serviço de geocodificação reversa
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: {
                        // User-Agent é importante para o serviço Nominatim
                        'User-Agent': 'ICAPHI-KMS-App/1.0 (CanvasApp; contact: logistics@icaphi.com)'
                    }, 
                });
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    let parts = [];

                    // 1. Rua/Via Principal
                    const road = address.road || address.pedestrian || address.footway || '';
                    if (road) {
                        parts.push(road);
                    }
                    
                    // 2. Número da Casa/Prédio (House Number/Building) - Adicionado após a rua para o formato brasileiro
                    const houseNumber = address.house_number || address.building || '';
                    if (houseNumber) {
                        // Se já tem rua, adiciona número ao lado da rua
                        if (road) {
                           parts[0] = parts[0] + ', ' + houseNumber;
                        } else {
                           parts.push(houseNumber); // Se não tem rua, só o número.
                        }
                    }

                    // 3. Bairro/Vizinhança/Subúrbio (Ponto crucial para 'Vila Maria Helena')
                    const neighborhood = address.suburb || address.neighbourhood || address.city_district || '';
                    if (neighborhood && !parts.includes(neighborhood)) { 
                        parts.push(neighborhood);
                    }

                    // 4. Cidade/Município
                    const city = address.city || address.town || address.village || address.county || '';
                    if (city && !parts.includes(city)) {
                        parts.push(city);
                    }
                    
                    // 5. Estado (Se disponível)
                    const state = address.state || '';
                    if (state && !parts.includes(state)) {
                        parts.push(state);
                    }

                    // Construção final do endereço
                    let result = parts.join(', ');

                    // Fallback para nome do local se o endereço estruturado for fraco
                    if (result.length < 10 && data.display_name) {
                        return data.display_name;
                    }

                    return result || `Localização (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;

                }
            } catch (error) {
                console.error("Erro no Reverse Geocoding:", error);
            }
            // Retorna latitude/longitude como último recurso, se a chamada falhar
            return `Localização (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;
        }

        /**
         * Redimensiona a imagem para uma largura máxima e a converte para Base64.
         */
        function resizeImageAndConvertToBase64(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
       
 
                     img.onload = () => {
                        let width = img.width;
                        let height = img.height;

                     
    // Calcula novas dimensões mantendo 
                        if (width > height) {
                            if (width > maxWidth) {
                                
 height *= maxWidth / width;
   
                                 width = maxWidth;
                            }
                        } else {
    
            
                             if (height > maxHeight) {
                                width *= maxHeight / height;
                    
             height = maxHeight;
             
                            }
                        }

                     
    const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
 // Desenha a imagem redimensionada
                        ctx.drawImage(img, 0, 0, width, height);
 // Converte para Base64 (qualidade 0.9 para JPG)
                        const base64String = canvas.toDataURL('image/jpeg', 0.9);
 resolve(base64String);
                    };
                    img.onerror = (e) => reject(new Error('Erro ao carregar a imagem.'));
                    img.src = event.target.result;
                };
 reader.onerror = (e) => reject(new Error('Erro ao ler o arquivo.'));
                reader.readAsDataURL(file);
            });
        }

        window.handleImageUpload = async function(event, type) {
            const fileInput = event.target;
            const statusElement = document.getElementById(`photo-${type}-status`);
            statusElement.textContent = 'Processando e redimensionando foto... Aguarde.';
            statusElement.classList.remove('text-gray-600', 'text-green-600', 'text-red-600');
            // CORRIGIDO: Ciano/Azul
            statusElement.classList.add('text-cianoblue-600');
            if (fileInput.files.length === 0) {
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
                statusElement.textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                statusElement.classList.remove('text-cianoblue-600', 'text-red-600');
                statusElement.classList.add('text-gray-600');
                return;
            }

            const file = fileInput.files[0];
            const MAX_SIZE = 800; // Largura/Altura máxima em pixels

            try {
                const base64 = await resizeImageAndConvertToBase64(file, MAX_SIZE, MAX_SIZE);
                if (type === 'start') {
                    startPhotoBase64 = base64;
                } else {
                    endPhotoBase64 = base64;
                }
                
                // Exibe o tamanho aproximado (em KB)
                // Aproximação do tamanho: Base64 tem ~33% de overhead.
                const sizeKB = Math.round(base64.length * 0.75 / 1024);
                statusElement.textContent = `Foto anexada e redimensionada! (~${sizeKB} KB)`;
                statusElement.classList.remove('text-cianoblue-600', 'text-red-600');
                statusElement.classList.add('text-green-600');
            } catch (error) {
                console.error("Erro no processamento da imagem:", error);
                displayMessage('Erro ao processar a foto. Tente novamente ou use uma imagem menor.', 'error');
                statusElement.textContent = 'Erro ao processar a foto.';
                statusElement.classList.remove('text-cianoblue-600', 'text-green-600');
                statusElement.classList.add('text-red-600');
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
                fileInput.value = ''; // Limpa o input file
            }
        }


        // --- Funções de Estado e UI (Transições Atualizadas) ---

        function updateDriverUI(tripData = null) {
            if (tripData) {
                startTripForm.classList.add('hidden');
                tripInProgress.classList.remove('hidden');

                document.getElementById('current-driver-name').textContent = tripData.driverName;
                document.getElementById('current-license-plate').textContent = tripData.licensePlate;

                // Resetar campos e status de foto de chegada
                document.getElementById('km-end').value = '';
                document.getElementById('photo-end').value = '';
                document.getElementById('photo-end-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-end-status').classList.remove('text-cianoblue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-end-status').classList.add('text-gray-600');
                endPhotoBase64 = null;


                clearInterval(timerInterval);
                const startTimeMs = tripData.startTime.toDate().getTime();
                timerInterval = setInterval(() => {
                    const elapsedSeconds = Math.floor((Date.now() - startTimeMs) / 1000);
                    timerDisplay.textContent = formatTime(elapsedSeconds);
                }, 1000);
            } else {
                startTripForm.classList.remove('hidden');
                tripInProgress.classList.add('hidden');
                clearInterval(timerInterval);
                timerDisplay.textContent = '00:00:00';
                
                // Limpar todos os campos e variáveis temporárias de foto ao resetar a UI
                document.getElementById('driver-name').value = '';
                document.getElementById('license-plate').value = '';
                document.getElementById('km-start').value = '';
                document.getElementById('photo-start').value = '';
                document.getElementById('photo-start-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-start-status').classList.remove('text-cianoblue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-start-status').classList.add('text-gray-600');
                startPhotoBase64 = null;
            }
        }

        /**
         * FUNÇÃO CORRIGIDA para abrir o modal de forma animada.
         */
        window.viewPhoto = function(base64Data, caption) {
            if (base64Data) {
                modalImage.src = base64Data;
                modalCaption.textContent = caption;
                
                // Adiciona a classe 'visible' para iniciar as animações CSS
                photoModal.classList.remove('hidden');
                // Pequeno delay para garantir que o CSS 'hidden' seja removido antes de aplicar a animação
                setTimeout(() => {
                    photoModal.classList.add('visible');
                }, 10); 
            } else {
                displayMessage('Foto não disponível ou não anexada para esta rota.', 'error');
            }
        }
        
        /**
         * FUNÇÃO CORRIGIDA para fechar o modal de forma animada.
         */
        window.closePhotoModal = function() {
            // Remove a classe 'visible' para reverter a animação (fade-out e scale-down)
            photoModal.classList.remove('visible');
            // Remove o modal do fluxo após a animação ter tempo de rodar
            setTimeout(() => {
                photoModal.classList.add('hidden');
                modalImage.src = ''; // Limpa a imagem
            }, 300); // 300ms é a duração da transição CSS
        }


        function renderAdminTable(routes) {
            adminTableBody.innerHTML = ''; // Limpa a tabela

            if (routes.length === 0) {
                // Colspan ajustado para 13 colunas
                adminTableBody.innerHTML = '<tr><td colspan="13" class="p-4 text-center text-gray-500">Nenhuma rota concluída encontrada para o filtro atual.</td></tr>';
                return;
            }

            routes.forEach(route => {
                const totalKm = route.kmEnd ? (route.kmEnd - route.kmStart).toFixed(1) : 'N/A';
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const endTimeStr = route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A';
              
 
                const elapsedTimeStr = route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A';
                
                // USA o campo 'address' que agora é gerado e salvo na saída e chegada
                const startAddress = route.startLocation?.address || 'Endereço Indisponível';
                const endAddress = route.endLocation?.address || 'Endereço Indisponível';
     
                // Botões de Visualização de Foto
                // Cores ajustadas para o novo tema
                const startPhotoBtn = route.startPhoto 
                    ?
                    // CORRIGIDO: Ciano/Azul
                    `<button onclick="viewPhoto('${route.startPhoto}', 'Foto de Saída da Placa ${route.licensePlate}')" class="btn-base text-white bg-cianoblue-600 hover:bg-cianoblue-700 p-2 rounded-md text-sm" title="Ver Foto Saída"><i class="fas fa-eye"></i></button>`
         
                    : `<span class="text-gray-400 text-xs">Sem foto</span>`;
                // Cores ajustadas para o novo tema
                const endPhotoBtn = route.endPhoto
                    ?
                    // CORRIGIDO: Ciano/Azul
                    `<button onclick="viewPhoto('${route.endPhoto}', 'Foto de Chegada da Placa ${route.licensePlate}')" class="btn-base text-white bg-cianoblue-600 hover:bg-cianoblue-700 p-2 rounded-md text-sm" title="Ver Foto Chegada"><i class="fas fa-eye"></i></button>`
                    : `<span class="text-gray-400 text-xs">Sem foto</span>`;
                // Botão de Exclusão
                const deleteBtn = `
                    <button onclick="deleteRoute('${route.id}')" class="btn-base text-white bg-gray-700 hover:bg-gray-800 p-2 rounded-md text-sm" title="Excluir Rota">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
  
 
                `;
                const newRow = `
                    <tr class="hover:bg-cianoblue-50/50">
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${route.driverName}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">${route.licensePlate}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-bold text-cianoblue-700">${totalKm} km</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-cianoblue-600">${elapsedTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${startTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${endTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">${route.kmStart ? route.kmStart.toFixed(1) : 'N/A'}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-700">${route.kmEnd ? route.kmEnd.toFixed(1) : 'N/A'}</td>
                        <td class="px-2 py-4 text-sm text-gray-700 max-w-xs truncate" title="${startAddress}">${startAddress}</td>
                        <td class="px-2 py-4 text-sm text-gray-700 max-w-xs truncate" title="${endAddress}">${endAddress}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${startPhotoBtn}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${endPhotoBtn}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${deleteBtn}</td>
                    </tr>
                `;
                adminTableBody.insertAdjacentHTML('beforeend', newRow);
            });
        }

        // --- Lógica Principal (Mantida e com Estilo de Transição Atualizado) ---

        let allRoutesData = [];

        window.showDriverView = function() {
            // Gerencia a transição de visibilidade (fade-out do Admin, fade-in do Driver)
            adminView.classList.add('hidden');
            driverView.classList.remove('hidden');
            
            // Estilo ativo/inativo para os botões de navegação
            document.getElementById('show-driver-btn').classList.add('active');
            document.getElementById('show-admin-btn').classList.remove('active');

            listenForCurrentTrip();
        }

        window.showAdminView = function() {
             // Gerencia a transição de visibilidade (fade-out do Driver, fade-in do Admin)
            driverView.classList.add('hidden');
            adminView.classList.remove('hidden');
            
            // Estilo ativo/inativo para os botões de navegação
            document.getElementById('show-admin-btn').classList.add('active');
            document.getElementById('show-driver-btn').classList.remove('active');
            
            // Garante que o painel de rotas seja carregado se o admin já logou
            if (!adminDashboard.classList.contains('hidden')) {
                 listenForAdminRoutes();
            }
        }

        async function initFirebase() {
            try {
                // Se a configuração estiver vazia (problema de injeção), avisa e retorna
                if (Object.keys(firebaseConfig).length === 0) {
                    displayMessage('Erro: As configurações do Firebase estão vazias. Verifique o console.', 'error');
                    console.error("FIREBASE CONFIG FAILED: configuration was empty.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // Tenta fazer login com o token de autenticação personalizado fornecido
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Se o token não for fornecido, faz login anônimo
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        listenForCurrentTrip();
                        console.log(`Usuário logado: ${userId}`);
                    } else {
                        userId = null;
                        updateDriverUI(null);
                        console.log("Nenhum usuário logado.");
                    }
                });
            } catch (e) {
                console.error("Erro ao inicializar o Firebase:", e);
                displayMessage(`Falha ao inicializar o sistema. Recarregue a página. Erro: ${e.message}`, 'error');
            }
        }

        async function listenForCurrentTrip() {
            if (!db || !userId) return;

            const q = query(
                collection(db, ROUTES_COLLECTION_PATH),
                where('userId', '==', userId),
                where('status', '==', 'In Progress')
            );

            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    // Viagem em andamento encontrada
                    const tripDoc = snapshot.docs[0];
                    currentTripDocId = tripDoc.id;
                    localStorage.setItem('currentTripDocId', currentTripDocId);
                    updateDriverUI(tripDoc.data());
                } else {
                    // Nenhuma viagem em andamento
                    currentTripDocId = null;
                    localStorage.removeItem('currentTripDocId');
                    updateDriverUI(null);
                }
            }, (error) => {
                console.error("Erro ao buscar viagem em andamento:", error);
                updateDriverUI(null);
            });
        }

        async function listenForAdminRoutes() {
            if (!db) return;
            // Filtra apenas rotas 'Completed' para a visualização principal
            const q = query(
                collection(db, ROUTES_COLLECTION_PATH),
                where('status', '==', 'Completed')
            );
            onSnapshot(q, (snapshot) => {
                allRoutesData = [];
                snapshot.forEach((doc) => {
                    allRoutesData.push({ id: doc.id, ...doc.data() });
                });
                applyAdminFilters();
            }, (error) => {
                console.error("Erro ao monitorar rotas administrativas:", error);
                // Colspan alterado para 13 colunas
                adminTableBody.innerHTML = '<tr><td colspan="13" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            });
        }

        // Função para Excluir uma Rota
        window.deleteRoute = async function(routeId) {
            if (!db) {
                displayMessage('Sistema não inicializado.', 'error');
                return;
            }
            displayMessage(`Excluindo rota ID: ${routeId}...`, 'info');
            try {
                const routeRef = doc(db, ROUTES_COLLECTION_PATH, routeId);
                await deleteDoc(routeRef);
                displayMessage(`Rota ID ${routeId} excluída com sucesso! A tabela será atualizada.`, 'success');
            } catch (error) {
                console.error("Erro ao excluir documento:", error);
                displayMessage(`Falha ao excluir a rota. Erro: ${error.message}`, 'error');
            }
        }

        // --- Lógica do Motorista ---
        window.startTrip = async function() {
            if (!db || !userId) {
                displayMessage('Sistema não inicializado. Verifique a conexão com o Firebase.', 'error');
                return;
            }
            const driverName = document.getElementById('driver-name').value.trim();
            const licensePlate = document.getElementById('license-plate').value.trim().toUpperCase();
            const kmStart = parseFloat(document.getElementById('km-start').value);
            
            if (!driverName || !licensePlate || isNaN(kmStart) || kmStart <= 0) {
                displayMessage('Por favor, preencha todos os campos corretamente: Nome, Placa e KM Inicial válido (> 0).', 'error');
                return;
            }
            // VALIDAÇÃO OBRIGATÓRIA DA FOTO DE SAÍDA
            if (!startPhotoBase64) {
                displayMessage('A foto do painel/odômetro na SAÍDA é obrigatória. Por favor, anexe a foto.', 'error');
                return;
            }
            displayMessage('Buscando localização, endereço e salvando foto de saída...', 'info');
            try {
                const location = await getGeolocation();
                // 🚀 CORREÇÃO PARA SAÍDA: Usa a função corrigida para um endereço mais exato
                const address = await getStreetAndNeighborhood(location.lat, location.lon);
                const now = Timestamp.now();
                // Cria uma nova referência de documento
                const newRouteRef = doc(collection(db, ROUTES_COLLECTION_PATH));
                const newTripData = {
                    driverName: driverName,
                    licensePlate: licensePlate,
                    kmStart: kmStart,
                    startTime: now,
                    // 🚀 CORREÇÃO PARA SAÍDA: Salva o endereço completo no objeto startLocation
                    startLocation: { ...location, address: address }, 
                    startPhoto: startPhotoBase64,
                    userId: userId,
                    status: 'In Progress',
                    kmEnd: null,
                    endTime: null,
                    endLocation: null,
                    endPhoto: null,
                    elapsedTimeSeconds: null
                };
                await setDoc(newRouteRef, newTripData);
                // Salva o ID da viagem em andamento no localStorage
                currentTripDocId = newRouteRef.id;
                localStorage.setItem('currentTripDocId', currentTripDocId);
                // Limpa o base64 temporário da foto de saída
                startPhotoBase64 = null;
                document.getElementById('photo-start').value = '';
                
                displayMessage(`Viagem iniciada com sucesso em ${address} (com foto)!`, 'success');
            } catch (error) {
                console.error("Erro ao iniciar a viagem:", error);
                displayMessage(`Falha ao registrar saída. ${error.message || 'Verifique o console para detalhes.'} Atenção: Se a foto for muito grande, mesmo redimensionada, pode ocorrer erro.`, 'error');
            }
        }

        window.endTrip = async function() {
            if (!db || !currentTripDocId) {
                displayMessage('Nenhuma viagem em andamento para finalizar.', 'error');
                return;
            }
            const kmEnd = parseFloat(document.getElementById('km-end').value);
            if (isNaN(kmEnd) || kmEnd <= 0) {
                displayMessage('Por favor, insira um KM Final válido.', 'error');
                return;
            }
            // VALIDAÇÃO OBRIGATÓRIA DA FOTO DE CHEGADA
            if (!endPhotoBase64) {
                displayMessage('A foto do painel/odômetro na CHEGADA é obrigatória. Por favor, anexe a foto.', 'error');
                return;
            }
            displayMessage('Buscando localização final, endereço e salvando foto de chegada...', 'info');
            try {
                const docRef = doc(db, ROUTES_COLLECTION_PATH, currentTripDocId);
                // Busca o documento atual para obter o KM inicial e o tempo de início
                const currentTripSnapshot = await getDocs(query(collection(db, ROUTES_COLLECTION_PATH), where('__name__', '==', currentTripDocId)));
                if (currentTripSnapshot.empty) {
                    displayMessage('Viagem não encontrada no banco de dados. Limpando estado local.', 'error');
                    localStorage.removeItem('currentTripDocId');
                    currentTripDocId = null;
                    return;
                }
                const currentTripData = currentTripSnapshot.docs[0].data();
                if (kmEnd < currentTripData.kmStart) {
                    displayMessage(`O KM Final (${kmEnd}) deve ser maior que o KM Inicial (${currentTripData.kmStart}).`, 'error');
                    return;
                }
                const endLocation = await getGeolocation();
                // 🚀 CORREÇÃO PARA CHEGADA: Usa a função corrigida para um endereço mais exato
                const endAddress = await getStreetAndNeighborhood(endLocation.lat, endLocation.lon);
                const endTime = Timestamp.now();
                const startTimeMs = currentTripData.startTime.toDate().getTime();
                const elapsedTimeSeconds = Math.floor((endTime.toDate().getTime() - startTimeMs) / 1000);
                const updateData = {
                    kmEnd: kmEnd,
                    endTime: endTime,
                    // 🚀 CORREÇÃO PARA CHEGADA: Salva o endereço completo no objeto endLocation
                    endLocation: { ...endLocation, address: endAddress }, 
                    elapsedTimeSeconds: elapsedTimeSeconds,
                    endPhoto: endPhotoBase64,
                    status: 'Completed',
                };
                await updateDoc(docRef, updateData);
                // Limpa o estado local
                localStorage.removeItem('currentTripDocId');
                currentTripDocId = null;
                endPhotoBase64 = null;
                // Limpa a foto temporária de CHEGADA
                document.getElementById('photo-end').value = '';
                // Limpa o input file
                displayMessage(`Viagem finalizada com sucesso em ${endAddress} (com foto)! Tempo: ${formatTime(elapsedTimeSeconds)}`, 'success');
            } catch (error) {
                console.error("Erro ao finalizar a viagem:", error);
                displayMessage(`Falha ao registrar chegada. ${error.message || 'Verifique o console para detalhes.'} Atenção: Se a foto for muito grande, mesmo redimensionada, pode ocorrer erro.`, 'error');
            }
        }

        // --- Lógica Administrativa ---
        window.adminLogin = function() {
            const password = document.getElementById('admin-password').value;
            loginErrorMessage.classList.add('hidden');

            if (password === ADMIN_PASSWORD) {
                adminLoginArea.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                listenForAdminRoutes();
                displayMessage('Acesso Administrativo concedido.', 'success');
            } else {
                loginErrorMessage.classList.remove('hidden');
                displayMessage('Senha incorreta.', 'error');
            }
        }

        window.applyAdminFilters = function() {
            const plate = document.getElementById('filter-plate').value.trim().toUpperCase();
            const startDateStr = document.getElementById('filter-start-date').value;
            const endDateStr = document.getElementById('filter-end-date').value;
            let filteredData = allRoutesData;

            if (plate) {
                filteredData = filteredData.filter(route => route.licensePlate.includes(plate));
            }

            if (startDateStr) {
                const startOfDay = new Date(startDateStr);
                startOfDay.setHours(0, 0, 0, 0);
                const startTimestamp = startOfDay.getTime();
                filteredData = filteredData.filter(route => route.startTime && route.startTime.toDate().getTime() >= startTimestamp );
            }

            if (endDateStr) {
                const endOfDay = new Date(endDateStr);
                endOfDay.setHours(23, 59, 59, 999);
                const endTimestamp = endOfDay.getTime();
                filteredData = filteredData.filter(route => route.startTime && route.startTime.toDate().getTime() <= endTimestamp );
            }

            // Ordena os dados pela hora de início (mais recente primeiro)
            filteredData.sort((a, b) => b.startTime.toMillis() - a.startTime.toMillis());
            renderAdminTable(filteredData);
        }

        window.exportToCSV = function() {
            // Usa os dados atualmente filtrados
            const routesToExport = allRoutesData.filter(route => {
                // Lógica de filtro re-aplicada para exportação
                const plate = document.getElementById('filter-plate').value.trim().toUpperCase();
                const startDateStr = document.getElementById('filter-start-date').value;
                const endDateStr = document.getElementById('filter-end-date').value;

                let matchesPlate = plate ? route.licensePlate.includes(plate) : true;
                
                let matchesStartDate = true;
                if (startDateStr) {
                    const startOfDay = new Date(startDateStr);
                    matchesStartDate = route.startTime && route.startTime.toDate().getTime() >= startOfDay.setHours(0, 0, 0, 0);
                }

                let matchesEndDate = true;
                if (endDateStr) {
                    const endOfDay = new Date(endDateStr);
                    matchesEndDate = route.startTime && route.startTime.toDate().getTime() <= endOfDay.setHours(23, 59, 59, 999);
                }
                
                return matchesPlate && matchesStartDate && matchesEndDate;
            }).map(route => {
                const totalKm = route.kmEnd ? (route.kmEnd - route.kmStart).toFixed(1) : 'N/A';
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const endTimeStr = route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const elapsedTimeStr = route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A';
                
                // Endereço completo
                const startAddress = route.startLocation?.address || 'N/A';
                const endAddress = route.endLocation?.address || 'N/A';
                
                // Coordenadas mantidas para referência na exportação
                const startLat = route.startLocation ? route.startLocation.lat : 'N/A';
                const startLon = route.startLocation ? route.startLocation.lon : 'N/A';
                const endLat = route.endLocation ? route.endLocation.lat : 'N/A';
                const endLon = route.endLocation ? route.endLocation.lon : 'N/A';

                // NOTA: Base64 é muito grande
                const startPhotoRef = route.startPhoto ? 'Anexado (Base64)' : 'N/A';
                const endPhotoRef = route.endPhoto ? 'Anexado (Base64)' : 'N/A';

                return [
                    route.driverName,
                    route.licensePlate,
                    startTimeStr,
                    endTimeStr,
                    startPhotoRef,
                    endPhotoRef,
                    totalKm,
                    elapsedTimeStr,
                    route.kmStart,
                    route.kmEnd,
                    startAddress, // Endereço Completo
                    endAddress,   // Endereço Completo
                    startLat,
                    startLon,
                    endLat,
                    endLon
                ].map(item => `"${item}"`).join(';'); // Delimitador CSV
            });

            const header = [
                "Motorista", "Placa", "Data_Saida", "Data_Chegada", "Foto_Saida", 
                "Foto_Chegada", "KM_Total_Rodado", "Tempo_Decorrido", "KM_Inicial", 
                "KM_Final", "Local_Saida_Endereco", "Local_Chegada_Endereco", "Local_Saida_Lat", 
                "Local_Saida_Lon", "Local_Chegada_Lat", "Local_Chegada_Lon"
            ];

            const csvContent = [header.join(';'), ...routesToExport].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `rotas_exportadas_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            displayMessage('Dados exportados com sucesso!', 'success');
        }

        // Event Listeners para navegação
        document.getElementById('show-driver-btn').addEventListener('click', window.showDriverView);
        document.getElementById('show-admin-btn').addEventListener('click', window.showAdminView);

        // Inicia o sistema
        initFirebase().then(() => {
            // Garante que o Driver View é a visão inicial
            window.showDriverView();
        });
    </script>
</body>
</html>
