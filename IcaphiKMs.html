<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IcaphiDrive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #3b82f6; 
            --accent: #06b6d4;
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --neon-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }
        
        body { 
            background-color: #020617; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(29, 78, 216, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(6, 182, 212, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc; 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            -webkit-tap-highlight-color: transparent;
        }

        /* Efeito de Vidro (Glassmorphism) */
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .modal-container { 
            position: relative; 
            width: 95%; 
            max-width: 420px; 
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 30px; 
            padding: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
            margin: auto; 
            overflow: hidden;
        }

        /* Inputs Modernos */
        .input-style { 
            background: rgba(30, 41, 59, 0.6) !important; 
            border: 1px solid rgba(255, 255, 255, 0.05) !important; 
            color: #fff !important; 
            width: 100%; 
            padding: 18px; 
            border-radius: 18px; 
            outline: none; 
            font-size: 15px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-style:focus { 
            background: rgba(30, 41, 59, 0.9) !important;
            border-color: var(--primary) !important; 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); 
            transform: translateY(-2px);
        }

        /* Bot√£o Neon Principal */
        .btn-primary { 
            background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
            border-radius: 20px; 
            font-weight: 800; 
            color: white; 
            padding: 20px; 
            text-transform: uppercase; 
            width: 100%; 
            letter-spacing: 1.5px; 
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 10px 25px -5px rgba(8, 145, 178, 0.4);
        }
        .btn-primary:active { transform: scale(0.96); box-shadow: 0 5px 15px -5px rgba(8, 145, 178, 0.4); }
        .btn-primary::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-primary:hover::after { left: 100%; }

        /* Bot√µes de Filtro e A√ß√£o */
        .btn-icon-glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            transition: all 0.3s;
        }
        .btn-icon-glass:active { transform: scale(0.90); background: rgba(255, 255, 255, 0.1); }

        /* Filtros Admin */
        .filter-btn { 
            padding: 10px 20px; 
            border-radius: 24px; 
            font-size: 11px; 
            font-weight: 700; 
            text-transform: uppercase; 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #94a3b8; 
            background: rgba(15, 23, 42, 0.5);
            transition: all 0.3s ease;
            position: relative;
        }
        .filter-btn.active { 
            background: rgba(37, 99, 235, 0.2); 
            color: #60a5fa; 
            border-color: #3b82f6; 
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        /* Card Admin */
        .admin-card { 
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 24px; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 24px; 
            margin-bottom: 20px; 
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .admin-card::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(to bottom, #10b981, #059669);
        }
        .admin-card.em-curso::before { background: linear-gradient(to bottom, #f59e0b, #d97706); }

        /* Loader */
        #main-loader { position: fixed; inset: 0; background: #020617; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-ring { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Anima√ß√£o do Sino */
        @keyframes pulse-red { 
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); transform: scale(1); }
        }
        .pulsing { animation: pulse-red 2s infinite; color: #fbbf24 !important; border-color: #fbbf24 !important; background: rgba(251, 191, 36, 0.1) !important; }

        /* Tabelas */
        .table-header { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: 700; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .table-cell { padding: 16px; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); color: #e2e8f0; }

        /* Layout PC */
        .w-full-pc { max-width: 100% !important; padding: 40px; }
        .grid-pc { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 24px; }
        
        /* Checkbox Customizada (File Input) */
        .file-box {
            border: 2px dashed rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.02);
            transition: all 0.3s;
        }
        .file-box:hover, .file-box.attached {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.05);
        }

    </style>
</head>
<body class="p-4 selection:bg-blue-500 selection:text-white">
    
    <div id="main-loader">
        <div class="loader-ring"></div>
        <p class="mt-6 text-xs font-bold text-blue-500 uppercase tracking-[4px] animate-pulse">Iniciando Sistema...</p>
    </div>

    <div id="app-wrap" class="max-w-[420px] mx-auto relative z-10 transition-all duration-500">
        
        <header class="flex justify-between items-center py-6 mb-4">
            <div>
                <h1 class="text-3xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-600 uppercase tracking-tight" style="text-shadow: 0 0 20px rgba(59,130,246,0.3);">ICAPHIDRIVE</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-1 ml-1">By: Matheus Julio</p>
            </div>
            <div class="flex gap-3">
                <button onclick="alternarModoPC()" class="p-3 btn-icon-glass text-slate-400 hover:text-white hover:bg-white/10"><i data-lucide="monitor" class="w-5 h-5"></i></button>
                <button id="btn-sino" onclick="abrirModalNotif()" class="p-3 btn-icon-glass text-slate-400 hover:text-white hover:bg-white/10 relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notif-badge" class="hidden absolute top-2 right-2 w-2.5 h-2.5 bg-yellow-500 rounded-full shadow-[0_0_10px_#eab308]"></span>
                </button>
                <button onclick="acessoAdmin()" class="p-3 btn-icon-glass text-slate-400 hover:text-white hover:bg-white/10"><i data-lucide="shield-check" class="w-5 h-5"></i></button>
            </div>
        </header>

        <main id="tela-inicio" class="space-y-6">
            <div class="modal-container">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-lg font-black uppercase flex items-center gap-2 text-white tracking-wide"><i data-lucide="zap" class="text-cyan-400 fill-cyan-400/20"></i> Nova Rota</h2>
                    <button onclick="document.getElementById('modal-extrato-login').classList.remove('hidden')" class="px-4 py-2 rounded-full text-[10px] font-bold uppercase text-cyan-400 border border-cyan-500/30 bg-cyan-950/30 hover:bg-cyan-900/50 hover:border-cyan-400 transition-all">Hist√≥rico</button>
                </div>
                <div class="space-y-5">
                    <div class="relative">
                        <select id="tipo-servico" class="input-style appearance-none">
                            <option>Saida Dia</option>
                            <option>Apoio</option>
                            <option>Segunda Viagem</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-4 top-5 text-slate-500 pointer-events-none w-5 h-5"></i>
                    </div>
                    
                    <input type="text" id="motorista" placeholder="Nome do Condutor" class="input-style placeholder-slate-500">
                    <input type="text" id="placa" placeholder="PLACA DO VE√çCULO" class="input-style uppercase tracking-widest font-bold placeholder-slate-500">
                    <input type="number" id="km-inicio" placeholder="KM Painel" class="input-style placeholder-slate-500">
                    
                    <label id="lbl-foto-inicio" class="file-box flex flex-col items-center justify-center w-full h-32 rounded-2xl cursor-pointer group">
                        <div class="p-3 bg-slate-800/50 rounded-full mb-2 group-hover:bg-cyan-500 group-hover:text-white transition-colors text-slate-400 border border-white/5 shadow-lg">
                            <i data-lucide="camera" class="w-6 h-6"></i>
                        </div>
                        <span id="txt-foto" class="text-[10px] font-bold text-slate-400 uppercase group-hover:text-white transition-colors">Anexar Foto do Painel</span>
                        <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto', 'lbl-foto-inicio')">
                    </label>
                    
                    <button onclick="iniciarViagem()" class="btn-primary mt-2">INICIAR AGORA</button>
                </div>
            </div>
            
            <button onclick="document.getElementById('modal-tutorial').classList.remove('hidden')" class="w-full py-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-[2px] hover:text-white transition-colors opacity-70 hover:opacity-100 flex items-center justify-center gap-2">
                <i data-lucide="help-circle" class="w-4 h-4"></i> Como usar o App?
            </button>
        </main>

        <main id="tela-em-curso" class="hidden space-y-6">
            <div class="modal-container text-center border-amber-500/20 shadow-[0_0_30px_-10px_rgba(245,158,11,0.2)]">
                <div class="flex items-center justify-center gap-2 mb-6 bg-amber-500/10 py-2 rounded-full border border-amber-500/20 inline-block px-6 mx-auto">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse shadow-[0_0_10px_#f59e0b]"></div>
                    <p id="info-viagem-ativa" class="text-amber-500 font-black text-[10px] uppercase tracking-widest"></p>
                </div>
                
                <div class="py-12 bg-black/40 rounded-[30px] mb-8 border border-white/5 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-tr from-amber-500/10 to-transparent opacity-50"></div>
                    <div id="cronometro-motorista" class="relative text-6xl font-black tracking-tighter text-white font-[monospace] drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]">00:00:00</div>
                    <p class="relative text-[9px] text-slate-400 font-bold uppercase mt-3 tracking-widest">Tempo em Rota</p>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-8">
                    <button onclick="document.getElementById('modal-complementos').classList.remove('hidden')" class="p-4 bg-slate-800/40 hover:bg-slate-700/60 rounded-2xl font-bold text-[10px] uppercase border border-white/10 text-slate-300 transition-all hover:scale-[1.02]">
                        <i data-lucide="plus-circle" class="w-5 h-5 mx-auto mb-2 text-blue-400"></i> Ocorr√™ncia / Abastecer
                    </button>
                    <button onclick="location.reload()" class="p-4 bg-slate-800/40 hover:bg-slate-700/60 rounded-2xl font-bold text-[10px] uppercase border border-white/10 text-slate-300 transition-all hover:scale-[1.02]">
                        <i data-lucide="refresh-cw" class="w-5 h-5 mx-auto mb-2 text-emerald-400"></i> Sincronizar
                    </button>
                </div>

                <div class="bg-slate-900/40 p-5 rounded-[24px] border border-white/5">
                    <input type="number" id="km-fim" placeholder="Digite KM Final" class="input-style text-center mb-4 text-xl font-bold bg-black/20 !border-slate-700">
                    
                    <label id="lbl-foto-fim" class="file-box flex flex-col items-center justify-center w-full h-24 rounded-xl mb-6 cursor-pointer">
                        <div class="flex items-center gap-2 text-slate-400">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            <span id="txt-foto-fim" class="text-[10px] font-bold uppercase">Foto do Painel (Chegada)</span>
                        </div>
                        <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto-fim', 'lbl-foto-fim')">
                    </label>
                    
                    <button onclick="encerrarViagem()" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 p-5 rounded-2xl font-black uppercase text-white shadow-[0_10px_30px_-10px_rgba(220,38,38,0.5)] transition-all transform hover:scale-[1.02] text-sm tracking-wider">
                        FINALIZAR AGORA
                    </button>
                </div>
            </div>
        </main>

        <main id="tela-admin" class="hidden pb-32">
            <div class="sticky top-0 bg-[#020617]/90 backdrop-blur-md py-4 z-50 px-2 -mx-2 mb-6 border-b border-white/5">
                <div class="flex justify-between items-center mb-6">
                    <button onclick="mudarTela('inicio')" class="px-4 py-2 bg-slate-800/50 border border-white/10 rounded-xl text-slate-300 text-xs font-bold uppercase hover:bg-white/10 transition-all flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Voltar</button>
                    <div class="flex gap-2">
                        <button onclick="abrirModalGerarCodigo()" class="w-10 h-10 flex items-center justify-center text-cyan-400 bg-cyan-500/10 rounded-xl border border-cyan-500/20 hover:bg-cyan-500/20 transition-all"><i data-lucide="key" class="w-5 h-5"></i></button>
                        <button onclick="abrirModalNotifAdmin()" class="w-10 h-10 flex items-center justify-center text-amber-500 bg-amber-500/10 rounded-xl border border-amber-500/20 hover:bg-amber-500/20 transition-all"><i data-lucide="megaphone" class="w-5 h-5"></i></button>
                        <button onclick="document.getElementById('modal-export').classList.remove('hidden')" class="w-10 h-10 flex items-center justify-center text-emerald-500 bg-emerald-500/10 rounded-xl border border-emerald-500/20 hover:bg-emerald-500/20 transition-all"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div class="flex gap-2 mb-5 overflow-x-auto pb-2 scrollbar-hide">
                    <button onclick="filtrarStatus('todos')" id="filt-todos" class="filter-btn active">Todos</button>
                    <button onclick="filtrarStatus('em_curso')" id="filt-em_curso" class="filter-btn">Em Rota</button>
                    <button onclick="filtrarStatus('finalizada')" id="filt-finalizada" class="filter-btn">Finalizados</button>
                </div>

                <div class="relative">
                    <i data-lucide="search" class="absolute left-4 top-4 text-slate-500 w-5 h-5"></i>
                    <input type="text" id="busca-admin" oninput="renderizarAdmin()" placeholder="Buscar motorista, placa..." class="input-style !pl-12 !py-3 !text-sm !rounded-xl">
                </div>
            </div>
            <div id="lista-viagens" class="space-y-4"></div>
        </main>

        <div id="modal-sucesso-viagem" class="hidden fixed inset-0 flex items-center justify-center glass z-[5000]">
            <div class="modal-container text-center border-emerald-500/30 shadow-[0_0_50px_-10px_rgba(16,185,129,0.3)]">
                <div class="w-24 h-24 bg-gradient-to-tr from-emerald-500 to-emerald-300 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-emerald-500/30">
                    <i data-lucide="check" class="text-white w-12 h-12"></i>
                </div>
                <h3 class="text-2xl font-black text-white uppercase mb-2 tracking-tight">Viagem Conclu√≠da!</h3>
                <p class="text-slate-400 text-sm mb-8">Dados sincronizados com seguran√ßa.</p>
                
                <button id="btn-share-wpp" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold uppercase p-5 rounded-2xl flex items-center justify-center gap-3 mb-4 shadow-lg shadow-emerald-900/20 transition-transform hover:scale-[1.02]">
                    <i data-lucide="message-circle" class="w-6 h-6"></i> Enviar Relat√≥rio WhatsApp
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-800/50 hover:bg-slate-700 text-slate-300 font-bold uppercase p-4 rounded-2xl border border-white/5 transition-colors">
                    Voltar ao In√≠cio
                </button>
            </div>
        </div>

        <div id="modal-tutorial" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]">
            <div class="modal-container !max-w-md h-[85vh] flex flex-col p-0 bg-[#0f172a]">
                <div class="p-6 border-b border-white/10 bg-slate-900/50 flex justify-between items-center">
                    <h3 class="font-black text-blue-400 uppercase text-lg tracking-wider">Manual do Motorista</h3>
                    <button onclick="fecharModal('modal-tutorial')" class="p-2 bg-white/5 rounded-full hover:bg-white/10"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="overflow-y-auto p-6 space-y-8 custom-scroll">
                    
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold text-white text-sm">1</div>
                            <div class="w-0.5 h-full bg-blue-500/30 my-2"></div>
                        </div>
                        <div>
                            <h4 class="text-white font-bold uppercase text-sm mb-2">Iniciar Viagem</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">
                                Preencha o tipo de servi√ßo (ex: Sa√≠da Dia), nome, placa e o KM do painel. <br>
                                <span class="text-blue-400">Obrigat√≥rio:</span> Tire uma foto n√≠tida do painel mostrando o KM atual e clique em <b>"Iniciar Agora"</b>.
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-amber-500 flex items-center justify-center font-bold text-white text-sm">2</div>
                            <div class="w-0.5 h-full bg-amber-500/30 my-2"></div>
                        </div>
                        <div>
                            <h4 class="text-white font-bold uppercase text-sm mb-2">Durante a Rota</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">
                                O app conta o tempo automaticamente. Se precisar registrar abastecimento ou paradas, clique no bot√£o <b class="text-slate-200">"Ocorr√™ncia / Abastecer"</b> e preencha os detalhes.
                            </p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full bg-emerald-500 flex items-center justify-center font-bold text-white text-sm">3</div>
                        </div>
                        <div>
                            <h4 class="text-white font-bold uppercase text-sm mb-2">Finalizar e Compartilhar</h4>
                            <p class="text-slate-400 text-xs leading-relaxed">
                                Ao chegar, digite o KM Final e tire a foto de encerramento. Clique em <b>"Finalizar Agora"</b>.<br><br>
                                Uma tela verde aparecer√°. Clique no bot√£o grande do <b>WhatsApp</b> para enviar o relat√≥rio completo (KMs, Hor√°rios e Totais) para o gestor.
                            </p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div id="modal-tabela-extrato" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]">
            <div class="modal-container !max-w-3xl h-[85vh] flex flex-col p-0 overflow-hidden bg-[#0f172a]">
                <div class="p-5 border-b border-white/10 flex justify-between items-center bg-slate-900/80 backdrop-blur-md">
                    <div>
                        <h3 class="text-white font-black uppercase text-sm">Hist√≥rico de Viagens</h3>
                        <p id="extrato-placa-titulo" class="text-[10px] text-cyan-400 font-bold uppercase mt-1 tracking-wider">Carregando...</p>
                    </div>
                    <button onclick="fecharModal('modal-tabela-extrato')" class="p-2 hover:bg-white/10 rounded-full transition-colors"><i data-lucide="x" class="text-slate-400"></i></button>
                </div>
                <div class="flex-1 overflow-auto bg-slate-950/50">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-900/90 sticky top-0 z-10 backdrop-blur-sm">
                            <tr>
                                <th class="table-header">Data / Tipo</th>
                                <th class="table-header text-center">KM Ini</th>
                                <th class="table-header text-center">KM Fim</th>
                                <th class="table-header text-center text-cyan-400">Total</th>
                                <th class="table-header text-center">Fotos</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-extrato" class="divide-y divide-white/5"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass z-[1800]">
            <div class="modal-container">
                <div class="flex justify-between mb-6">
                    <h3 class="text-emerald-400 font-bold uppercase text-sm">Gerenciar Dados</h3>
                    <button onclick="fecharModal('modal-export')"><i data-lucide="x" class="text-slate-400"></i></button>
                </div>
                <p class="text-[10px] text-slate-400 mb-2 uppercase font-bold">Selecione o Per√≠odo:</p>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <input type="date" id="data-exp-inicio" class="input-style !p-3 text-center">
                    <input type="date" id="data-exp-fim" class="input-style !p-3 text-center">
                </div>
                <button onclick="gerarExcel()" class="btn-primary !bg-none !bg-emerald-600 hover:!bg-emerald-500 mb-3 shadow-lg shadow-emerald-900/40">BAIXAR RELAT√ìRIO EXCEL</button>
                <button onclick="excluirPeriodoSelecionado()" class="w-full py-4 border border-red-500/30 bg-red-500/10 text-red-400 rounded-xl text-[10px] font-bold uppercase hover:bg-red-500/20 transition-colors flex items-center justify-center gap-2"><i data-lucide="trash" class="w-4 h-4"></i> Excluir este per√≠odo</button>
            </div>
        </div>

        <div id="modal-gerar-codigo" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]">
            <div class="modal-container text-center">
                <i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-gerar-codigo')"></i>
                <h3 class="text-cyan-400 font-black uppercase text-sm mb-6">Gerar Senha de Acesso</h3>
                <select id="gc-placa-select" class="input-style mb-4 font-bold text-center appearance-none"></select>
                <div id="display-codigo-gerado" class="hidden py-6 bg-black/40 rounded-2xl text-6xl font-black text-white tracking-[12px] mb-4 border border-cyan-500/30 shadow-[0_0_30px_-5px_rgba(6,182,212,0.3)] font-mono">0000</div>
                <button onclick="processarGeracaoCodigo()" class="btn-primary mt-2">GERAR C√ìDIGO</button>
            </div>
        </div>

        <div id="modal-extrato-login" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]">
            <div class="modal-container text-center">
                <i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-extrato-login')"></i>
                <h3 class="text-white font-black uppercase text-lg mb-6 tracking-wide">√Årea Restrita</h3>
                <input type="text" id="login-placa-manual" placeholder="PLACA DO VE√çCULO" class="input-style mb-3 text-center uppercase font-bold tracking-widest">
                <input type="tel" id="login-codigo" placeholder="C√ìDIGO (4 D√≠gitos)" class="input-style mb-8 text-center tracking-[10px] font-bold text-xl" maxlength="4">
                <button onclick="validarAcessoExtrato()" class="btn-primary">ACESSAR DADOS</button>
            </div>
        </div>

        <div id="modal-gerenciar-notif" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]">
            <div class="modal-container">
                <div class="flex justify-between mb-4"><h3 class="font-bold uppercase text-amber-500">Novo Aviso</h3><i data-lucide="x" class="text-slate-400 cursor-pointer" onclick="fecharModal('modal-gerenciar-notif')"></i></div>
                <textarea id="notif-texto" placeholder="Escreva o comunicado para os motoristas..." class="input-style h-28 mb-4 resize-none"></textarea>
                <button onclick="salvarNotificacao()" class="btn-primary !bg-none !bg-amber-600 hover:!bg-amber-500 mb-6 text-white shadow-amber-900/40">ENVIAR AVISO</button>
                <p class="text-[10px] text-slate-500 uppercase font-bold mb-2">Avisos Ativos:</p>
                <div id="lista-notif-admin" class="max-h-40 overflow-auto space-y-2 pr-2 custom-scroll"></div>
            </div>
        </div>

        <div id="modal-notificacoes" class="hidden fixed inset-0 flex items-center justify-center glass z-[3500]">
            <div class="modal-container h-[60vh] flex flex-col">
                <div class="flex justify-between mb-6"><h3 class="font-black text-amber-500 uppercase text-lg">Mural de Avisos</h3><i data-lucide="x" class="text-slate-400 cursor-pointer" onclick="fecharModal('modal-notificacoes')"></i></div>
                <div id="lista-notificacoes-motorista" class="space-y-3 overflow-y-auto pr-2"></div>
            </div>
        </div>

        <div id="modal-gps" class="hidden fixed inset-0 flex items-center justify-center glass z-[4000]"><div class="modal-container !max-w-3xl h-[80vh] flex flex-col p-0 bg-white"><div class="bg-slate-900 p-4 flex justify-between items-center"><span class="text-white font-bold uppercase text-xs">Localiza√ß√£o GPS</span><i data-lucide="x" class="cursor-pointer text-white" onclick="fecharModal('modal-gps')"></i></div><iframe id="gps-iframe" class="w-full h-full" frameborder="0"></iframe></div></div>
        <div id="modal-foto" class="hidden fixed inset-0 flex items-center justify-center glass z-[4500]"><div class="modal-container !p-0 bg-black overflow-hidden flex items-center justify-center w-full h-full max-w-none rounded-none"><i data-lucide="x" class="absolute top-6 right-6 text-white w-10 h-10 cursor-pointer bg-black/50 rounded-full p-2 backdrop-blur-md" onclick="fecharModal('modal-foto')"></i><img id="foto-view" class="max-w-full max-h-full object-contain"></div></div>
        <div id="modal-ver-obs" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container h-[60vh] flex flex-col"><div class="flex justify-between mb-4"><h3 class="font-bold text-blue-500 uppercase text-sm">Ocorr√™ncias da Viagem</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-ver-obs')"></i></div><div id="conteudo-obs-admin" class="space-y-3 overflow-auto"></div></div></div>
        <div id="modal-complementos" class="hidden fixed inset-0 flex items-center justify-center glass z-[1500]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="font-bold uppercase text-sm text-white">Adicionar Evento</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-complementos')"></i></div><select id="comp-tipo" class="input-style mb-4 appearance-none"><option>Observa√ß√£o Geral</option><option>Abastecimento</option><option>Ped√°gio</option><option>Pneu Furado</option><option>Parada Policial</option></select><textarea id="comp-obs" placeholder="Descreva os detalhes (litros, valor, local)..." class="input-style h-28 mb-6"></textarea><button onclick="salvarObservacaoMotorista()" class="btn-primary">SALVAR REGISTRO</button></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc, updateDoc, Timestamp, arrayUnion, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U", authDomain: "marcador-ponto-digital.firebaseapp.com", projectId: "marcador-ponto-digital", storageBucket: "marcador-ponto-digital.firebasestorage.app", messagingSenderId: "774324665760", appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let listaGlobalViagens = [], listaNotificacoes = [];
        let filtroAdminAtual = 'todos'; 
        let isFirstLoadNotif = true;

        // UI Utils
        window.fecharModal = (id) => document.getElementById(id).classList.add('hidden');
        window.mudarTela = (t) => { document.querySelectorAll('main').forEach(m => m.classList.add('hidden')); document.getElementById('tela-' + t).classList.remove('hidden'); lucide.createIcons(); };
        window.fotoTirada = (idTxt, idContainer) => { 
            const el = document.getElementById(idTxt); 
            const box = document.getElementById(idContainer);
            el.innerText = 'FOTO ANEXADA COM SUCESSO'; 
            el.classList.add('text-emerald-400');
            el.classList.remove('text-slate-400');
            box.classList.add('attached', 'border-emerald-500/50', 'bg-emerald-500/10');
        };
        const showLoader = () => document.getElementById('main-loader').style.opacity = '1';
        const hideLoader = () => {
            const l = document.getElementById('main-loader');
            l.style.opacity = '0';
            setTimeout(() => l.style.display = 'none', 500);
        };

        window.alternarModoPC = () => {
            const wrap = document.getElementById('app-wrap');
            const lista = document.getElementById('lista-viagens');
            if (wrap.classList.contains('max-w-[420px]')) {
                wrap.classList.remove('max-w-[420px]'); wrap.classList.add('w-full-pc');
                lista.classList.add('grid-pc'); lista.classList.remove('space-y-4');
            } else {
                wrap.classList.add('max-w-[420px]'); wrap.classList.remove('w-full-pc');
                lista.classList.remove('grid-pc'); lista.classList.add('space-y-4');
            }
        };

        window.filtrarStatus = (status) => {
            filtroAdminAtual = status;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('filt-' + status).classList.add('active');
            renderizarAdmin();
        };

        window.renderizarAdmin = () => {
            const container = document.getElementById('lista-viagens');
            const busca = document.getElementById('busca-admin').value.toLowerCase();
            container.innerHTML = "";
            
            const filtradas = listaGlobalViagens.filter(v => {
                const matchTexto = (v.nome||'').toLowerCase().includes(busca) || (v.placa||'').toLowerCase().includes(busca);
                const matchStatus = filtroAdminAtual === 'todos' ? true : v.status === filtroAdminAtual;
                return matchTexto && matchStatus;
            });

            if(filtradas.length === 0) container.innerHTML = "<p class='text-center text-slate-500 text-xs py-10 uppercase tracking-widest'>Nenhum registro encontrado.</p>";

            filtradas.forEach(v => {
                const isE = v.status === 'em_curso';
                container.innerHTML += `
                <div class="admin-card ${isE ? 'em-curso' : ''} group hover:transform hover:scale-[1.01]">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-wider mb-2 inline-block ${isE ? 'bg-amber-500/20 text-amber-500' : 'bg-emerald-500/20 text-emerald-500'}">
                                ${isE ? 'EM ROTA' : 'FINALIZADA'} ‚Ä¢ ${v.tipoServico}
                            </span>
                            <h2 class="text-xl font-black uppercase text-white leading-none tracking-tight">${v.nome}</h2>
                            <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase">${v.placa} ‚Ä¢ ${v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleDateString() : ''}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="compartilharWpp('${v.id}')" class="text-emerald-400 bg-emerald-500/10 p-2 rounded-xl hover:bg-emerald-500/20 transition-colors"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                             <button onclick="excluirCard('${v.id}')" class="text-red-400 bg-red-500/10 p-2 rounded-xl hover:bg-red-500/20 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center mb-5 bg-black/20 p-4 rounded-2xl border border-white/5">
                        <div><p class="text-[8px] text-slate-500 uppercase font-bold mb-1">In√≠cio</p><p class="font-bold text-white text-lg">${v.kmInicio}</p></div>
                        <div class="border-l border-white/5"><p class="text-[8px] text-slate-500 uppercase font-bold mb-1">Fim</p><p class="font-bold text-white text-lg">${v.kmFim || '--'}</p></div>
                        <div class="border-l border-white/5"><p class="text-[8px] text-cyan-500 uppercase font-bold mb-1">Total</p><p class="font-bold text-cyan-400 text-lg">${v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '--'}</p></div>
                    </div>
                    
                    <div id="admin-timer-${v.id}" class="text-3xl font-black text-center mb-6 ${isE ? 'text-amber-500 animate-pulse' : 'text-slate-600'} font-mono tracking-tighter drop-shadow-lg">
                        ${isE ? '00:00:00' : (v.duracao || '00:00:00')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 text-[9px] font-bold uppercase">
                        <button onclick="verGps('${v.locInicio}')" class="btn-icon-glass p-3 flex items-center justify-center gap-2 text-slate-300"><i data-lucide="map-pin" class="w-3 h-3 text-blue-400"></i> Local Sa√≠da</button>
                        <button onclick="verGps('${v.locFim}')" class="btn-icon-glass p-3 flex items-center justify-center gap-2 text-slate-300"><i data-lucide="map-pin" class="w-3 h-3 text-red-400"></i> Local Chegada</button>
                        <button onclick="verFoto('${v.fotoInicio}')" class="btn-icon-glass p-3 flex items-center justify-center gap-2 text-slate-300"><i data-lucide="image" class="w-3 h-3 text-blue-400"></i> Foto Sa√≠da</button>
                        <button onclick="verFoto('${v.fotoFim}')" class="btn-icon-glass p-3 flex items-center justify-center gap-2 text-slate-300"><i data-lucide="image" class="w-3 h-3 text-red-400"></i> Foto Chegada</button>
                        <button onclick="abrirObsAdmin('${v.id}')" class="col-span-2 bg-slate-800/50 p-3 rounded-xl border border-white/10 hover:bg-slate-700/50 transition-colors mt-1 text-slate-300 flex items-center justify-center gap-2">
                           <i data-lucide="file-text" class="w-3 h-3"></i> Ver Ocorr√™ncias / Info (${v.historico_obs?.length || 0})
                        </button>
                    </div>
                </div>`;
            });
            lucide.createIcons();
        };

        // --- SISTEMA DE VIAGEM (COM WHATSAPP COMPLETO) ---
        window.iniciarViagem = async () => {
            const n = document.getElementById('motorista').value, p = document.getElementById('placa').value.toUpperCase().replace(/\s/g, ''), k = document.getElementById('km-inicio').value, f = document.getElementById('foto-inicio').files[0], t = document.getElementById('tipo-servico').value;
            if(!n || !p || !k || !f) return alert("Por favor, preencha todos os campos e tire a foto do painel.");
            document.getElementById('main-loader').style.display = 'flex';
            const pos = await obterPosicao();
            const d = await addDoc(collection(db, "viagens"), { 
                nome: n, placa: p, kmInicio: Number(k), fotoInicio: await comprimir(f), 
                dataInicio: Timestamp.now(), locInicio: `${pos.coords.latitude},${pos.coords.longitude}`, 
                status: "em_curso", tipoServico: t, historico_obs: [] 
            });
            localStorage.setItem('v_id', d.id); location.reload();
        };

        window.encerrarViagem = async () => {
            const id = localStorage.getItem('v_id'), kf = document.getElementById('km-fim').value, ff = document.getElementById('foto-fim').files[0];
            if(!kf || !ff) return alert("KM final e Foto s√£o obrigat√≥rios.");
            document.getElementById('main-loader').style.display = 'flex';
            const pos = await obterPosicao();
            const duracao = document.getElementById('cronometro-motorista').innerText;
            
            const docRef = doc(db, "viagens", id);
            const snap = await getDoc(docRef);
            const kmTotal = (Number(kf) - snap.data().kmInicio).toFixed(1);
            const dataFim = Timestamp.now();

            await updateDoc(docRef, { 
                kmFim: Number(kf), fotoFim: await comprimir(ff), status: "finalizada", 
                duracao: duracao, dataFim: dataFim, locFim: `${pos.coords.latitude},${pos.coords.longitude}` 
            });
            localStorage.removeItem('v_id');
            document.getElementById('main-loader').style.display = 'none';

            // Configurar Mensagem WhatsApp COMPLETA
            const txtWpp = `*RELAT√ìRIO DE VIAGEM*%0A---------------------------%0Aüöó *Tipo:* ${snap.data().tipoServico}%0Aüë§ *Condutor:* ${snap.data().nome}%0Aüî¢ *Placa:* ${snap.data().placa}%0AüìÖ *Data:* ${new Date().toLocaleDateString()}%0A---------------------------%0A‚ñ∂ *KM Inicial:* ${snap.data().kmInicio}%0AüèÅ *KM Final:* ${kf}%0Aüìè *KM Total:* ${kmTotal} km%0A‚è± *Dura√ß√£o:* ${duracao}`;
            
            document.getElementById('btn-share-wpp').onclick = () => window.open(`https://api.whatsapp.com/send?text=${txtWpp}`);
            document.getElementById('modal-sucesso-viagem').classList.remove('hidden');
        };

        // --- SISTEMAS DE SUPORTE (Mantidos e Otimizados) ---
        window.abrirModalGerarCodigo = () => {
            const placas = [...new Set(listaGlobalViagens.map(v => v.placa.trim().toUpperCase()).filter(p => p))].sort();
            document.getElementById('gc-placa-select').innerHTML = placas.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('display-codigo-gerado').classList.add('hidden');
            document.getElementById('modal-gerar-codigo').classList.remove('hidden');
        };
        window.processarGeracaoCodigo = async () => {
            const p = document.getElementById('gc-placa-select').value;
            const cod = Math.floor(1000 + Math.random() * 9000);
            await setDoc(doc(db, "codigos_acesso", p), { codigo: String(cod), placa: p });
            const d = document.getElementById('display-codigo-gerado'); d.innerText = cod; d.classList.remove('hidden');
        };
        window.validarAcessoExtrato = async () => {
            const p = document.getElementById('login-placa-manual').value.toUpperCase().trim();
            const c = document.getElementById('login-codigo').value.trim();
            if(!p || !c) return alert("Preencha todos os campos!");
            const dr = await getDoc(doc(db, "codigos_acesso", p));
            if(dr.exists() && String(dr.data().codigo) === c) {
                const historico = listaGlobalViagens.filter(v => v.placa.toUpperCase().trim() === p);
                document.getElementById('extrato-placa-titulo').innerText = "Ve√≠culo: " + p;
                document.getElementById('corpo-extrato').innerHTML = historico.map(v => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="table-cell font-bold text-white">
                            ${v.dataInicio ? new Date(v.dataInicio.toMillis()).toLocaleDateString() : '--'}
                            <div class="text-[10px] text-slate-400 font-normal mt-1 bg-slate-800/50 inline-block px-2 py-0.5 rounded">${v.tipoServico}</div>
                        </td>
                        <td class="table-cell text-center text-xs font-mono">${v.kmInicio}</td>
                        <td class="table-cell text-center text-xs font-mono text-emerald-400">${v.kmFim || '...'}</td>
                        <td class="table-cell text-center text-xs font-black text-cyan-400 font-mono">${v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '-'}</td>
                        <td class="table-cell text-center flex justify-center gap-2">
                            <button onclick="verFoto('${v.fotoInicio}')" class="text-blue-400 hover:text-white bg-blue-500/10 p-1.5 rounded-lg"><i data-lucide="camera" class="w-3 h-3"></i></button>
                            <button onclick="verFoto('${v.fotoFim}')" class="text-emerald-400 hover:text-white bg-emerald-500/10 p-1.5 rounded-lg"><i data-lucide="check-circle" class="w-3 h-3"></i></button>
                        </td>
                    </tr>`).join('');
                if(historico.length === 0) document.getElementById('corpo-extrato').innerHTML = "<tr><td colspan='6' class='p-8 text-center text-slate-500 text-xs uppercase tracking-widest'>Nenhum registro encontrado para esta placa.</td></tr>";
                fecharModal('modal-extrato-login'); document.getElementById('modal-tabela-extrato').classList.remove('hidden'); lucide.createIcons();
            } else { alert("Acesso negado. Verifique a placa e o c√≥digo."); }
        };
        window.gerarExcel = () => { const ws = XLSX.utils.json_to_sheet(listaGlobalViagens); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Frota"); XLSX.writeFile(wb, "Relatorio_Frota_Completo.xlsx"); };
        window.excluirPeriodoSelecionado = async () => {
            const ini = document.getElementById('data-exp-inicio').value; const fim = document.getElementById('data-exp-fim').value;
            if(!ini || !fim) return alert("Selecione o per√≠odo.");
            if(confirm(`ATEN√á√ÉO: Apagar dados de ${ini} a ${fim}?`)) {
                document.getElementById('main-loader').style.display = 'flex';
                const dIni = new Date(ini + "T00:00:00"); const dFim = new Date(fim + "T23:59:59");
                const q = query(collection(db, "viagens"), where("dataInicio", ">=", Timestamp.fromDate(dIni)), where("dataInicio", "<=", Timestamp.fromDate(dFim)));
                const snaps = await getDocs(q);
                snaps.forEach(async (d) => await deleteDoc(doc(db, "viagens", d.id)));
                document.getElementById('main-loader').style.display = 'none';
                alert(`${snaps.size} viagens apagadas.`); fecharModal('modal-export');
            }
        };

        // --- NOTIFICA√á√ïES & UTILIT√ÅRIOS ---
        window.abrirModalNotifAdmin = () => { document.getElementById('modal-gerenciar-notif').classList.remove('hidden'); renderizarNotificacoesAdmin(); };
        window.renderizarNotificacoesAdmin = () => {
            document.getElementById('lista-notif-admin').innerHTML = listaNotificacoes.map(n => `
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-xl border border-white/10 hover:bg-white/10 transition-colors">
                    <div><span class="text-[10px] text-amber-500 font-bold block">${new Date(n.criadoEm).toLocaleDateString()}</span><span class="text-xs text-slate-300">${n.texto}</span></div>
                    <button onclick="excluirNotificacao('${n.id}')" class="text-red-400 p-2 hover:bg-red-500/20 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('');
            lucide.createIcons();
        };
        window.salvarNotificacao = async () => { const t = document.getElementById('notif-texto').value; if(t) { await addDoc(collection(db, "notificacoes"), { texto: t, criadoEm: Date.now() }); document.getElementById('notif-texto').value = ""; } };
        window.excluirNotificacao = async (id) => { if(confirm("Remover este aviso?")) await deleteDoc(doc(db, "notificacoes", id)); };
        window.abrirModalNotif = () => { document.getElementById('btn-sino').classList.remove('pulsing'); document.getElementById('notif-badge').classList.add('hidden'); document.getElementById('modal-notificacoes').classList.remove('hidden'); };

        const obterPosicao = () => new Promise(res => navigator.geolocation.getCurrentPosition(res, () => res({coords:{latitude:0,longitude:0}}), {enableHighAccuracy: true}));
        const comprimir = (f) => new Promise(res => { const r = new FileReader(); r.readAsDataURL(f); r.onload = e => { const i = new Image(); i.src = e.target.result; i.onload = () => { const c = document.createElement('canvas'); const s = 900 / i.width; c.width = 900; c.height = i.height * s; const ctx = c.getContext('2d'); ctx.drawImage(i, 0, 0, c.width, c.height); res(c.toDataURL('image/jpeg', 0.6)); }; }; });
        const calcularTempo = (i) => { const d = Math.floor((Date.now() - i) / 1000); return new Date(d * 1000).toISOString().substr(11, 8); };
        
        window.compartilharWpp = (id) => { 
            const v = listaGlobalViagens.find(x=>x.id===id); 
            const txt = `*RELAT√ìRIO DE FROTA*%0Aüöó Ve√≠culo: ${v.placa}%0Aüë§ Motorista: ${v.nome}%0AüìÖ Data: ${new Date(v.dataInicio.toMillis()).toLocaleDateString()}%0Aüìè Total KM: ${(v.kmFim-v.kmInicio).toFixed(1)}%0A‚è± Dura√ß√£o: ${v.duracao}`;
            window.open(`https://api.whatsapp.com/send?text=${txt}`); 
        };
        window.verFoto = (s) => { if(s){document.getElementById('foto-view').src = s; document.getElementById('modal-foto').classList.remove('hidden');} else alert("Imagem indispon√≠vel"); };
        window.verGps = (c) => { if(!c || c==="0,0") return alert("Sem dados de GPS"); document.getElementById('gps-iframe').src = `https://maps.google.com/maps?q=${c}&z=15&output=embed`; document.getElementById('modal-gps').classList.remove('hidden'); };
        window.acessoAdmin = () => { if(prompt("Senha Administrativa:") === "60010774") mudarTela('admin'); };
        window.salvarObservacaoMotorista = async () => { const id = localStorage.getItem('v_id'); await updateDoc(doc(db, "viagens", id), { historico_obs: arrayUnion({tipo: document.getElementById('comp-tipo').value, texto: document.getElementById('comp-obs').value, hora: new Date().toLocaleTimeString()}) }); fecharModal('modal-complementos'); alert("Observa√ß√£o Salva!"); };
        window.abrirObsAdmin = (id) => { const v = listaGlobalViagens.find(x => x.id === id); document.getElementById('conteudo-obs-admin').innerHTML = v.historico_obs?.map(o=>`<div class='p-4 bg-slate-900 border border-white/10 rounded-xl mb-2'><p class='text-[10px] text-cyan-500 font-black uppercase mb-1'>${o.tipo} ‚Ä¢ ${o.hora}</p><p class='text-xs text-slate-300'>${o.texto}</p></div>`).join('') || "<p class='text-center text-slate-500 text-xs py-4'>Nenhuma ocorr√™ncia registrada.</p>"; document.getElementById('modal-ver-obs').classList.remove('hidden'); };
        window.excluirCard = async(id) => { if(confirm("ATEN√á√ÉO: Deletar este registro permanentemente?")) await deleteDoc(doc(db, "viagens", id)); };

        // Inicializa√ß√£o
        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => { listaGlobalViagens = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderizarAdmin(); });
        
        onSnapshot(collection(db, "notificacoes"), (snap) => {
            listaNotificacoes = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.criadoEm - a.criadoEm);
            document.getElementById('lista-notificacoes-motorista').innerHTML = listaNotificacoes.map(n => `<div class='p-4 bg-white/5 rounded-xl border-l-4 border-amber-500 mb-2'><p class='text-[10px] text-amber-500 font-bold mb-1'>${new Date(n.criadoEm).toLocaleDateString()}</p><p class='text-xs text-slate-200'>${n.texto}</p></div>`).join('');
            if(!document.getElementById('modal-gerenciar-notif').classList.contains('hidden')) renderizarNotificacoesAdmin();
            if (!isFirstLoadNotif && snap.docChanges().some(c => c.type === 'added')) {
                document.getElementById('btn-sino').classList.add('pulsing');
                document.getElementById('notif-badge').classList.remove('hidden');
            }
            isFirstLoadNotif = false;
        });

        setInterval(() => {
            listaGlobalViagens.filter(v => v.status === 'em_curso').forEach(v => {
                const el = document.getElementById(`admin-timer-${v.id}`);
                if(el) el.innerText = calcularTempo(v.dataInicio.toMillis());
            });
        }, 1000);

        window.addEventListener('load', async () => { 
            lucide.createIcons(); 
            const vid = localStorage.getItem('v_id');
            if(vid) { 
                try {
                    const s = await getDoc(doc(db, "viagens", vid));
                    if(s.exists() && s.data().status === 'em_curso') { 
                        mudarTela('em-curso'); 
                        document.getElementById('info-viagem-ativa').innerText = "EM ROTA: " + s.data().placa;
                        setInterval(() => document.getElementById('cronometro-motorista').innerText = calcularTempo(s.data().dataInicio.toMillis()), 1000);
                    } else { localStorage.removeItem('v_id'); }
                } catch(e) {}
            }
            hideLoader(); 
        });
    </script>
</body>
</html>

