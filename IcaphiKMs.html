<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICAPHI - KMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // PALETA MONOCROMÁTICA AZUL CRISTAL
                        'liquid-blue': {
                            50: '#F0F8FF', // Quase branco
                            100: '#E0F7FA', // Azul-Gelo muito claro
                            400: '#81D4FA', // Azul-Céu Light (Base)
                            600: '#00BFFF', // DeepSkyBlue (Primário/Destaque)
                            700: '#00A6D7', // Azul-Céu Hover
                            800: '#008CBA', // Azul escuro para textos
                        },
                        // Verde/Sucesso ajustado para Teal-Aqua (mais próximo do azul)
                        'teal-success': {
                            600: '#00B8AA', // Aqua-Ciano
                            700: '#009688', 
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* DEFINIÇÕES GLOBAIS DE COR/ESTILO */
        :root {
            /* Cores de Liquid Glass Sofisticadas (Azul Cristal) */
            --primary-color: #00BFFF; /* DeepSkyBlue */
            --primary-hover: #00A6D7;
            --success-color: #00B8AA; /* Aqua-Ciano */
            --success-hover: #009688;
            --text-dark: #008CBA; /* Azul escuro para contraste */
            /* Efeito de Vidro: Opacidade e brilho */
            --glass-bg: rgba(255, 255, 255, 0.1); /* MUITO transparente */
            --glass-border: rgba(255, 255, 255, 0.5); /* Borda branca brilhante */
            --glass-shadow: rgba(0, 191, 255, 0.3); /* Sombra azul */
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            /* Fundo Gradiente Azul Suave e ANIMADO */
            background: linear-gradient(135deg, #ffffff 0%, #b0e3ffbb 100%, #ffffff 100%);
            background-size: 200% 200%;
            animation: moving-gradient 5s ease infinite; /* Animação do fundo */
            min-height: 100vh;
            color: var(--text-dark); 
            overflow-x: hidden; 
        }

        /* ANIMAÇÃO DE FUNDO SUAVE */
        @keyframes moving-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* ESTILO PRINCIPAL: O CARD "LIQUID GLASS" EXTREMO */
        .container-card {
            /* Efeito Glassmorphism Potente */
            background: var(--glass-bg);
            backdrop-filter: blur(30px) saturate(180%); 
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            padding: 2.5rem; 
            border-radius: 30px; /* Mais arredondado */
            /* Borda de reflexo de luz */
            border: 1px solid var(--glass-border);
            /* Sombra azul suave e longa */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), 
                        0 20px 40px var(--glass-shadow),
                        inset 0 0 0 1px rgba(255, 255, 255, 0.4); /* Brilho interno */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s ease;
        }
        .container-card:hover {
            transform: translateY(-5px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15), 
                        0 30px 60px rgba(0, 191, 255, 0.5); /* Sombra mais intensa */
        }

        /* Títulos */
        h1, h2, h3 {
            color: var(--text-dark);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.8); /* Destaque leve */
        }
        
        /* BOTÕES (Com efeito de vidro) */
        .btn-base {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Curva "springy" */
            border-radius: 18px; /* Mais ovalado */
            font-weight: 700;
            cursor: pointer;
            border: none;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Botão Primário (Azul Claro) */
        .btn-primary {
            background: linear-gradient(145deg, var(--primary-color), var(--primary-hover));
            box-shadow: 0 6px 15px rgba(0, 191, 255, 0.4);
        }
        .btn-primary:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 191, 255, 0.6);
        }
        .btn-primary:active {
            transform: scale(0.97);
            box-shadow: 0 2px 5px rgba(0, 191, 255, 0.3);
        }

        /* Botão de Sucesso (Aqua/Teal) */
        .btn-success {
             background: linear-gradient(145deg, var(--success-color), var(--success-hover));
             box-shadow: 0 6px 15px rgba(0, 184, 170, 0.4);
        }
        .btn-success:hover {
            transform: scale(1.03) translateY(-2px);
             box-shadow: 0 10px 20px rgba(0, 184, 170, 0.6);
        }
        .btn-success:active {
            transform: scale(0.97);
            box-shadow: 0 2px 5px rgba(0, 184, 170, 0.3);
        }

        /* Botões de Navegação (Vidro com Borda Azul) */
        .nav-btn {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
            background-color: rgba(255, 255, 255, 0.4); /* Fundo de vidro */
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            padding: 12px 28px;
        }
        .nav-btn.active {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.05); 
            box-shadow: 0 4px 15px var(--glass-shadow);
            border-color: var(--primary-color);
        }
        .nav-btn:not(.active):hover {
            background-color: rgba(255, 255, 255, 0.7); 
            color: var(--primary-hover);
            transform: scale(1.02);
            border-color: var(--primary-hover);
        }
        
        /* Cronômetro com brilho mais intenso */
        .text-highlight {
            color: var(--primary-color);
            font-variant-numeric: tabular-nums; 
            animation: pulse-glow 1.5s infinite alternate; 
        }

        /* Animação do Cronômetro */
        @keyframes pulse-glow {
            from { 
                text-shadow: 0 0 8px rgba(0, 191, 255, 0.7); 
            }
            to { 
                text-shadow: 0 0 20px rgba(0, 191, 255, 1), 0 0 30px rgba(0, 191, 255, 0.5); 
            }
        }

        /* --- TRANSIÇÃO DE SEÇÕES INOVADORA (SLIDE-FADE) --- */
        .view-section {
            /* Transição de entrada (Slide up + Fade in) */
            transition: opacity 0.5s ease-out, 
                        transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Curva Ease-Out-Quad */
            transform: translateY(0);
        }
        .view-section.hidden {
            opacity: 0;
            transform: translateY(20px); /* Começa 20px abaixo */
            pointer-events: none; 
            /* Transição de saída mais rápida para sensação de resposta */
            transition: opacity 0.2s ease-in, transform 0.2s ease-in; 
        }

        /* Campos de Input (Estilo Vidro) */
        input:not([type="file"]):not([type="checkbox"]):not([type="radio"]) {
            border: 1px solid rgba(0, 191, 255, 0.2); /* Borda azul clara sutil */
            background-color: rgba(255, 255, 255, 0.5); /* Fundo de vidro opaco */
            color: var(--text-dark);
            border-radius: 12px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input:not([type="file"]):not([type="checkbox"]):not([type="radio"]):focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 191, 255, 0.3); /* Sombra Ciano no foco */
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        /* Tabela (Estilo Vidro) */
        .divide-y.divide-gray-200, .divide-gray-200\/50 {
            border-color: rgba(0, 191, 255, 0.1) !important;
        }
        .bg-gray-100\/70 {
            background-color: rgba(0, 191, 255, 0.15) !important; /* Cabeçalho de tabela azul claro */
        }
        .bg-white\/70 {
            background-color: rgba(255, 255, 255, 0.4) !important; /* Fundo de linha de tabela de vidro */
        }
        .hover\:bg-cianoblue-50\/50:hover {
            background-color: rgba(0, 191, 255, 0.1) !important; /* Efeito hover azul */
        }
        
        /* Linha de Rota em Andamento (Amarelo Suave) */
        .bg-yellow-50\/70 {
            background-color: rgba(255, 250, 205, 0.7) !important; /* Amarelo pálido */
            border-left: 5px solid orange; /* Indicador lateral */
        }
        .hover\:bg-yellow-100\/70:hover {
            background-color: rgba(255, 248, 179, 0.9) !important; /* Amarelo mais intenso no hover */
        }

        /* --- ESTILOS DO MODAL DE FOTO --- */
        .photo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(15px);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; /* Começa invisível */
            transition: opacity 0.3s ease-out;
        }
        .photo-modal-overlay.visible {
            opacity: 1; /* Transição de entrada */
        }

        .photo-modal-content {
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 90%; 
            width: 600px; /* Largura ajustada para apenas foto */
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transform: scale(0.9); /* Começa menor */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efeito 'Pop' */
        }
        .photo-modal-overlay.visible .photo-modal-content {
             transform: scale(1); /* Transição de entrada 'Pop' */
        }

        /* Estilização para as imagens dentro do modal */
        #modal-image {
            width: 100%; /* Ocupa 100% da coluna */
            max-height: 60vh; /* Limita a altura para visualização */
            object-fit: contain; /* Garante que a imagem inteira seja vista */
            margin: 0 auto; /* Centraliza horizontalmente */
        }

    </style>
</head>
<body class="flex flex-col items-center justify-start pt-10 pb-10">

    <div id="app-container" class="w-full max-w-full xl:max-w-7xl p-4 md:p-6">
        
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-8" style="color: var(--text-dark);">
            Gerênciamento de KMs - ICAPHI Transportes
        </h1>

        <div class="flex justify-center space-x-4 mb-8">
            <button id="show-driver-btn" class="font-semibold nav-btn active" onclick="showDriverView()">
                Motorista
            </button>
            <button id="show-admin-btn" class="font-semibold nav-btn" onclick="showAdminView()">
                Administrativo
            </button>
        </div>

        <div id="message-area" class="text-center mb-4 p-3 rounded-lg hidden"></div>

        <div id="driver-view" class="container-card view-section">
           
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-2" style="border-color: rgba(0, 191, 255, 0.3);">Registro de Viagem</h2>
            
            <div id="start-trip-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              
                    <div>
                        <label for="driver-name" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Nome do Motorista</label>
                        <input type="text" id="driver-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600" placeholder="Seu Nome Completo">
                    </div>
          
                    <div>
                        <label for="license-plate" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Placa do Veículo</label>
                        <input type="text" id="license-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600 uppercase" placeholder="ABC1234">
                    </div>
    
                 <div>
                        <label for="km-start" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">KM Inicial (Odômetro)</label>
                        <input type="number" id="km-start" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600" placeholder="Ex: 55000">
                    </div>
         
               </div>

                <div class="mb-6 p-4 border border-liquid-blue-400 rounded-xl" style="background: rgba(255, 255, 255, 0.3); border: 1px solid rgba(0, 191, 255, 0.3); backdrop-filter: blur(5px);">
                    <label for="photo-start" class="block text-base font-semibold text-gray-700 mb-2 flex items-center" style="color: var(--text-dark);">
                        <i class="fas fa-camera mr-2" style="color: var(--primary-color);"></i> 1. Foto OBRIGATÓRIA do Painel/Odômetro
                    </label>
                    <input type="file" id="photo-start" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'start')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-liquid-blue-100/70 file:text-liquid-blue-700 hover:file:bg-liquid-blue-200/70"/>
                    <p id="photo-start-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="startTrip()" class="w-full btn-base btn-success py-3 rounded-lg text-lg font-bold shadow-md">
                    <i class="fas fa-play"></i> Iniciar Saída
                </button>
               
                <p class="text-sm text-gray-600 mt-2 text-center">Será registrada a sua localização, hora e a foto do painel.</p>
            </div>

            <div id="trip-in-progress" class="hidden text-center p-6 border-2 border-dashed rounded-xl" style="border-color: var(--primary-color); background: rgba(0, 191, 255, 0.1); backdrop-filter: blur(5px);">
                <h3 class="text-xl font-bold text-liquid-blue-700 mb-4" style="color: var(--primary-color);">Viagem em Andamento!</h3>
                <p class="mb-2" style="color: var(--text-dark);">Motorista: <span id="current-driver-name" class="font-semibold"></span></p>
                <p class="mb-4" style="color: var(--text-dark);">Placa: <span id="current-license-plate" class="font-semibold"></span></p>

                <div class="flex justify-center items-baseline mb-6">
                    <span class="text-6xl font-extrabold text-highlight" id="timer-display">00:00:00</span>
                </div>

                <label for="km-end" class="block text-sm font-medium text-gray-700 mb-2" style="color: var(--text-dark);">KM Final (Odômetro)</label>
                <input type="number" id="km-end" class="mb-4 block w-full md:w-1/2 mx-auto rounded-md border-gray-300 shadow-sm p-3 border text-center focus:ring-liquid-blue-600 focus:border-liquid-blue-600" placeholder="KM de Chegada">

                 <div class="mb-6 p-4 rounded-xl" style="border: 1px solid rgba(0, 191, 255, 0.3); background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px);">
                    <label for="photo-end" class="block text-base font-semibold text-gray-700 mb-2 flex items-center" style="color: var(--text-dark);">
                        <i class="fas fa-camera mr-2" style="color: var(--text-dark);"></i> 2. Foto OBRIGATÓRIA do Painel/Odômetro de Chegada
                    </label>
                    <input type="file" id="photo-end" accept="image/*" capture="environment" onchange="handleImageUpload(event, 'end')" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-200/70 file:text-gray-700 hover:file:bg-gray-300/70"/>
                    <p id="photo-end-status" class="mt-2 text-sm text-gray-600 font-medium">Nenhuma foto anexada. (Máx. 800px)</p>
                </div>

                <button onclick="endTrip()" class="w-full btn-base btn-primary py-3 rounded-lg text-lg font-bold shadow-md">
                    <i class="fas fa-stop"></i> Registrar Chegada e Finalizar Rota
                </button>
            </div>
        </div>

        <div id="admin-view" class="container-card view-section hidden">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700 border-b pb-2" style="border-color: rgba(0, 191, 255, 0.3);">Painel Administrativo</h2>
            
            <div id="admin-login-area">
                <label for="admin-password" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Senha de Acesso</label>
                <input type="password" id="admin-password" class="mt-1 block w-full md:w-96 rounded-md border-gray-300 shadow-sm p-3 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600" placeholder="Senha">
                <button onclick="adminLogin()" class="mt-4 btn-base btn-primary py-2 px-6 rounded-lg font-semibold">
                    Acessar
                </button>
                <p class="text-xs text-red-500 mt-2 hidden" id="login-error-message">Senha incorreta. (Acesso somento do administrativo)</p>
            </div>

            <div id="admin-dashboard" class="hidden">
                <h3 class="text-xl font-bold mb-4 text-gray-700" style="color: var(--text-dark);">Rotas Concluídas e em Andamento</h3>

                <div class="flex flex-col md:flex-row gap-4 mb-6 p-4 rounded-xl" style="background: rgba(255, 255, 255, 0.3); backdrop-filter: blur(5px); border: 1px solid rgba(0, 191, 255, 0.2);">
                    <div class="flex-grow">
                        <label for="filter-plate" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Filtrar por Placa</label>
                        <input type="text" id="filter-plate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border uppercase focus:ring-liquid-blue-600 focus:border-liquid-blue-600" placeholder="Placa (ex: ABC1234)">
                    </div>
                    <div class="flex-grow">
                        <label for="filter-start-date" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Data Inicial</label>
                        <input type="date" id="filter-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600">
                    </div>
                    <div class="flex-grow">
                        <label for="filter-end-date" class="block text-sm font-medium text-gray-700" style="color: var(--text-dark);">Data Final</label>
                        <input type="date" id="filter-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-liquid-blue-600 focus:border-liquid-blue-600">
                    </div>
                    <div class="flex-shrink-0 flex items-end">
                        <button onclick="applyAdminFilters()" class="btn-base btn-primary py-2 px-4 rounded-lg font-semibold w-full md:w-auto">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mb-4">
                    <button onclick="exportToCSV()" class="btn-base btn-success text-white py-2 px-4 rounded-lg font-semibold">
                        Exportar para Planilha (CSV)
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100/70 backdrop-blur-sm">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Motorista</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Placa</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">KM Total</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Tempo</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Saída (Data/Hora)</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Chegada (Data/Hora)</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">KM Inicial</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">KM Final</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Local Saída</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Local Chegada</th>
                                <th class="px-2 py-3 text-center text-xs font-medium tracking-wider" style="color: var(--text-dark);">Ver Saída</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Ver Chegada</th>
                                <th class="px-2 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider" style="color: var(--text-dark);">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="bg-white/70 divide-y divide-gray-200/50">
                            <tr><td colspan="13" class="p-4 text-center text-gray-500">Nenhuma rota encontrada ou carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    
        <div id="photo-modal" class="photo-modal-overlay hidden" onclick="closePhotoModal()">
            <div class="photo-modal-content" onclick="event.stopPropagation()">
                <button onclick="closePhotoModal()" class="self-end text-3xl font-bold text-white hover:text-liquid-blue-500 mb-2 transition-colors">
                    &times;
                </button>
                
                <div class="flex flex-col items-center">
                    <h3 class="text-xl font-bold text-white mb-4 text-shadow-lg">Foto do Painel</h3>
                    <img id="modal-image" src="" alt="Foto do Painel" class="max-w-full h-auto rounded-lg shadow-xl border-2 border-white/50">
                </div>
                <p id="modal-caption" class="mt-4 text-center text-gray-300 text-lg font-semibold"></p>
                <p id="modal-coords" class="mt-1 text-center text-gray-400 text-sm italic">Localização: </p>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, Timestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs para debug
        setLogLevel('Debug');
        // --- CONFIGURAÇÃO FIREBASE ---
        const providedConfig = {
             apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
             authDomain: "marcador-ponto-digital.firebaseapp.com",
             projectId: "marcador-ponto-digital",
             storageBucket: "marcador-ponto-digital.firebasestorage.app",
             messagingSenderId: "774324665760",
             appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5",
             measurementId: "G-W1QEJTCS1B"
        };
        
        // Usa a configuração fornecida.
        let firebaseConfig = providedConfig;

        const appId = firebaseConfig.projectId;
        let app, db, auth;
        let userId = null;
        let currentTripDocId = localStorage.getItem('currentTripDocId'); 
        let timerInterval = null; // Timer para a view do motorista
        let liveTimerInterval = null; // NOVO: Timer para a view administrativa (tempo real)
        const ADMIN_PASSWORD = "60010774";
        let startPhotoBase64 = null;
        let endPhotoBase64 = null;
        
        const ROUTES_COLLECTION_PATH = `/artifacts/${appId}/public/data/driver_routes`;

        // Elementos DOM
        const driverView = document.getElementById('driver-view');
        const adminView = document.getElementById('admin-view');
        const adminDashboard = document.getElementById('admin-dashboard');
        const adminLoginArea = document.getElementById('admin-login-area');
        const loginErrorMessage = document.getElementById('login-error-message');
        const messageArea = document.getElementById('message-area');
        const startTripForm = document.getElementById('start-trip-form');
        const tripInProgress = document.getElementById('trip-in-progress');
        const timerDisplay = document.getElementById('timer-display');
        const adminTableBody = document.getElementById('admin-table-body');
        const photoModal = document.getElementById('photo-modal');
        const modalImage = document.getElementById('modal-image');
        const modalCaption = document.getElementById('modal-caption');
        const modalCoords = document.getElementById('modal-coords'); 
        

        // --- Funções Auxiliares ---

        function displayMessage(text, type = 'info') {
            messageArea.textContent = text;
            messageArea.className = 'text-center mb-4 p-3 rounded-lg block font-semibold';
            if (type === 'success') {
                messageArea.classList.add('bg-teal-success-100', 'text-teal-success-800');
            } else if (type === 'error') {
                messageArea.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageArea.classList.add('bg-liquid-blue-100', 'text-liquid-blue-800');
            }
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
                messageArea.classList.remove('block');
            }, 5000);
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocalização não é suportada pelo seu navegador.'));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                        });
                    },
                    (error) => {
                        console.error("Erro na geolocalização:", error);
                        reject(new Error('Não foi possível obter a localização. Certifique-se de que a localização está ativada e tente novamente.'));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        
        async function getStreetAndNeighborhood(lat, lon) {
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'ICAPHI-KMS-App/1.0 (CanvasApp; contact: logistics@icaphi.com)'
                    }, 
                });
                const data = await response.json();
                
                if (data.address) {
                    const address = data.address;
                    let parts = [];

                    const road = address.road || address.pedestrian || address.footway || '';
                    const houseNumber = address.house_number || address.building || '';
                    
                    if (road || houseNumber) {
                        parts.push(road + (road && houseNumber ? ', ' : '') + houseNumber);
                    }
                    
                    const neighborhood = address.suburb || address.neighbourhood || address.city_district || '';
                    if (neighborhood && !parts.includes(neighborhood)) {
                        parts.push(neighborhood);
                    }

                    const city = address.city || address.town || address.village || address.county || '';
                    if (city && !parts.includes(city)) {
                        parts.push(city);
                    }

                    const state = address.state || '';
                    if (state && !parts.includes(state)) {
                        parts.push(state);
                    }

                    let result = parts.filter(p => p.trim() !== '').join(', ');

                    if (result.length < 10 && data.display_name) {
                        return data.display_name;
                    }

                    return result || `Localização (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;
                }
            } catch (error) {
                console.error("Erro no Reverse Geocoding:", error);
            }
            return `Localização (Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)})`;
        }
        
        function resizeImageAndConvertToBase64(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const base64String = canvas.toDataURL('image/jpeg', 0.9);
                        resolve(base64String);
                    };
                    img.onerror = (e) => reject(new Error('Erro ao carregar a imagem.'));
                    img.src = event.target.result;
                };
                reader.onerror = (e) => reject(new Error('Erro ao ler o arquivo.'));
                reader.readAsDataURL(file);
            });
        }

        window.handleImageUpload = async function(event, type) {
            const fileInput = event.target;
            const statusElement = document.getElementById(`photo-${type}-status`);
            statusElement.textContent = 'Processando e redimensionando foto... Aguarde.';
            statusElement.classList.remove('text-gray-600', 'text-green-600', 'text-red-600'); 
            statusElement.classList.add('text-liquid-blue-600');
            
            if (fileInput.files.length === 0) {
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
                statusElement.textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                statusElement.classList.remove('text-liquid-blue-600', 'text-red-600', 'text-green-600');
                statusElement.classList.add('text-gray-600');
                return;
            }

            const file = fileInput.files[0];
            const MAX_SIZE = 800; // Largura/Altura máxima em pixels
            try {
                const base64 = await resizeImageAndConvertToBase64(file, MAX_SIZE, MAX_SIZE);
                if (type === 'start') {
                    startPhotoBase64 = base64;
                } else {
                    endPhotoBase64 = base64;
                }

                const sizeKB = Math.round(base64.length * 0.75 / 1024);
                statusElement.textContent = `Foto anexada e redimensionada! (~${sizeKB} KB)`;
                statusElement.classList.remove('text-liquid-blue-600', 'text-red-600', 'text-gray-600');
                statusElement.classList.add('text-green-600');
            } catch (error) {
                console.error("Erro no processamento da imagem:", error);
                displayMessage('Erro ao processar a foto. Tente novamente ou use uma imagem menor.', 'error');
                statusElement.textContent = 'Erro ao processar a foto.';
                statusElement.classList.remove('text-liquid-blue-600', 'text-green-600', 'text-gray-600');
                statusElement.classList.add('text-red-600');
                if (type === 'start') startPhotoBase64 = null;
                if (type === 'end') endPhotoBase64 = null;
            }
        }
        
        function updateDriverUI(tripData) {
            if (tripData) {
                document.getElementById('current-driver-name').textContent = tripData.driverName;
                document.getElementById('current-license-plate').textContent = tripData.licensePlate;
                
                startTripForm.classList.add('hidden');
                tripInProgress.classList.remove('hidden');

                startTimer(tripData.startTime.toDate().getTime());
            } else {
                startTripForm.classList.remove('hidden');
                tripInProgress.classList.add('hidden');

                stopTimer();
                document.getElementById('km-end').value = '';
                document.getElementById('photo-end').value = '';
                document.getElementById('photo-end-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-end-status').classList.remove('text-liquid-blue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-end-status').classList.add('text-gray-600');
                endPhotoBase64 = null;

                document.getElementById('driver-name').value = '';
                document.getElementById('license-plate').value = '';
                document.getElementById('km-start').value = '';
                document.getElementById('photo-start').value = '';
                document.getElementById('photo-start-status').textContent = 'Nenhuma foto anexada. (Máx. 800px)';
                document.getElementById('photo-start-status').classList.remove('text-liquid-blue-600', 'text-green-600', 'text-red-600');
                document.getElementById('photo-start-status').classList.add('text-gray-600');
                startPhotoBase64 = null;
            }
        }

        function startTimer(startTimeMs) {
            stopTimer(); 
            timerInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - startTimeMs) / 1000);
                timerDisplay.textContent = formatTime(elapsedSeconds);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = '00:00:00';
            }
        }
        
        window.viewPhoto = function(base64Data, caption, lat, lon) {
            if (base64Data) {
                modalImage.src = base64Data;
                modalCaption.textContent = caption;
                
                const coordsText = (lat && lon) ? `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}` : 'Coordenadas não registradas.';
                modalCoords.textContent = `Localização: ${coordsText}`;

                photoModal.classList.remove('hidden');
                setTimeout(() => {
                    photoModal.classList.add('visible');
                }, 10);
            } else {
                displayMessage('Foto não disponível ou não anexada para esta rota.', 'error');
            }
        }

        window.closePhotoModal = function() {
            photoModal.classList.remove('visible');
            setTimeout(() => {
                photoModal.classList.add('hidden');
                modalImage.src = ''; 
                modalCoords.textContent = 'Localização:';
            }, 300); 
        }

        // NOVO: Função para atualizar o tempo decorrido em tempo real na tabela administrativa.
        function updateLiveTime() {
            // Filtra apenas as rotas que estão em andamento
            const liveTrips = allRoutesData.filter(route => route.status === 'In Progress');
            const now = Date.now();
            
            liveTrips.forEach(route => {
                if (route.startTime) {
                    const startTimeMs = route.startTime.toDate().getTime();
                    const elapsedSeconds = Math.floor((now - startTimeMs) / 1000);
                    const formattedTime = formatTime(elapsedSeconds);
                    
                    // Busca o elemento na tabela pelo atributo data-live-time (que é o ID da rota)
                    const element = document.querySelector(`[data-live-time="${route.id}"]`);
                    if (element) {
                        element.textContent = formattedTime;
                    }
                }
            });
        }
        
        function startLiveTimer() {
             // Para qualquer timer existente
            if (liveTimerInterval) {
                clearInterval(liveTimerInterval);
            }
            
            // Inicia o novo timer para atualização de 1 em 1 segundo
            liveTimerInterval = setInterval(() => {
                updateLiveTime();
            }, 1000);
            console.log("Live Timer iniciado para o painel administrativo.");
        }

        function stopLiveTimer() {
            if (liveTimerInterval) {
                clearInterval(liveTimerInterval);
                liveTimerInterval = null;
                console.log("Live Timer parado.");
            }
        }


        function renderAdminTable(routes) {
            adminTableBody.innerHTML = ''; 
            if (routes.length === 0) {
                adminTableBody.innerHTML = '<tr><td colspan="13" class="p-4 text-center text-gray-500">Nenhuma rota encontrada para o filtro atual.</td></tr>';
                return;
            }

            routes.forEach(route => {
                const isInProgress = route.status === 'In Progress';
                
                // Variáveis para rotas em andamento
                const totalKm = isInProgress ? 'EM ROTA' : (route.kmEnd - route.kmStart).toFixed(1) + ' km';
                const kmFinalStr = isInProgress ? 'N/A' : (route.kmEnd ? route.kmEnd.toFixed(1) : 'N/A');
                const endTimeStr = isInProgress ? 'EM ABERTO' : (route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A');
                const endAddress = isInProgress ? 'N/A' : (route.endLocation?.address || 'Endereço Indisponível');
                const startLat = route.startLocation?.lat || 0; 
                const startLon = route.startLocation?.lon || 0; 
                const endLat = route.endLocation?.lat || 0;
                const endLon = route.endLocation?.lon || 0;
                
                // Campo Tempo (com atributo para atualização em tempo real)
                const elapsedTimeStr = isInProgress ? 
                    `<span class="font-bold text-red-600" data-live-time="${route.id}">CALCULANDO...</span>` : 
                    (route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A');
                
                // Horário de Saída (sempre existe)
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                
                // Botões de Visualização de Foto
                const startPhotoBtn = route.startPhoto ? 
                    `<button onclick="viewPhoto('${route.startPhoto}', 'Foto KM Inicial - ${route.driverName}', ${startLat}, ${startLon})" 
                        class="text-liquid-blue-600 hover:text-liquid-blue-800 transition-colors" title="Ver Foto e Localização de Saída">
                        <i class="fas fa-image"></i>
                    </button>` : `<span class="text-gray-400"><i class="fas fa-times-circle"></i></span>`;

                const endPhotoBtn = isInProgress ? 
                    `<span class="text-gray-400"><i class="fas fa-minus-circle"></i></span>` : // Desabilitado se em andamento
                    (route.endPhoto ? 
                        `<button onclick="viewPhoto('${route.endPhoto}', 'Foto KM Final - ${route.driverName}', ${endLat}, ${endLon})" 
                            class="text-liquid-blue-600 hover:text-liquid-blue-800 transition-colors" title="Ver Foto e Localização de Chegada">
                            <i class="fas fa-image"></i>
                        </button>` : `<span class="text-gray-400"><i class="fas fa-times-circle"></i></span>`);
                
                // Botão de Excluir
                const deleteBtn = `<button onclick="deleteRoute('${route.id}')" class="bg-red-500 text-white hover:bg-red-700 p-2 rounded-md text-sm" title="Excluir Rota">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>`;

                // Estilo da linha para rotas em andamento
                const rowClass = isInProgress ? 'bg-yellow-50/70 hover:bg-yellow-100/70' : 'bg-white/70 hover:bg-liquid-blue-50/50';

                const newRow = `
                    <tr class="${rowClass}">
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-medium" style="color: var(--text-dark);">${route.driverName}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm" style="color: var(--text-dark);">${route.licensePlate}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-bold text-liquid-blue-700">${totalKm}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-liquid-blue-600">${elapsedTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${startTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500">${endTimeStr}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm" style="color: var(--text-dark);">${route.kmStart ? route.kmStart.toFixed(1) : 'N/A'}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm" style="color: var(--text-dark);">${kmFinalStr}</td>
                        <td class="px-2 py-4 text-sm max-w-xs truncate" style="color: var(--text-dark);" title="${route.startLocation?.address || 'Endereço Indisponível'}">${route.startLocation?.address || 'Endereço Indisponível'}</td>
                        <td class="px-2 py-4 text-sm max-w-xs truncate" style="color: var(--text-dark);" title="${endAddress}">${endAddress}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${startPhotoBtn}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${endPhotoBtn}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-center">${deleteBtn}</td>
                    </tr>
                `;
                adminTableBody.insertAdjacentHTML('beforeend', newRow);
            });
            
            // Se houver rotas em andamento, garante que o timer de atualização de tempo esteja ligado.
            if (routes.some(r => r.status === 'In Progress')) {
                 startLiveTimer();
            } else {
                 stopLiveTimer();
            }
        }

        // --- Lógica Principal ---
        let allRoutesData = [];

        window.showDriverView = function() {
            adminView.classList.add('hidden');
            driverView.classList.remove('hidden');
            document.getElementById('show-driver-btn').classList.add('active');
            document.getElementById('show-admin-btn').classList.remove('active');
            listenForCurrentTrip();
            stopLiveTimer(); // NOVO: Para o timer de tempo real quando sai do admin
        }

        window.showAdminView = function() {
            driverView.classList.add('hidden');
            adminView.classList.remove('hidden');
            document.getElementById('show-driver-btn').classList.remove('active');
            document.getElementById('show-admin-btn').classList.add('active');
            
            if (!adminLoginArea.classList.contains('hidden')) {
                // Não logado, aguarda a senha
            } else {
                listenForAdminRoutes();
            }
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Usuário autenticado:", userId);
                        listenForCurrentTrip();
                    } else {
                        signInAnonymously(auth).then(credential => {
                            userId = credential.user.uid;
                            console.log("Autenticação anônima de novo usuário:", userId);
                            listenForCurrentTrip();
                        }).catch(error => {
                            console.error("Erro na autenticação anônima:", error);
                            displayMessage("Erro de autenticação. Tente novamente.", 'error');
                        });
                    }
                });
            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                displayMessage(`Falha na inicialização. Verifique o console. ${error.message}`, 'error');
            }
        }

        async function listenForCurrentTrip() {
            if (!db || !userId) return;

            const q = query(
                collection(db, ROUTES_COLLECTION_PATH),
                where('userId', '==', userId),
                where('status', '==', 'In Progress')
            );

            onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const tripDoc = snapshot.docs[0];
                    currentTripDocId = tripDoc.id;
                    localStorage.setItem('currentTripDocId', currentTripDocId);
                    updateDriverUI(tripDoc.data());
                } else {
                    currentTripDocId = null;
                    localStorage.removeItem('currentTripDocId');
                    updateDriverUI(null);
                }
            }, (error) => {
                console.error("Erro ao buscar viagem em andamento:", error);
                updateDriverUI(null);
            });
        }

        async function listenForAdminRoutes() {
            if (!db) return; 
            // MODIFICADO: Busca rotas em andamento E concluídas
            const q = query(
                collection(db, ROUTES_COLLECTION_PATH),
                where('status', 'in', ['Completed', 'In Progress']) 
            );
            
            onSnapshot(q, (snapshot) => {
                allRoutesData = [];
                snapshot.forEach((doc) => {
                    allRoutesData.push({ id: doc.id, ...doc.data() });
                });
                applyAdminFilters(); // Aplica filtros e renderiza
            }, (error) => {
                console.error("Erro ao monitorar rotas administrativas:", error);
                adminTableBody.innerHTML = '<tr><td colspan="13" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>';
            });
        }

        window.deleteRoute = async function(routeId) {
            if (!db) {
                displayMessage('Sistema não inicializado.', 'error');
                return;
            }
            displayMessage(`Excluindo rota ID: ${routeId}...`, 'info');
            try {
                const routeRef = doc(db, ROUTES_COLLECTION_PATH, routeId);
                await deleteDoc(routeRef);
                displayMessage(`Rota ID ${routeId} excluída com sucesso! A tabela será atualizada.`, 'success');
            } catch (error) {
                console.error("Erro ao excluir documento:", error);
                displayMessage(`Falha ao excluir a rota. Erro: ${error.message}`, 'error');
            }
        }

        // --- Lógica do Motorista (Inalterada) ---
        window.startTrip = async function() {
            if (!db || !userId) {
                displayMessage('Sistema não inicializado. Verifique a conexão com o Firebase.', 'error');
                return;
            }

            const driverName = document.getElementById('driver-name').value.trim();
            const licensePlate = document.getElementById('license-plate').value.trim().toUpperCase();
            const kmStart = parseFloat(document.getElementById('km-start').value);

            if (!driverName || !licensePlate || isNaN(kmStart) || kmStart <= 0) {
                displayMessage('Por favor, preencha todos os campos corretamente: Nome, Placa e KM Inicial válido (> 0).', 'error');
                return;
            }

            if (!startPhotoBase64) {
                displayMessage('A foto do painel/odômetro na SAÍDA é obrigatória. Por favor, anexe a foto.', 'error');
                return;
            }

            displayMessage('Buscando localização e endereço de saída, registrando foto e iniciando viagem...', 'info');

            try {
                const location = await getGeolocation();
                const address = await getStreetAndNeighborhood(location.lat, location.lon);

                const newRouteRef = doc(collection(db, ROUTES_COLLECTION_PATH));
                const newTripData = {
                    driverName: driverName,
                    licensePlate: licensePlate,
                    kmStart: kmStart,
                    startTime: Timestamp.now(),
                    startLocation: { ...location, address: address }, 
                    startPhoto: startPhotoBase64,
                    userId: userId,
                    status: 'In Progress',
                    kmEnd: null,
                    endTime: null,
                    endLocation: null,
                    endPhoto: null,
                    elapsedTimeSeconds: null
                };

                await setDoc(newRouteRef, newTripData);

                currentTripDocId = newRouteRef.id;
                localStorage.setItem('currentTripDocId', currentTripDocId);
                startPhotoBase64 = null;
                document.getElementById('photo-start').value = '';

                displayMessage(`Viagem iniciada com sucesso em ${address} (com foto)!`, 'success');
            } catch (error) {
                console.error("Erro ao iniciar a viagem:", error);
                displayMessage(`Falha ao registrar saída. ${error.message || 'Verifique o console para detalhes.'}`, 'error');
            }
        }

        window.endTrip = async function() {
            if (!db || !currentTripDocId) {
                displayMessage('Nenhuma viagem em andamento para finalizar.', 'error');
                return;
            }

            const kmEnd = parseFloat(document.getElementById('km-end').value);

            if (isNaN(kmEnd) || kmEnd <= 0) {
                displayMessage('Por favor, insira um KM Final válido.', 'error');
                return;
            }

            if (!endPhotoBase64) {
                displayMessage('A foto do painel/odômetro na CHEGADA é obrigatória. Por favor, anexe a foto.', 'error');
                return;
            }

            displayMessage('Buscando localização final, endereço e salvando foto de chegada...', 'info');

            try {
                const docRef = doc(db, ROUTES_COLLECTION_PATH, currentTripDocId);

                const currentTripSnapshot = await getDocs(query(collection(db, ROUTES_COLLECTION_PATH), where('__name__', '==', currentTripDocId)));
                if (currentTripSnapshot.empty) {
                    displayMessage('Viagem não encontrada no banco de dados. Limpando estado local.', 'error');
                    localStorage.removeItem('currentTripDocId');
                    currentTripDocId = null;
                    return;
                }
                const currentTripData = currentTripSnapshot.docs[0].data();

                if (kmEnd < currentTripData.kmStart) {
                    displayMessage(`O KM Final (${kmEnd}) deve ser maior que o KM Inicial (${currentTripData.kmStart}).`, 'error');
                    return;
                }

                const endLocation = await getGeolocation();
                const endAddress = await getStreetAndNeighborhood(endLocation.lat, endLocation.lon);

                const endTime = Timestamp.now();
                const startTime = currentTripData.startTime.toDate().getTime();
                const elapsedTimeSeconds = Math.floor((endTime.toDate().getTime() - startTime) / 1000);

                const updateData = {
                    kmEnd: kmEnd,
                    endTime: endTime,
                    endLocation: { ...endLocation, address: endAddress }, 
                    endPhoto: endPhotoBase64,
                    elapsedTimeSeconds: elapsedTimeSeconds,
                    status: 'Completed'
                };

                await updateDoc(docRef, updateData);

                localStorage.removeItem('currentTripDocId');
                currentTripDocId = null;
                endPhotoBase64 = null; 
                document.getElementById('photo-end').value = ''; 

                displayMessage(`Viagem finalizada com sucesso em ${endAddress} (com foto)! Tempo: ${formatTime(elapsedTimeSeconds)}`, 'success');
            } catch (error) {
                console.error("Erro ao finalizar a viagem:", error);
                displayMessage(`Falha ao registrar chegada. ${error.message || 'Verifique o console para detalhes.'}`, 'error');
            }
        }

        // --- Lógica Administrativa ---
        window.adminLogin = function() {
            const password = document.getElementById('admin-password').value;
            loginErrorMessage.classList.add('hidden');

            if (password === ADMIN_PASSWORD) {
                adminLoginArea.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                listenForAdminRoutes();
                startLiveTimer(); // NOVO: Inicia o timer de tempo real
                displayMessage('Acesso Administrativo concedido.', 'success');
            } else {
                loginErrorMessage.classList.remove('hidden');
                displayMessage('Senha incorreta.', 'error');
            }
        }

        window.applyAdminFilters = function() {
            const plate = document.getElementById('filter-plate').value.trim().toUpperCase();
            const startDateStr = document.getElementById('filter-start-date').value;
            const endDateStr = document.getElementById('filter-end-date').value;

            let filteredData = allRoutesData;

            if (plate) {
                filteredData = filteredData.filter(route => route.licensePlate.includes(plate));
            }

            if (startDateStr) {
                const startOfDay = new Date(startDateStr);
                startOfDay.setHours(0, 0, 0, 0);
                const startTimestamp = startOfDay.getTime();
                
                filteredData = filteredData.filter(route => 
                    route.startTime && route.startTime.toDate().getTime() >= startTimestamp
                );
            }

            if (endDateStr) {
                const endOfDay = new Date(endDateStr);
                endOfDay.setHours(23, 59, 59, 999);
                const endTimestamp = endOfDay.getTime();
                
                filteredData = filteredData.filter(route => 
                    route.startTime && route.startTime.toDate().getTime() <= endTimestamp
                );
            }

            // MODIFICADO: Classifica: Em andamento primeiro, depois por data de início (mais recente primeiro)
            filteredData.sort((a, b) => {
                const statusA = a.status === 'In Progress' ? 0 : 1;
                const statusB = b.status === 'In Progress' ? 0 : 1;
                
                if (statusA !== statusB) {
                    return statusA - statusB; 
                }
                
                // Se os status forem iguais, ordena por hora de início (mais recente primeiro)
                return b.startTime.toDate().getTime() - a.startTime.toDate().getTime();
            });

            renderAdminTable(filteredData);
        }

        window.exportToCSV = function() {
            const routesToExport = [];
            const rows = adminTableBody.querySelectorAll('tr');

            if (rows.length === 1 && rows[0].cells.length === 1) {
                displayMessage('Nenhum dado para exportar.', 'error');
                return;
            }
            
            // Assume que allRoutesData já está filtrado e ordenado pela última chamada a applyAdminFilters
            const dataToExport = allRoutesData;


            dataToExport.forEach(route => {
                const totalKm = route.kmEnd ? (route.kmEnd - route.kmStart).toFixed(1) : 'N/A (EM ROTA)';
                const elapsedTimeStr = route.elapsedTimeSeconds ? formatTime(route.elapsedTimeSeconds) : 'N/A (EM ROTA)';
                const startTimeStr = route.startTime ? route.startTime.toDate().toLocaleString('pt-BR') : 'N/A';
                const endTimeStr = route.endTime ? route.endTime.toDate().toLocaleString('pt-BR') : 'N/A (EM ROTA)';
                const startAddress = route.startLocation?.address || 'Endereço Indisponível';
                const endAddress = route.endLocation?.address || 'Endereço Indisponível (EM ROTA)';
                const startLat = route.startLocation ? route.startLocation.lat : 'N/A';
                const startLon = route.startLocation ? route.startLocation.lon : 'N/A';
                const endLat = route.endLocation ? route.endLocation.lat : 'N/A';
                const endLon = route.endLocation ? route.endLocation.lon : 'N/A';
                
                const startPhotoRef = route.startPhoto ? 'Anexado (Base64)' : 'N/A';
                const endPhotoRef = route.endPhoto ? 'Anexado (Base64)' : 'N/A (EM ROTA)';

                routesToExport.push([
                    route.driverName,
                    route.licensePlate,
                    startTimeStr,
                    endTimeStr,
                    startPhotoRef,
                    endPhotoRef,
                    totalKm,
                    elapsedTimeStr,
                    route.kmStart,
                    route.kmEnd,
                    startAddress.replace(/;/g, ','), 
                    endAddress.replace(/;/g, ','),   
                    startLat,
                    startLon,
                    endLat,
                    endLon
                ].map(item => `"${item}"`)); 
            });


            const header = [
                "Motorista", "Placa", "Data_Saida", "Data_Chegada", "Foto_Saida", 
                "Foto_Chegada", "KM_Total_Rodado", "Tempo_Decorrido", "KM_Inicial", 
                "KM_Final", "Local_Saida_Endereco", "Local_Chegada_Endereco", "Local_Saida_Lat", 
                "Local_Saida_Lon", "Local_Chegada_Lat", "Local_Chegada_Lon"
            ];

            const csvContent = [header.join(';'), ...routesToExport.map(r => r.join(';'))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `rotas_exportadas_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            displayMessage('Dados exportados com sucesso!', 'success');
        }

        // Event Listeners para navegação
        document.getElementById('show-driver-btn').addEventListener('click', window.showDriverView);
        document.getElementById('show-admin-btn').addEventListener('click', window.showAdminView);

        // Inicia o sistema
        initFirebase().then(() => {
            console.log("Sistema inicializado.");
        });
    </script>
</body>
</html>
