<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IcaphiDrive Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; }
        .input-style { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; width: 100%; padding: 0.75rem; border-radius: 0.75rem; outline: none; font-size: 14px; }
        .btn-primary { background: #2563eb; transition: all 0.2s; }
        .glass-modal { background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 200; }
        #loading-screen { transition: opacity 0.5s ease-out; }
        .truck-container { animation: truckDrive 2s infinite ease-in-out; }
        @keyframes truckDrive { 0% { transform: translateX(-50px); opacity: 0; } 50% { transform: translateX(0px); opacity: 1; } 100% { transform: translateX(50px); opacity: 0; } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .filter-btn.active { background: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        .badge-em-viagem { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <div id="loading-screen" class="hidden fixed inset-0 z-[300] bg-[#020617] flex flex-col items-center justify-center">
        <div class="truck-container text-blue-500"><i data-lucide="truck" class="w-16 h-16"></i></div>
        <p class="text-blue-500 font-bold tracking-widest text-[10px] uppercase mt-6">Processando...</p>
    </div>

    <header class="flex justify-between items-center py-6">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-blue-500 italic">ICAPHI<span class="text-white">DRIVE</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Controle de Frota</p>
        </div>
        <div class="flex gap-2">
            <button onclick="abrirTutorial()" class="flex items-center gap-1 px-3 py-2 card border-slate-700 text-[10px] font-bold uppercase text-slate-400">
                <i data-lucide="help-circle" class="w-3 h-3 text-blue-400"></i> Guia
            </button>
            <button onclick="acessoAdmin()" class="p-3 card border-slate-700 active:bg-slate-800 transition">
                <i data-lucide="shield-lock" class="text-blue-400 w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div id="modal-tutorial" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-6">
            <h3 class="font-bold text-center text-lg">Guia do Motorista</h3>
            <div class="space-y-4 text-sm text-slate-300">
                <p>1. Selecione o Tipo de Viagem.</p>
                <p>2. Informe Nome, Placa e KM Inicial.</p>
                <p>3. Tire foto do painel e inicie a viagem.</p>
                <p>4. No destino, informe KM Final e foto final para encerrar.</p>
            </div>
            <button onclick="fecharTutorial()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">ENTENDI!</button>
        </div>
    </div>

    <main id="tela-inicio" class="fade-in space-y-6">
        <div class="card p-6 border-t-4 border-t-blue-600 shadow-xl">
            <h2 class="text-lg font-semibold mb-5 flex items-center gap-2"><i data-lucide="play" class="text-emerald-400 w-4 h-4"></i> Iniciar Viagem</h2>
            <div class="space-y-4">
                <select id="tipo-viagem" class="input-style">
                    <option value="" disabled selected>Selecione o Tipo de Viagem</option>
                    <option value="Saida Dia">Saida Dia</option>
                    <option value="Apoio">Apoio</option>
                    <option value="Seg. Viagem">Seg. Viagem</option>
                    <option value="Pernoite/Viagem">Pernoite/Viagem</option>
                </select>
                <input type="text" id="motorista" placeholder="Nome do Motorista" class="input-style">
                <input type="text" id="placa" placeholder="Placa" class="input-style uppercase font-mono">
                <input type="number" id="km-inicio" placeholder="KM Inicial" class="input-style">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                    <span class="text-sm text-slate-400" id="label-foto-inicio">Foto Painel In√≠cio</span>
                    <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-inicio')">
                </label>
                <button onclick="iniciarViagem()" class="w-full btn-primary py-4 rounded-xl font-bold">INICIAR AGORA</button>
            </div>
        </div>
    </main>

    <main id="tela-viagem" class="hidden fade-in space-y-6 py-10 text-center">
        <div class="relative flex flex-col items-center justify-center">
            <div class="w-64 h-64 rounded-full border-4 border-blue-600/10 border-t-blue-500 animate-spin absolute"></div>
            <div class="w-56 h-56 rounded-full flex flex-col items-center justify-center bg-slate-900 z-10">
                <h3 id="cronometro-motorista" class="text-5xl font-mono font-bold">00:00:00</h3>
            </div>
        </div>
        <button onclick="abrirModalObs()" class="w-full bg-slate-800 border border-slate-700 py-3 rounded-xl flex items-center justify-center gap-2 font-bold text-blue-400">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> ADICIONAR OBSERVA√á√ÉO
        </button>
        <div class="card p-6 border-t-4 border-t-red-600 text-left space-y-4">
            <p id="info-viagem-ativa" class="text-center font-bold text-slate-400 uppercase text-xs"></p>
            <input type="number" id="km-fim" placeholder="KM Final" class="input-style">
            <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                <span class="text-sm text-slate-400" id="label-foto-fim">Foto Painel Fim</span>
                <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-fim')">
            </label>
            <button onclick="finalizarViagem()" class="w-full bg-red-600 py-4 rounded-xl font-bold">ENCERRAR VIAGEM</button>
        </div>
    </main>

    <main id="tela-admin" class="hidden fade-in space-y-4 pb-10">
        <div class="sticky top-0 bg-[#020617] pt-4 pb-2 z-20 space-y-4">
            <div class="flex items-center justify-between">
                <button onclick="mudarTela('inicio')" class="p-2 bg-slate-800 rounded-lg"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-bold text-blue-500">Hist√≥rico</h2>
                <button onclick="abrirModalExport()" class="p-3 bg-emerald-600 rounded-xl"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i></button>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="setFiltroStatus('TUDO')" id="btn-filtro-tudo" class="filter-btn active px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">TUDO</button>
                <button onclick="setFiltroStatus('em_curso')" id="btn-filtro-em_curso" class="filter-btn px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">EM CURSO</button>
                <button onclick="setFiltroStatus('finalizada')" id="btn-filtro-finalizada" class="filter-btn px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">FINALIZADAS</button>
            </div>
            <input type="text" id="busca-admin" oninput="renderizarAdmin()" placeholder="Buscar motorista ou placa..." class="input-style text-xs">
        </div>
        <div id="lista-viagens" class="space-y-4"></div>
    </main>

    <div id="modal-fim-viagem" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-8 w-full max-w-sm space-y-6 text-center border-emerald-500/30">
            <div class="flex justify-center text-emerald-500"><i data-lucide="check-circle" class="w-16 h-16"></i></div>
            <h3 class="text-xl font-bold uppercase">Viagem Encerrada!</h3>
            <p class="text-sm text-slate-400" id="resumo-fim"></p>
            <div class="space-y-3">
                <button id="btn-share" class="w-full bg-blue-600 py-4 rounded-xl font-bold flex items-center justify-center gap-2">
                    <i data-lucide="share-2" class="w-5 h-5"></i> COMPARTILHAR
                </button>
                <button onclick="location.reload()" class="w-full bg-slate-800 py-4 rounded-xl font-bold text-slate-300">
                    VOLTAR AO IN√çCIO
                </button>
            </div>
        </div>
    </div>

    <div id="modal-obs" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4">
            <h3 class="font-bold text-center text-blue-400">Nova Observa√ß√£o</h3>
            <select id="obs-assunto" class="input-style">
                <option value="Descarga">Descarga</option>
                <option value="Segundo Ajudante">Segundo Ajudante</option>
                <option value="Balsa">Balsa</option>
                <option value="Ped√°gio">Ped√°gio</option>
                <option value="Outros">Outros</option>
            </select>
            <textarea id="obs-texto" placeholder="Descreva aqui..." class="input-style h-24"></textarea>
            <input type="number" id="obs-valor" placeholder="Valor (R$)" class="input-style">
            <div class="flex gap-2">
                <button onclick="fecharModalObs()" class="flex-1 text-slate-500 font-bold">CANCELAR</button>
                <button onclick="salvarObservacao()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="modal-ver-obs" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm max-h-[80vh] flex flex-col">
            <h3 class="font-bold text-center text-blue-400 mb-4 uppercase">Observa√ß√µes</h3>
            <div id="lista-obs-render" class="flex-1 overflow-y-auto space-y-3 pr-2"></div>
            <button onclick="document.getElementById('modal-ver-obs').classList.add('hidden')" class="w-full bg-slate-800 py-3 rounded-xl mt-4 font-bold">FECHAR</button>
        </div>
    </div>

    <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4 shadow-2xl">
            <h3 class="font-bold text-center">Exportar Relat√≥rio</h3>
            <select id="select-placa-export" class="input-style"></select>
            <div class="grid grid-cols-2 gap-2">
                <input type="date" id="data-exp-inicio" class="input-style text-xs">
                <input type="date" id="data-exp-fim" class="input-style text-xs">
            </div>
            <button onclick="gerarExcel()" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">BAIXAR EXCEL</button>
            <button onclick="fecharModalExport()" class="w-full text-slate-500 text-sm">CANCELAR</button>
        </div>
    </div>

    <div id="modal-img" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-4" onclick="this.classList.add('hidden')">
        <img id="img-full" class="rounded-2xl max-h-[80vh] border-2 border-slate-700">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
            authDomain: "marcador-ponto-digital.firebaseapp.com",
            projectId: "marcador-ponto-digital",
            storageBucket: "marcador-ponto-digital.firebasestorage.app",
            messagingSenderId: "774324665760",
            appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let idAtual = localStorage.getItem('icaphidrive_viagem_id');
        let listaGlobalViagens = [];
        let statusSelecionado = 'TUDO';

        const toggleLoading = (s) => {
            const el = document.getElementById('loading-screen');
            if(s) { el.classList.remove('hidden'); el.style.opacity = "1"; }
            else { el.style.opacity = "0"; setTimeout(() => el.classList.add('hidden'), 500); }
        };

        const formatarTempo = (s) => {
            const h = Math.floor(s / 3600).toString().padStart(2, '0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${h}:${m}:${sec}`;
        };

        window.mudarTela = (t) => {
            toggleLoading(true);
            setTimeout(() => {
                ['tela-inicio', 'tela-viagem', 'tela-admin'].forEach(x => document.getElementById(x).classList.add('hidden'));
                document.getElementById('tela-' + t).classList.remove('hidden');
                lucide.createIcons(); toggleLoading(false);
            }, 600);
        };

        window.abrirTutorial = () => document.getElementById('modal-tutorial').classList.remove('hidden');
        window.fecharTutorial = () => document.getElementById('modal-tutorial').classList.add('hidden');

        window.abrirModalObs = () => document.getElementById('modal-obs').classList.remove('hidden');
        window.fecharModalObs = () => { document.getElementById('modal-obs').classList.add('hidden'); document.getElementById('obs-texto').value = ""; document.getElementById('obs-valor').value = ""; };
        window.salvarObservacao = async () => {
            const ass = document.getElementById('obs-assunto').value, txt = document.getElementById('obs-texto').value, val = document.getElementById('obs-valor').value;
            if(!txt) return alert("Escreva a observa√ß√£o!");
            toggleLoading(true);
            try {
                await updateDoc(doc(db, "viagens", idAtual), {
                    observacoes: arrayUnion({ assunto: ass, texto: txt, valor: val ? parseFloat(val).toFixed(2) : "0.00", data: new Date().toLocaleString() })
                });
                fecharModalObs(); alert("Salvo!");
            } catch (e) { alert("Erro."); }
            toggleLoading(false);
        };

        window.verObservacoesAdmin = (id) => {
            const v = listaGlobalViagens.find(x => x.id === id);
            const container = document.getElementById('lista-obs-render');
            container.innerHTML = "";
            if(!v.observacoes || v.observacoes.length === 0) container.innerHTML = "<p class='text-center text-slate-500 text-sm'>Nenhuma observa√ß√£o.</p>";
            else v.observacoes.forEach(o => {
                container.innerHTML += `<div class="bg-slate-800 p-3 rounded-xl border-l-4 border-blue-500"><div class="flex justify-between items-center text-[10px] font-bold mb-1"><span class="text-blue-400 uppercase">${o.assunto}</span><span class="text-slate-500">${o.data}</span></div><p class="text-xs text-slate-200">${o.texto}</p><p class="text-sm font-bold text-emerald-400 mt-2">R$ ${o.valor}</p></div>`;
            });
            document.getElementById('modal-ver-obs').classList.remove('hidden');
        };

        window.setFiltroStatus = (s) => {
            statusSelecionado = s;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(s === 'TUDO' ? 'btn-filtro-tudo' : `btn-filtro-${s}`).classList.add('active');
            renderizarAdmin();
        };

        window.renderizarAdmin = () => {
            const container = document.getElementById('lista-viagens');
            const busca = document.getElementById('busca-admin').value.toLowerCase();
            container.innerHTML = "";
            const filtrados = listaGlobalViagens.filter(v => {
                const matchStatus = statusSelecionado === 'TUDO' || v.status === statusSelecionado;
                const matchBusca = v.nome.toLowerCase().includes(busca) || v.placa.toLowerCase().includes(busca);
                return matchStatus && matchBusca;
            });

            filtrados.forEach(v => {
                const isEmCurso = v.status === 'em_curso';
                const inicioMS = v.dataInicio.toDate().getTime();
                const totalObs = v.observacoes ? v.observacoes.length : 0;
                container.innerHTML += `
                    <div class="card p-5 space-y-4 fade-in">
                        <div class="flex justify-between items-start">
                            <span class="text-[9px] bg-blue-500/10 text-blue-400 px-2 py-1 rounded-md font-extrabold uppercase">${v.tipoViagem || 'Viagem'}</span>
                            <div class="flex gap-2">
                                <span class="text-[9px] px-2 py-1 rounded-full font-bold uppercase ${isEmCurso ? 'badge-em-viagem' : 'bg-emerald-500/10 text-emerald-500'}">${v.status}</span>
                                <button onclick="excluirViagem('${v.id}')" class="text-slate-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-col">
                            <h3 class="font-bold text-lg uppercase leading-none">${v.nome}</h3>
                            <p class="text-blue-400 font-mono text-[10px] uppercase mt-1">${v.placa}</p>
                        </div>
                        <div class="bg-slate-950/40 p-3 rounded-xl text-center border border-slate-800/50">
                            <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Dura√ß√£o da Viagem</p>
                            <span class="font-mono text-xl font-bold ${isEmCurso ? 'text-blue-400 cronometro-admin-live' : 'text-slate-300'}" data-inicio="${inicioMS}">${isEmCurso ? '00:00:00' : v.duracao}</span>
                        </div>
                        <button onclick="verObservacoesAdmin('${v.id}')" class="w-full bg-slate-800 border border-slate-700 py-2 rounded-lg text-[10px] font-bold flex items-center justify-center gap-2">
                            <i data-lucide="message-square" class="w-3 h-3 text-blue-400"></i> VER OBS (${totalObs})
                        </button>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div><p class="text-slate-500 text-[9px] uppercase">KM In√≠cio</p><p class="font-bold">${v.kmInicio} km</p></div>
                            <div><p class="text-slate-500 text-[9px] uppercase">KM Fim</p><p class="font-bold">${v.kmFim || '--'} km</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="verFoto('${v.fotoInicio}')" class="bg-slate-800 py-2 rounded-lg text-[10px] font-bold">FOTO IN√çCIO</button>
                            ${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="bg-slate-800 py-2 rounded-lg text-[10px] font-bold">FOTO FIM</button>` : ''}
                        </div>
                        <div class="flex justify-between items-center text-[10px] border-t border-slate-800/50 pt-3">
                            <div class="flex gap-3">
                                <span onclick="window.open('https://www.google.com/maps/search/?api=1&query=${v.locInicio}')" class="text-blue-400 font-bold cursor-pointer uppercase">üìç Mapa In√≠cio</span>
                                ${v.locFim ? `<span onclick="window.open('https://www.google.com/maps/search/?api=1&query=${v.locFim}')" class="text-emerald-400 font-bold cursor-pointer uppercase">üìç Mapa Fim</span>` : ''}
                            </div>
                            <span class="text-slate-500">${v.dataInicio.toDate().toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        };

        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => {
            listaGlobalViagens = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderizarAdmin();
        });

        setInterval(() => {
            document.querySelectorAll('.cronometro-admin-live').forEach(el => {
                const inicio = parseInt(el.getAttribute('data-inicio'));
                el.innerText = formatarTempo(Math.floor((new Date().getTime() - inicio) / 1000));
            });
        }, 1000);

        window.iniciarViagem = async () => {
            const t = document.getElementById('tipo-viagem').value, n = document.getElementById('motorista').value, p = document.getElementById('placa').value.toUpperCase(), k = document.getElementById('km-inicio').value, f = document.getElementById('foto-inicio').files[0];
            if(!t || !n || !p || !k || !f) return alert("Preencha todos os campos e selecione o tipo!");
            toggleLoading(true);
            const fotoC = await compressImage(f), loc = await getLoc(), agora = new Date();
            const docRef = await addDoc(collection(db, "viagens"), { 
                tipoViagem: t, nome: n, placa: p, kmInicio: parseFloat(k), fotoInicio: fotoC, locInicio: loc, status: 'em_curso', dataInicio: agora, observacoes: [] 
            });
            localStorage.setItem('icaphidrive_viagem_id', docRef.id);
            location.reload();
        };

        window.finalizarViagem = async () => {
            const kF = document.getElementById('km-fim').value, f = document.getElementById('foto-fim').files[0];
            if(!kF || !f) return alert("Complete os dados!");
            toggleLoading(true);
            const fotoC = await compressImage(f), loc = await getLoc(), dur = document.getElementById('cronometro-motorista').innerText;
            const snap = await getDoc(doc(db, "viagens", idAtual));
            const vData = snap.data();
            
            await updateDoc(doc(db, "viagens", idAtual), { kmFim: parseFloat(kF), fotoFim: fotoC, locFim: loc, status: 'finalizada', dataFim: new Date(), duracao: dur });
            
            localStorage.removeItem('icaphidrive_viagem_id');
            toggleLoading(false);

            // Montar resumo para compartilhar
            const resumo = `üöõ *RELAT√ìRIO ICAPHIDRIVE*\n\n*Motorista:* ${vData.nome}\n*Placa:* ${vData.placa}\n*Tipo:* ${vData.tipoViagem}\n*KM Inicial:* ${vData.kmInicio}\n*KM Final:* ${kF}\n*Dura√ß√£o:* ${dur}`;
            document.getElementById('resumo-fim').innerText = `Motorista: ${vData.nome} | Placa: ${vData.placa}`;
            document.getElementById('modal-fim-viagem').classList.remove('hidden');
            
            document.getElementById('btn-share').onclick = () => {
                if(navigator.share) {
                    navigator.share({ title: 'Relat√≥rio de Viagem', text: resumo });
                } else {
                    window.open(`https://wa.me/?text=${encodeURIComponent(resumo)}`);
                }
            };
            lucide.createIcons();
        };

        window.abrirModalExport = () => {
            const sel = document.getElementById('select-placa-export');
            sel.innerHTML = '<option value="TODAS">Todas as Placas</option>';
            const placas = [...new Set(listaGlobalViagens.map(v => v.placa.toUpperCase()))].sort();
            placas.forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('modal-export').classList.remove('hidden');
        };

        window.fecharModalExport = () => document.getElementById('modal-export').classList.add('hidden');
        window.gerarExcel = () => {
            const pS = document.getElementById('select-placa-export').value;
            const dI = document.getElementById('data-exp-inicio').value;
            const dF = document.getElementById('data-exp-fim').value;
            const dados = listaGlobalViagens.filter(v => {
                const dataV = v.dataInicio.toDate();
                let match = (pS === "TODAS" || v.placa === pS);
                if(dI && dF) {
                    const s = new Date(dI + "T00:00:00"), e = new Date(dF + "T23:59:59");
                    match = match && (dataV >= s && dataV <= e);
                }
                return match;
            }).map(v => ({ Tipo: v.tipoViagem, Motorista: v.nome, Placa: v.placa, KM_I: v.kmInicio, KM_F: v.kmFim || "", Tempo: v.duracao || "" }));
            const ws = XLSX.utils.json_to_sheet(dados); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Relatorio");
            XLSX.writeFile(wb, "Relatorio_Icaphi.xlsx");
        };

        const compressImage = (f) => new Promise(r => {
            const fr = new FileReader(); fr.readAsDataURL(f);
            fr.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const w = 800; const s = w / img.width;
                    c.width = w; c.height = img.height * s;
                    c.getContext('2d').drawImage(img, 0, 0, c.width, c.height); r(c.toDataURL('image/jpeg', 0.6));
                };
            };
        });

        const getLoc = () => new Promise(r => { navigator.geolocation.getCurrentPosition(p => r(`${p.coords.latitude},${p.coords.longitude}`), () => r("Sem GPS")); });
        window.acessoAdmin = () => { if(prompt("Senha:") === "60010774") mudarTela('admin'); };
        window.verFoto = (s) => { document.getElementById('img-full').src = s; document.getElementById('modal-img').classList.remove('hidden'); };
        window.excluirViagem = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "viagens", id)); };
        window.previewFoto = (i, l) => { if(i.files[0]) document.getElementById(l).innerText = "Foto ‚úÖ"; };

        window.addEventListener('load', async () => {
            if (idAtual) {
                const docSnap = await getDoc(doc(db, "viagens", idAtual));
                if (docSnap.exists() && docSnap.data().status === 'em_curso') {
                    mudarTela('viagem');
                    document.getElementById('info-viagem-ativa').innerText = `${docSnap.data().nome}`;
                    setInterval(() => {
                        const diff = Math.floor((new Date().getTime() - docSnap.data().dataInicio.toDate().getTime()) / 1000);
                        document.getElementById('cronometro-motorista').innerText = formatarTempo(diff);
                    }, 1000);
                }
            }
            lucide.createIcons();
        });
    </script>
</body>
</html>
