<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IcaphiDrive Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; }
        .input-style { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; width: 100%; padding: 0.75rem; border-radius: 0.75rem; outline: none; font-size: 14px; }
        .btn-primary { background: #2563eb; transition: all 0.2s; }
        .glass-modal { background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 100; }
        
        /* ANIMA√á√ÉO DO CARREGAMENTO */
        #loading-screen { transition: opacity 0.5s ease-out; }
        .truck-container { animation: truckDrive 2s infinite ease-in-out; }
        @keyframes truckDrive {
            0% { transform: translateX(-40px); opacity: 0; }
            50% { transform: translateX(0px); opacity: 1; }
            100% { transform: translateX(40px); opacity: 0; }
        }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .badge-em-viagem { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.2); }
        .step-number { background: #2563eb; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; flex-shrink: 0; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <div id="loading-screen" class="hidden fixed inset-0 z-[200] bg-[#020617] flex flex-col items-center justify-center">
        <div class="truck-container text-blue-500">
            <i data-lucide="truck" class="w-16 h-16"></i>
        </div>
        <p class="text-blue-500 font-bold tracking-widest text-[10px] uppercase mt-6">IcaphiDrive Processando...</p>
    </div>

    <header class="flex justify-between items-center py-6">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-blue-500 italic">ICAPHI<span class="text-white">DRIVE</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Controle de Frota</p>
        </div>
        <div class="flex gap-2">
            <button onclick="abrirTutorial()" class="flex items-center gap-1 px-3 py-2 card border-slate-700 text-[10px] font-bold uppercase text-slate-400">
                <i data-lucide="help-circle" class="w-3 h-3 text-blue-400"></i> Tutorial
            </button>
            <button onclick="acessoAdmin()" class="p-3 card border-slate-700 active:bg-slate-800 transition">
                <i data-lucide="shield-lock" class="text-blue-400 w-5 h-5"></i>
            </button>
        </div>
    </header>

    <div id="modal-tutorial" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6 overflow-y-auto">
        <div class="card p-6 w-full max-w-sm space-y-6">
            <div class="text-center">
                <i data-lucide="book-open" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                <h3 class="font-bold text-lg">Como usar o IcaphiDrive</h3>
            </div>
            <div class="space-y-4">
                <div class="flex gap-3"><span class="step-number">1</span><p class="text-sm text-slate-300">Preencha nome, placa e o KM inicial do painel.</p></div>
                <div class="flex gap-3"><span class="step-number">2</span><p class="text-sm text-slate-300">Tire uma foto n√≠tida do od√¥metro no in√≠cio.</p></div>
                <div class="flex gap-3"><span class="step-number">3</span><p class="text-sm text-slate-300">Ao chegar, insira o KM Final e a foto de encerramento.</p></div>
            </div>
            <button onclick="fecharTutorial()" class="w-full bg-blue-600 py-3 rounded-xl font-bold">ENTENDI!</button>
        </div>
    </div>

    <main id="tela-inicio" class="fade-in space-y-6">
        <div class="card p-6 border-t-4 border-t-blue-600 shadow-2xl">
            <h2 class="text-lg font-semibold mb-5 flex items-center gap-2">
                <i data-lucide="play" class="text-emerald-400 fill-emerald-400 w-4 h-4"></i> Iniciar Viagem
            </h2>
            <div class="space-y-4">
                <input type="text" id="motorista" placeholder="Nome do Motorista" class="input-style">
                <input type="text" id="placa" placeholder="Placa do Carro" class="input-style uppercase font-mono">
                <input type="number" id="km-inicio" placeholder="KM Inicial do Od√¥metro" class="input-style">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                    <i data-lucide="camera" class="text-slate-500 mb-2"></i>
                    <span class="text-sm text-slate-400" id="label-foto-inicio">Foto do Painel (In√≠cio)</span>
                    <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-inicio')">
                </label>
                <button onclick="iniciarViagem()" id="btn-iniciar" class="w-full btn-primary py-4 rounded-xl font-bold">INICIAR AGORA</button>
            </div>
        </div>
    </main>

    <main id="tela-viagem" class="hidden fade-in space-y-8 py-10 text-center">
        <div class="relative flex flex-col items-center justify-center">
            <div class="w-64 h-64 rounded-full border-4 border-blue-600/10 border-t-blue-500 animate-spin absolute"></div>
            <div class="w-56 h-56 rounded-full flex flex-col items-center justify-center bg-slate-900 z-10">
                <h3 id="cronometro-motorista" class="text-5xl font-mono font-bold">00:00:00</h3>
            </div>
        </div>
        <div class="card p-6 border-t-4 border-t-red-600 text-left">
            <p id="info-viagem-ativa" class="text-[10px] text-slate-500 mb-4 uppercase font-bold text-center"></p>
            <input type="number" id="km-fim" placeholder="KM Final" class="input-style mb-4">
            <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-700 rounded-xl mb-6 bg-slate-800/20 cursor-pointer">
                <span class="text-sm text-slate-400" id="label-foto-fim">Foto do Painel (Fim)</span>
                <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-fim')">
            </label>
            <button onclick="finalizarViagem()" id="btn-finalizar" class="w-full bg-red-600 py-4 rounded-xl font-bold">ENCERRAR VIAGEM</button>
        </div>
    </main>

    <main id="tela-admin" class="hidden fade-in space-y-4 pb-10">
        <div class="flex items-center justify-between sticky top-0 bg-[#020617] py-4 z-20">
            <button onclick="mudarTela('inicio')" class="p-2 bg-slate-800 rounded-lg"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h2 class="text-xl font-bold text-blue-500">Hist√≥rico Admin</h2>
            <button onclick="abrirModalExport()" class="p-3 bg-emerald-600 rounded-xl shadow-lg shadow-emerald-900/20"><i data-lucide="file-spreadsheet" class="w-5 h-5"></i></button>
        </div>
        <div id="lista-viagens" class="space-y-4"></div>
    </main>

    <main id="tela-resumo" class="hidden fade-in space-y-6 py-10">
        <div id="dados-resumo-render" class="space-y-6"></div>
    </main>

    <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4 shadow-2xl">
            <h3 class="font-bold text-center text-lg">Exportar Relat√≥rio Excel</h3>
            <select id="select-placa-export" class="input-style"></select>
            <div class="grid grid-cols-2 gap-2">
                <input type="date" id="data-exp-inicio" class="input-style text-xs">
                <input type="date" id="data-exp-fim" class="input-style text-xs">
            </div>
            <button onclick="gerarExcel()" class="w-full bg-emerald-600 py-4 rounded-xl font-bold">BAIXAR EXCEL</button>
            <button onclick="fecharModalExport()" class="w-full text-slate-500 text-sm">Cancelar</button>
        </div>
    </div>

    <div id="modal-img" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-4" onclick="this.classList.add('hidden')">
        <img id="img-full" class="rounded-2xl max-h-[80vh] border-2 border-slate-700 shadow-2xl">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U",
            authDomain: "marcador-ponto-digital.firebaseapp.com",
            projectId: "marcador-ponto-digital",
            storageBucket: "marcador-ponto-digital.firebasestorage.app",
            messagingSenderId: "774324665760",
            appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let idAtual = localStorage.getItem('icaphidrive_viagem_id');
        let resumoObjeto = JSON.parse(localStorage.getItem('icaphidrive_resumo')) || {};
        let textoResumoGlobal = ""; 

        const toggleLoading = (show) => {
            const screen = document.getElementById('loading-screen');
            if(show) { screen.classList.remove('hidden'); screen.style.opacity = "1"; }
            else { screen.style.opacity = "0"; setTimeout(() => screen.classList.add('hidden'), 500); }
        };

        const formatarTempo = (s) => {
            const h = Math.floor(s / 3600).toString().padStart(2, '0');
            const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
            const sec = (s % 60).toString().padStart(2, '0');
            return `${h}:${m}:${sec}`;
        };

        window.mudarTela = (tela) => {
            toggleLoading(true);
            setTimeout(() => {
                ['tela-inicio', 'tela-viagem', 'tela-admin', 'tela-resumo'].forEach(t => document.getElementById(t).classList.add('hidden'));
                document.getElementById('tela-' + tela).classList.remove('hidden');
                lucide.createIcons();
                toggleLoading(false);
            }, 600);
        };

        window.iniciarViagem = async () => {
            const n = document.getElementById('motorista').value;
            const p = document.getElementById('placa').value;
            const k = document.getElementById('km-inicio').value;
            const f = document.getElementById('foto-inicio').files[0];
            if(!n || !p || !k || !f) return alert("Preencha todos os campos e a foto!");
            
            toggleLoading(true);
            const fotoC = await compressImage(f);
            const loc = await getLoc();
            const agora = new Date();
            const docRef = await addDoc(collection(db, "viagens"), {
                nome: n, placa: p, kmInicio: parseFloat(k), fotoInicio: fotoC, locInicio: loc, status: 'em_curso', dataInicio: agora
            });
            localStorage.setItem('icaphidrive_viagem_id', docRef.id);
            localStorage.setItem('icaphidrive_resumo', JSON.stringify({nome: n, placa: p, kmInicio: parseFloat(k), dataInicio: agora.toISOString()}));
            location.reload();
        };

        window.finalizarViagem = async () => {
            const kF = document.getElementById('km-fim').value;
            const f = document.getElementById('foto-fim').files[0];
            if(!kF || !f) return alert("Insira o KM final e a foto!");
            
            toggleLoading(true);
            const fotoC = await compressImage(f);
            const loc = await getLoc();
            const dur = document.getElementById('cronometro-motorista').innerText;
            const dist = parseFloat(kF) - resumoObjeto.kmInicio;
            const agoraFim = new Date();
            const dataInicio = new Date(resumoObjeto.dataInicio);

            await updateDoc(doc(db, "viagens", idAtual), {
                kmFim: parseFloat(kF), dispersao: dist, fotoFim: fotoC, locFim: loc, status: 'finalizada', dataFim: agoraFim, duracao: dur
            });

            const horaIni = dataInicio.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            const horaFim = agoraFim.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});

            textoResumoGlobal = `üìä *ICAPHIDRIVE PRO*\nüìÖ *Data:* ${dataInicio.toLocaleDateString()}\nüë§ *Motorista:* ${resumoObjeto.nome}\nüöó *Placa:* ${resumoObjeto.placa.toUpperCase()}\n\nüõ´ *In√≠cio:* ${horaIni} (${resumoObjeto.kmInicio} km)\nüõ¨ *Fim:* ${horaFim} (${kF} km)\n‚è±Ô∏è *Tempo:* ${dur}\nüõ£Ô∏è *Total:* ${dist.toFixed(1)} km`;

            localStorage.removeItem('icaphidrive_viagem_id');
            localStorage.removeItem('icaphidrive_resumo');
            
            document.getElementById('dados-resumo-render').innerHTML = `
                <div class="card p-6 bg-slate-900/50 space-y-3">
                    <h2 class="text-xl font-bold border-b border-slate-800 pb-2">Resumo da Viagem</h2>
                    <p class="text-sm">Data: <span class="text-white">${dataInicio.toLocaleDateString()}</span></p>
                    <p class="text-sm">Motorista: <span class="text-white">${resumoObjeto.nome}</span></p>
                    <p class="text-sm">In√≠cio: <span class="text-white">${horaIni}</span> ‚Ä¢ Fim: <span class="text-white">${horaFim}</span></p>
                    <p class="text-sm">KM Total: <span class="text-emerald-400 font-bold">${dist.toFixed(1)} km</span></p>
                    <p class="text-sm">Dura√ß√£o: <span class="text-blue-400 font-mono">${dur}</span></p>
                </div>
                <button onclick="compartilharResumo()" class="w-full bg-blue-600 py-4 rounded-xl font-bold">COMPARTILHAR</button>
                <button onclick="location.reload()" class="w-full bg-slate-800 py-4 rounded-xl font-bold">VOLTAR AO IN√çCIO</button>`;
            mudarTela('resumo');
        };

        const compressImage = (file) => new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(file);
            r.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const w = 800; const scale = w / img.width;
                    canvas.width = w; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    res(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });

        const getLoc = () => new Promise(res => {
            navigator.geolocation.getCurrentPosition(p => res(`${p.coords.latitude},${p.coords.longitude}`), () => res("Sem GPS"), {enableHighAccuracy: true});
        });

        window.abrirTutorial = () => document.getElementById('modal-tutorial').classList.remove('hidden');
        window.fecharTutorial = () => document.getElementById('modal-tutorial').classList.add('hidden');
        window.previewFoto = (i, l) => { if(i.files[0]) document.getElementById(l).innerText = "Foto Selecionada ‚úÖ"; };
        window.acessoAdmin = () => { if(prompt("Senha:") === "60010774") mudarTela('admin'); };
        window.verFoto = (src) => { document.getElementById('img-full').src = src; document.getElementById('modal-img').classList.remove('hidden'); };
        window.excluirViagem = async (id) => { if(confirm("Apagar registro?")) await deleteDoc(doc(db, "viagens", id)); };
        window.compartilharResumo = () => navigator.share ? navigator.share({text: textoResumoGlobal}) : alert(textoResumoGlobal);

        // ATUALIZA√á√ÉO DO CRON√îMETRO ADMIN
        setInterval(() => {
            const agora = new Date().getTime();
            document.querySelectorAll('.cronometro-admin-real').forEach(el => {
                const inicio = parseInt(el.getAttribute('data-inicio'));
                el.innerText = formatarTempo(Math.floor((agora - inicio) / 1000));
            });
        }, 1000);

        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => {
            const list = document.getElementById('lista-viagens');
            list.innerHTML = "";
            snap.forEach(d => {
                const v = d.data();
                const isEmCurso = v.status === 'em_curso';
                const inicioMS = v.dataInicio.toDate().getTime();
                list.innerHTML += `
                    <div class="card p-5 space-y-3 relative overflow-hidden fade-in">
                        <div class="flex justify-between items-start">
                            <div><h3 class="font-bold uppercase">${v.nome}</h3><p class="text-blue-400 font-mono text-[10px]">${v.placa}</p></div>
                            <div class="flex gap-2">
                                <span class="text-[9px] px-2 py-1 rounded-full font-bold uppercase ${isEmCurso ? 'badge-em-viagem' : 'bg-emerald-500/10 text-emerald-500'}">
                                    ${isEmCurso ? 'Em Curso' : 'Finalizada'}
                                </span>
                                <button onclick="excluirViagem('${d.id}')" class="text-slate-700 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div class="bg-slate-950/40 p-3 rounded-xl text-center">
                            <p class="text-[9px] text-slate-500 uppercase">Tempo</p>
                            <span class="font-mono text-xl font-bold ${isEmCurso ? 'text-blue-400 cronometro-admin-real' : 'text-slate-300'}" data-inicio="${inicioMS}">
                                ${isEmCurso ? '00:00:00' : v.duracao}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-xs">
                            <div><p class="text-slate-500 text-[9px]">IN√çCIO</p><p class="font-bold">${v.kmInicio} km</p></div>
                            <div><p class="text-slate-500 text-[9px]">FIM</p><p class="font-bold">${v.kmFim || '--'} km</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="verFoto('${v.fotoInicio}')" class="bg-slate-800 py-2 rounded-lg text-[10px] uppercase font-bold">Foto In√≠cio</button>
                            ${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="bg-slate-800 py-2 rounded-lg text-[10px] uppercase font-bold">Foto Fim</button>` : ''}
                        </div>
                        <div class="flex justify-between text-[10px] pt-3 border-t border-slate-800/50">
                            <div class="flex gap-3">
                                <span onclick="window.open('https://www.google.com/maps?q=${v.locInicio}')" class="cursor-pointer text-blue-400 font-bold">üìç MAPA IN√çCIO</span>
                                ${v.locFim ? `<span onclick="window.open('https://www.google.com/maps?q=${v.locFim}')" class="cursor-pointer text-emerald-400 font-bold">üìç MAPA FIM</span>` : ''}
                            </div>
                            <span>${v.dataInicio.toDate().toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        });

        // RECONECTAR VIAGEM ATIVA
        window.addEventListener('load', async () => {
            if (idAtual) {
                const docSnap = await getDoc(doc(db, "viagens", idAtual));
                if (docSnap.exists() && docSnap.data().status === 'em_curso') {
                    const d = docSnap.data();
                    mudarTela('viagem');
                    document.getElementById('info-viagem-ativa').innerText = `${d.nome} ‚Ä¢ ${d.placa}`;
                    setInterval(() => {
                        const diff = Math.floor((new Date().getTime() - d.dataInicio.toDate().getTime()) / 1000);
                        document.getElementById('cronometro-motorista').innerText = formatarTempo(diff);
                    }, 1000);
                }
            }
            lucide.createIcons();
        });

        window.abrirModalExport = async () => {
            const select = document.getElementById('select-placa-export');
            select.innerHTML = '<option value="TODAS">Todas as Placas</option>';
            const qS = await getDocs(collection(db, "viagens"));
            const placas = new Set();
            qS.forEach(d => placas.add(d.data().placa.toUpperCase()));
            placas.forEach(p => select.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('modal-export').classList.remove('hidden');
        };
        window.fecharModalExport = () => document.getElementById('modal-export').classList.add('hidden');
        window.gerarExcel = async () => {
            toggleLoading(true);
            const dIni = document.getElementById('data-exp-inicio').value;
            const dFim = document.getElementById('data-exp-fim').value;
            const pSel = document.getElementById('select-placa-export').value;
            const qS = await getDocs(query(collection(db, "viagens"), orderBy("dataInicio", "desc")));
            let dados = [];
            qS.forEach(docSnap => {
                const v = docSnap.data();
                const dataV = v.dataInicio?.toDate();
                let match = (pSel === "TODAS" || v.placa.toUpperCase() === pSel);
                if(dIni && dFim) {
                    const s = new Date(dIni + "T00:00:00"), e = new Date(dFim + "T23:59:59");
                    match = match && (dataV >= s && dataV <= e);
                }
                if(match) dados.push({ Motorista: v.nome, Placa: v.placa, Data: dataV?.toLocaleDateString(), Inicio: v.kmInicio, Fim: v.kmFim || "--", Total: v.dispersao?.toFixed(1) || 0, Duracao: v.duracao || "--" });
            });
            const ws = XLSX.utils.json_to_sheet(dados);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Viagens");
            XLSX.writeFile(wb, `Relatorio_IcaphiDrive.xlsx`);
            toggleLoading(false);
            fecharModalExport();
        };
    </script>
</body>
</html>
