<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IcaphiDrive Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .card { background: #0f172a; border: 1px solid #1e293b; border-radius: 1.5rem; }
        .input-style { background: #1e293b !important; border: 1px solid #334155 !important; color: white !important; width: 100%; padding: 0.75rem; border-radius: 0.75rem; outline: none; font-size: 14px; }
        .btn-primary { background: #2563eb; transition: all 0.2s; }
        .glass-modal { background: rgba(2, 6, 23, 0.98); backdrop-filter: blur(12px); z-index: 200; }
        #loading-screen { transition: opacity 0.5s ease-out; }
        .truck-container { animation: truckDrive 2s infinite ease-in-out; }
        @keyframes truckDrive { 0% { transform: translateX(-50px); opacity: 0; } 50% { transform: translateX(0px); opacity: 1; } 100% { transform: translateX(50px); opacity: 0; } }
        .filter-btn.active { background: #2563eb !important; color: white !important; border-color: #2563eb !important; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th, td { padding: 8px; border-bottom: 1px solid #1e293b; text-align: left; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <div id="loading-screen" class="hidden fixed inset-0 z-[300] bg-[#020617] flex flex-col items-center justify-center">
        <div class="truck-container text-blue-500"><i data-lucide="truck" class="w-16 h-16"></i></div>
        <p class="text-blue-500 font-bold tracking-widest text-[10px] uppercase mt-6">Processando...</p>
    </div>

    <header class="flex justify-between items-center py-6">
        <div>
            <h1 class="text-xl font-extrabold tracking-tight text-blue-500 italic">ICAPHI<span class="text-white">DRIVE</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Controle de Frota</p>
        </div>
        <button onclick="acessoAdmin()" class="p-3 card border-slate-700 active:bg-slate-800 transition">
            <i data-lucide="shield-lock" class="text-blue-400 w-5 h-5"></i>
        </button>
    </header>

    <main id="tela-inicio" class="space-y-6">
        <div class="card p-6 border-t-4 border-t-blue-600 shadow-xl">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-lg font-semibold flex items-center gap-2"><i data-lucide="play" class="text-emerald-400 w-4 h-4"></i> Iniciar Viagem</h2>
                <button onclick="abrirModalExtrato()" class="text-[10px] font-bold text-blue-400 border border-blue-400/30 px-3 py-1 rounded-full uppercase">Extrato</button>
            </div>
            <div class="space-y-4">
                <select id="tipo-viagem" class="input-style">
                    <option value="Saida Dia">Saida Dia</option>
                    <option value="Apoio">Apoio</option>
                    <option value="Seg. Viagem">Seg. Viagem</option>
                </select>
                <input type="text" id="motorista" placeholder="Motorista" class="input-style">
                <input type="text" id="placa" placeholder="Placa" class="input-style uppercase">
                <input type="number" id="km-inicio" placeholder="KM Inicial" class="input-style">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                    <span class="text-sm text-slate-400" id="label-foto-inicio">Foto Painel Início</span>
                    <input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-inicio')">
                </label>
                <button onclick="iniciarViagem()" class="w-full btn-primary py-4 rounded-xl font-bold uppercase tracking-wider">Iniciar Agora</button>
            </div>
        </div>
    </main>

    <main id="tela-viagem" class="hidden space-y-6 py-10 text-center">
        <div class="relative flex flex-col items-center justify-center">
            <div class="w-64 h-64 rounded-full border-4 border-blue-600/10 border-t-blue-500 animate-spin absolute"></div>
            <div class="w-56 h-56 rounded-full flex flex-col items-center justify-center bg-slate-900 z-10">
                <h3 id="cronometro-motorista" class="text-5xl font-mono font-bold">00:00:00</h3>
            </div>
        </div>
        <button onclick="abrirModalObs()" class="w-full bg-slate-800 border border-slate-700 py-3 rounded-xl flex items-center justify-center gap-2 font-bold text-blue-400">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> ADICIONAR OBSERVAÇÃO
        </button>
        <div class="card p-6 border-t-4 border-t-red-600 text-left space-y-4">
            <input type="number" id="km-fim" placeholder="KM Final" class="input-style">
            <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-700 rounded-xl bg-slate-800/20 cursor-pointer">
                <span class="text-sm text-slate-400" id="label-foto-fim">Foto Painel Fim</span>
                <input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this, 'label-foto-fim')">
            </label>
            <button onclick="finalizarViagem()" class="w-full bg-red-600 py-4 rounded-xl font-bold uppercase">Encerrar Viagem</button>
        </div>
    </main>

    <main id="tela-admin" class="hidden space-y-4 pb-10">
        <div class="sticky top-0 bg-[#020617] pt-4 pb-2 z-20 space-y-4">
            <div class="flex items-center justify-between">
                <button onclick="mudarTela('inicio')" class="p-2 bg-slate-800 rounded-lg"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-bold text-blue-500">Histórico</h2>
                <div class="flex gap-2">
                    <button onclick="abrirModalGerarSenha()" class="p-3 bg-blue-600 rounded-xl"><i data-lucide="key" class="w-5 h-5"></i></button>
                    <button onclick="abrirModalExport()" class="p-3 bg-emerald-600 rounded-xl"><i data-lucide="settings-2" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="setFiltroStatus('TUDO')" id="btn-filtro-tudo" class="filter-btn active px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">TUDO</button>
                <button onclick="setFiltroStatus('em_curso')" id="btn-filtro-em_curso" class="filter-btn px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">EM CURSO</button>
                <button onclick="setFiltroStatus('finalizada')" id="btn-filtro-finalizada" class="filter-btn px-4 py-2 rounded-full border border-slate-700 text-[10px] font-bold">FINALIZADAS</button>
            </div>
            <input type="text" id="busca-admin" oninput="renderizarAdmin()" placeholder="Buscar motorista ou placa..." class="input-style text-xs">
        </div>
        <div id="lista-viagens" class="space-y-4"></div>
    </main>

    <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4 overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold text-center text-emerald-500 uppercase tracking-widest">Configurações Admin</h3>
            <div class="space-y-2 border-b border-slate-800 pb-4">
                <p class="text-[10px] text-slate-500 font-bold uppercase">1. Exportar Excel</p>
                <select id="select-placa-export" class="input-style"></select>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="data-exp-inicio" class="input-style text-xs">
                    <input type="date" id="data-exp-fim" class="input-style text-xs">
                </div>
                <button onclick="gerarExcel()" class="w-full bg-emerald-600 py-3 rounded-xl font-bold text-xs">BAIXAR PLANILHA</button>
            </div>
            <div class="space-y-2 pt-2">
                <p class="text-[10px] text-red-500 font-bold uppercase">2. Excluir Período</p>
                <div class="grid grid-cols-2 gap-2">
                    <input type="date" id="excluir-data-inicio" class="input-style text-xs">
                    <input type="date" id="excluir-data-fim" class="input-style text-xs">
                </div>
                <button onclick="excluirPorPeriodo()" class="w-full bg-red-900/50 border border-red-600 text-red-500 py-3 rounded-xl font-bold text-xs uppercase">APAGAR REGISTROS</button>
            </div>
            <button onclick="document.getElementById('modal-export').classList.add('hidden')" class="w-full text-slate-500 text-sm mt-4">FECHAR</button>
        </div>
    </div>

    <div id="modal-gerar-senha" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4">
            <h3 class="font-bold text-center text-blue-400 uppercase">Código de Acesso</h3>
            <select id="senha-placa-select" class="input-style"></select>
            <button onclick="gerarSenhaAcesso()" class="w-full bg-blue-600 py-4 rounded-xl font-bold">GERAR CÓDIGO</button>
            <div id="resultado-senha" class="hidden p-4 bg-slate-900 rounded-xl text-center border border-blue-500/30">
                <p id="codigo-gerado" class="text-3xl font-black text-blue-400 tracking-widest"></p>
            </div>
            <button onclick="document.getElementById('modal-gerar-senha').classList.add('hidden')" class="w-full text-slate-500 text-sm">VOLTAR</button>
        </div>
    </div>

    <div id="modal-obs" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6">
        <div class="card p-6 w-full max-w-sm space-y-4">
            <h3 class="font-bold text-center text-blue-400">Adicionar Nota</h3>
            <select id="obs-assunto" class="input-style">
                <option value="Descarga">Descarga</option>
                <option value="Ajudante">Ajudante</option>
                <option value="Pedágio">Pedágio</option>
                <option value="Combustível">Combustível</option>
                <option value="Outros">Outros</option>
            </select>
            <textarea id="obs-texto" placeholder="Descrição..." class="input-style h-24"></textarea>
            <input type="number" id="obs-valor" placeholder="Valor R$ (opcional)" class="input-style">
            <div class="flex gap-2">
                <button onclick="document.getElementById('modal-obs').classList.add('hidden')" class="flex-1 text-slate-500 font-bold">CANCELAR</button>
                <button onclick="salvarObservacao()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="modal-ver-obs" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6"><div class="card p-6 w-full max-w-sm max-h-[80vh] flex flex-col"><h3 class="font-bold text-center text-blue-400 mb-4">Notas e Valores</h3><div id="lista-obs-render" class="flex-1 overflow-y-auto space-y-3"></div><button onclick="document.getElementById('modal-ver-obs').classList.add('hidden')" class="w-full bg-slate-800 py-3 rounded-xl mt-4 font-bold">VOLTAR</button></div></div>
    <div id="modal-extrato-login" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-6"><div class="card p-6 w-full max-w-sm space-y-4"><h3 class="font-bold text-center">Extrato Motorista</h3><input type="text" id="extrato-placa" placeholder="Sua Placa" class="input-style uppercase"><div class="grid grid-cols-2 gap-2"><input type="date" id="extrato-inicio" class="input-style text-xs"><input type="date" id="extrato-fim" class="input-style text-xs"></div><input type="number" id="extrato-codigo" placeholder="Código de Acesso" class="input-style text-center"><button onclick="validarAcessoExtrato()" class="w-full bg-blue-600 py-4 rounded-xl font-bold">VER EXTRATO</button><button onclick="document.getElementById('modal-extrato-login').classList.add('hidden')" class="w-full text-slate-500 text-sm">FECHAR</button></div></div>
    <div id="modal-tabela-extrato" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-2"><div class="card p-4 w-full max-w-sm h-[80vh] flex flex-col"><h3 class="font-bold text-center mb-4 text-blue-500">SEU HISTÓRICO</h3><div class="flex-1 overflow-auto bg-slate-950/50 rounded-xl"><table><thead class="bg-slate-900"><tr><th>Data</th><th>KM Total</th><th>Notas</th></tr></thead><tbody id="corpo-tabela-extrato"></tbody></table></div><button onclick="document.getElementById('modal-tabela-extrato').classList.add('hidden')" class="w-full bg-slate-800 py-4 rounded-xl mt-4 font-bold">FECHAR</button></div></div>
    <div id="modal-img" class="hidden fixed inset-0 flex items-center justify-center glass-modal p-4" onclick="this.classList.add('hidden')"><img id="img-full" class="rounded-2xl max-h-[80vh] border-2 border-slate-700"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy, deleteDoc, getDoc, arrayUnion, where, getDocs, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U", authDomain: "marcador-ponto-digital.firebaseapp.com", projectId: "marcador-ponto-digital", storageBucket: "marcador-ponto-digital.firebasestorage.app", messagingSenderId: "774324665760", appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        let idAtual = localStorage.getItem('icaphidrive_viagem_id');
        let listaGlobalViagens = [];
        let statusSelecionado = 'TUDO';

        const toggleLoading = (s) => document.getElementById('loading-screen').classList.toggle('hidden', !s);
        const formatarTempo = (s) => { const h=Math.floor(s/3600).toString().padStart(2,'0'), m=Math.floor((s%3600)/60).toString().padStart(2,'0'), sec=(s%60).toString().padStart(2,'0'); return `${h}:${m}:${sec}`; };
        
        window.mudarTela = (t) => { ['tela-inicio', 'tela-viagem', 'tela-admin'].forEach(x => document.getElementById(x).classList.add('hidden')); document.getElementById('tela-' + t).classList.remove('hidden'); lucide.createIcons(); };
        window.acessoAdmin = () => { if(prompt("Senha:") === "60010774") mudarTela('admin'); };
        window.verFoto = (s) => { document.getElementById('img-full').src = s; document.getElementById('modal-img').classList.remove('hidden'); };
        window.previewFoto = (i, l) => { if(i.files[0]) document.getElementById(l).innerText = "Foto ✅"; };
        window.setFiltroStatus = (s) => { statusSelecionado = s; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); document.getElementById(`btn-filtro-${s.toLowerCase()}`).classList.add('active'); renderizarAdmin(); };

        // ADMIN RENDER - MAPAS E KM PERCORRIDO RESTAURADOS
        window.renderizarAdmin = () => {
            const container = document.getElementById('lista-viagens');
            const busca = document.getElementById('busca-admin').value.toLowerCase();
            container.innerHTML = "";
            listaGlobalViagens.filter(v => (statusSelecionado === 'TUDO' || v.status === statusSelecionado) && (v.nome.toLowerCase().includes(busca) || v.placa.toLowerCase().includes(busca))).forEach(v => {
                const isEmCurso = v.status === 'em_curso';
                const kmPercorrido = v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : "0.0";
                
                container.innerHTML += `
                <div class="card p-5 space-y-4">
                    <div class="flex justify-between">
                        <span class="text-[9px] bg-blue-500/20 text-blue-400 px-2 py-1 rounded font-extrabold uppercase">${v.tipoViagem}</span>
                        <div class="flex gap-2">
                            <span class="text-[9px] px-2 py-1 rounded font-bold uppercase ${isEmCurso ? 'text-orange-500' : 'text-emerald-500'}">${v.status}</span>
                            <button onclick="excluirViagem('${v.id}')"><i data-lucide="trash-2" class="w-4 h-4 text-slate-700"></i></button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl uppercase">${v.nome}</h3>
                        <p class="text-blue-400 font-mono text-[10px] uppercase">${v.placa}</p>
                    </div>
                    <div class="bg-slate-950/40 p-4 rounded-xl text-center border border-slate-800">
                        <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Duração Total</p>
                        <span class="font-mono text-2xl font-bold ${isEmCurso ? 'text-blue-400 cronometro-admin-live' : 'text-slate-200'}" data-inicio="${v.dataInicio.toDate().getTime()}">${isEmCurso ? '...' : v.duracao}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center bg-slate-800/30 p-3 rounded-xl">
                        <div><p class="text-slate-500 text-[8px] uppercase font-bold">Início</p><p class="font-bold text-xs">${v.kmInicio}k</p></div>
                        <div><p class="text-slate-500 text-[8px] uppercase font-bold">Fim</p><p class="font-bold text-xs">${v.kmFim || '--'}</p></div>
                        <div class="border-l border-slate-700"><p class="text-emerald-500 text-[8px] uppercase font-bold">Percorrido</p><p class="font-bold text-xs text-emerald-400">${kmPercorrido}k</p></div>
                    </div>
                    <button onclick="verObservacoesAdmin('${v.id}')" class="w-full bg-slate-800 py-3 rounded-xl text-xs font-bold uppercase">Ver Notas (${v.observacoes?.length || 0})</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="verFoto('${v.fotoInicio}')" class="bg-slate-800 py-3 rounded-xl text-[10px] font-bold">FOTO INÍCIO</button>
                        ${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="bg-slate-800 py-3 rounded-xl text-[10px] font-bold">FOTO FIM</button>` : ''}
                    </div>
                    <div class="flex justify-between pt-2 border-t border-slate-800/50">
                        <span onclick="window.open('https://www.google.com/maps?q=${v.locInicio}')" class="text-blue-400 font-bold text-[10px] cursor-pointer flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> MAPA INÍCIO</span>
                        ${v.locFim ? `<span onclick="window.open('https://www.google.com/maps?q=${v.locFim}')" class="text-emerald-400 font-bold text-[10px] cursor-pointer flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> MAPA FIM</span>` : ''}
                    </div>
                </div>`;
            });
            lucide.createIcons();
        };

        // CORE - INICIAR E FINALIZAR (COM GPS)
        const getLoc = () => new Promise(r => navigator.geolocation.getCurrentPosition(p => r(`${p.coords.latitude},${p.coords.longitude}`), () => r("0,0")));

        window.iniciarViagem = async () => {
            const t=document.getElementById('tipo-viagem').value, n=document.getElementById('motorista').value, p=document.getElementById('placa').value.toUpperCase(), k=document.getElementById('km-inicio').value, f=document.getElementById('foto-inicio').files[0];
            if(!t || !n || !p || !k || !f) return alert("Preencha todos os campos!");
            toggleLoading(true);
            const loc = await getLoc();
            const docRef = await addDoc(collection(db, "viagens"), { tipoViagem: t, nome: n, placa: p, kmInicio: parseFloat(k), fotoInicio: await compressImage(f), locInicio: loc, status: 'em_curso', dataInicio: new Date(), observacoes: [] });
            localStorage.setItem('icaphidrive_viagem_id', docRef.id); location.reload();
        };

        window.finalizarViagem = async () => {
            const kF=document.getElementById('km-fim').value, f=document.getElementById('foto-fim').files[0];
            if(!kF || !f) return alert("Faltam KM ou Foto!");
            toggleLoading(true);
            const loc = await getLoc();
            await updateDoc(doc(db, "viagens", idAtual), { kmFim: parseFloat(kF), fotoFim: await compressImage(f), locFim: loc, status: 'finalizada', dataFim: new Date(), duracao: document.getElementById('cronometro-motorista').innerText });
            localStorage.removeItem('icaphidrive_viagem_id'); location.reload();
        };

        // EXCEL E CONFIG
        window.abrirModalExport = () => {
            const sel = document.getElementById('select-placa-export');
            sel.innerHTML = '<option value="TODAS">Todas as Placas</option>';
            [...new Set(listaGlobalViagens.map(v => v.placa))].forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('modal-export').classList.remove('hidden');
        };

        window.gerarExcel = async () => {
            const p=document.getElementById('select-placa-export').value, dI=document.getElementById('data-exp-inicio').value, dF=document.getElementById('data-exp-fim').value;
            let dados = listaGlobalViagens.filter(v => (p==='TODAS' || v.placa===p));
            if(dI && dF) { const s=new Date(dI+"T00:00:00"), e=new Date(dF+"T23:59:59"); dados = dados.filter(v => v.dataInicio.toDate() >= s && v.dataInicio.toDate() <= e); }
            const ws_data = [["Motorista", "Placa", "Tipo", "Data", "Duração", "KM Início", "KM Fim", "Percorrido", "Notas"]];
            dados.forEach(v => {
                ws_data.push([v.nome, v.placa, v.tipoViagem, v.dataInicio.toDate().toLocaleString(), v.duracao || "--", v.kmInicio, v.kmFim || "--", (v.kmFim ? v.kmFim - v.kmInicio : 0).toFixed(1), v.observacoes?.map(o => `${o.assunto}: ${o.texto}`).join(" | ") || ""]);
            });
            XLSX.writeFile(XLSX.utils.book_new(), `IcaphiDrive_Relatorio.xlsx`);
        };

        window.excluirPorPeriodo = async () => {
            const dI = document.getElementById('excluir-data-inicio').value, dF = document.getElementById('excluir-data-fim').value;
            if(!dI || !dF) return alert("Datas!");
            if(!confirm("Apagar tudo neste período?")) return;
            toggleLoading(true);
            const s=new Date(dI+"T00:00:00"), e=new Date(dF+"T23:59:59");
            const q=query(collection(db, "viagens"), where("dataInicio", ">=", s), where("dataInicio", "<=", e));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            toggleLoading(false); alert("Limpo!");
        };

        // SENHAS E EXTRATO
        window.abrirModalGerarSenha = () => {
            const sel = document.getElementById('senha-placa-select');
            sel.innerHTML = '<option value="" disabled selected>Placa</option>';
            [...new Set(listaGlobalViagens.map(v => v.placa))].forEach(p => sel.innerHTML += `<option value="${p}">${p}</option>`);
            document.getElementById('modal-gerar-senha').classList.remove('hidden');
        };

        window.gerarSenhaAcesso = async () => {
            const p = document.getElementById('senha-placa-select').value;
            if(!p) return alert("Placa!");
            const cod = Math.floor(100000 + Math.random() * 900000).toString();
            await setDoc(doc(db, "codigos_acesso", p), { codigo: cod, data: new Date() });
            document.getElementById('codigo-gerado').innerText = cod;
            document.getElementById('resultado-senha').classList.remove('hidden');
        };

        window.abrirModalExtrato = () => document.getElementById('modal-extrato-login').classList.remove('hidden');

        window.validarAcessoExtrato = async () => {
            const p=document.getElementById('extrato-placa').value.toUpperCase(), cod=document.getElementById('extrato-codigo').value, dI=document.getElementById('extrato-inicio').value, dF=document.getElementById('extrato-fim').value;
            if(!p || !cod || !dI || !dF) return alert("Faltam dados!");
            toggleLoading(true);
            const dS = await getDoc(doc(db, "codigos_acesso", p));
            if(dS.exists() && dS.data().codigo === cod) {
                const s=new Date(dI+"T00:00:00"), e=new Date(dF+"T23:59:59");
                // NOTA: Esta consulta exige o índice composto que você já criou no Firebase
                const q=query(collection(db, "viagens"), where("placa", "==", p), where("dataInicio", ">=", s), where("dataInicio", "<=", e));
                const snapV = await getDocs(q);
                const corpo = document.getElementById('corpo-tabela-extrato');
                corpo.innerHTML = snapV.empty ? "<tr><td colspan='3' class='p-4 text-center'>Nenhuma viagem.</td></tr>" : "";
                snapV.forEach(d => {
                    const v = d.data();
                    corpo.innerHTML += `<tr><td>${v.dataInicio.toDate().toLocaleDateString()}</td><td>${v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : "---"}</td><td>${v.observacoes?.length || 0}</td></tr>`;
                });
                document.getElementById('modal-extrato-login').classList.add('hidden');
                document.getElementById('modal-tabela-extrato').classList.remove('hidden');
            } else { alert("Acesso Negado!"); }
            toggleLoading(false);
        };

        // AUXILIARES
        window.abrirModalObs = () => document.getElementById('modal-obs').classList.remove('hidden');
        window.salvarObservacao = async () => {
            const ass=document.getElementById('obs-assunto').value, txt=document.getElementById('obs-texto').value, val=document.getElementById('obs-valor').value;
            if(!txt) return alert("Texto!");
            toggleLoading(true);
            await updateDoc(doc(db, "viagens", idAtual), { observacoes: arrayUnion({ assunto: ass, texto: txt, valor: val || "0.00", data: new Date().toLocaleString() }) });
            document.getElementById('modal-obs').classList.add('hidden');
            toggleLoading(false);
        };

        window.verObservacoesAdmin = (id) => {
            const v = listaGlobalViagens.find(x => x.id === id);
            const container = document.getElementById('lista-obs-render');
            container.innerHTML = "";
            v.observacoes?.forEach(o => { container.innerHTML += `<div class="bg-slate-800 p-3 rounded-xl border-l-4 border-blue-500"><b>${o.assunto}</b>: ${o.texto} <br><span class="text-emerald-400 font-bold">R$ ${o.valor}</span></div>`; });
            document.getElementById('modal-ver-obs').classList.remove('hidden');
        };

        window.excluirViagem = async (id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "viagens", id)); };
        const compressImage = (f) => new Promise(r => { const fr=new FileReader(); fr.readAsDataURL(f); fr.onload=(e)=>{ const img=new Image(); img.src=e.target.result; img.onload=()=>{ const c=document.createElement('canvas'); const w=800; c.width=w; c.height=img.height*(w/img.width); c.getContext('2d').drawImage(img,0,0,c.width,c.height); r(c.toDataURL('image/jpeg',0.6)); }; }; });

        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => { listaGlobalViagens = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderizarAdmin(); });
        setInterval(() => { document.querySelectorAll('.cronometro-admin-live').forEach(el => { el.innerText = formatarTempo(Math.floor((new Date().getTime() - parseInt(el.dataset.inicio)) / 1000)); }); }, 1000);
        window.addEventListener('load', async () => { if (idAtual) { const snap = await getDoc(doc(db, "viagens", idAtual)); if (snap.exists() && snap.data().status === 'em_curso') { mudarTela('viagem'); setInterval(() => { document.getElementById('cronometro-motorista').innerText = formatarTempo(Math.floor((new Date().getTime() - snap.data().dataInicio.toDate().getTime()) / 1000)); }, 1000); } } lucide.createIcons(); });
    </script>
</body>
</html>
