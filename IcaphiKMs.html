<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IcaphiDrive</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* ESTILOS GERAIS */
        :root { 
            --primary: #3b82f6; --accent: #06b6d4; 
            --glass-bg: rgba(15, 23, 42, 0.95); 
            --glass-border: rgba(255, 255, 255, 0.08); 
            --pc-cols: 4;
        }
        body { 
            background-color: #020617;
            background-image: radial-gradient(circle at top right, rgba(6, 182, 212, 0.15), transparent 40%), radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.15), transparent 40%);
            background-attachment: fixed; margin: 0; color: #f8fafc; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden;
        }
        
        /* UI Components */
        .glass { background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--glass-border); box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3); }
        .modal-container { position: relative; width: 95%; max-width: 420px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 24px; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6); margin: auto; overflow: hidden; animation: scaleIn 0.2s ease-out forwards; }
        @keyframes scaleIn { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .input-style { background: rgba(30, 41, 59, 0.6) !important; border: 1px solid rgba(255, 255, 255, 0.05) !important; color: #fff !important; width: 100%; padding: 16px; border-radius: 16px; outline: none; font-size: 15px; transition: 0.2s; }
        .input-style:focus { border-color: var(--primary) !important; background: rgba(30, 41, 59, 0.9) !important; }
        .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%); border-radius: 16px; font-weight: 800; color: white; padding: 18px; text-transform: uppercase; width: 100%; border: none; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3); transition: transform 0.1s; cursor: pointer; }
        
        /* CARDS */
        .admin-card { 
            background: rgba(30, 41, 59, 0.7); 
            border-radius: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 20px 20px 20px 26px; 
            margin-bottom: 0; 
            position: relative; 
            overflow: hidden; /* Mantém a barrinha dentro do card */
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
            height: 100%; 
            transition: all 0.3s ease;
        }
        
        .admin-card::before { 
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background: #10b981; z-index: 10; border-radius: 20px 0 0 20px;
        } 
        .admin-card.em-curso::before { background: #f59e0b; } 
        .admin-card.cancelada::before { background: #ef4444; }
        .admin-card.cancelada { opacity: 0.75; filter: grayscale(0.2); }

        /* Loader & Utils */
        #main-loader { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; pointer-events: all; backdrop-filter: blur(10px); }
        .loader-ring { width: 45px; height: 45px; border: 4px solid rgba(59, 130, 246, 0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s infinite linear; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        /* Desktop Grid */
        .w-full-pc { max-width: 100% !important; padding: 30px; }
        .grid-pc { display: grid; grid-template-columns: repeat(var(--pc-cols), 1fr); gap: 15px; align-items: stretch; }

        /* Viewers */
        .viewer-overlay { position: fixed; inset: 0; z-index: 5000; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .viewer-overlay.active { opacity: 1; pointer-events: all; }
        .viewer-content { width: 95%; max-width: 800px; max-height: 85vh; background: #0f172a; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
        .file-box { border: 2px dashed rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); transition: all 0.2s; }
        .file-box.attached { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }

        /* HEADER ADMIN FIXED */
        .admin-header-glass {
            position: sticky; top: 0; z-index: 500; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1); border-radius: 0 0 24px 24px; margin: -12px -12px 0 -12px; padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 12px;
        }
        #lista-viagens { padding-top: 24px; min-height: 200px; }

        /* Botões */
        .filter-btn { padding: 10px 20px; border-radius: 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; background: rgba(15, 23, 42, 0.6); cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        .filter-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .filter-btn.active { background: #2563eb; color: white; border-color: #60a5fa; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .action-btn { width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.2s; position: relative; }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* TOOLTIPS */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip); position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background: #0f172a; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 8px 12px; 
            border-radius: 8px; font-size: 11px; white-space: nowrap; z-index: 9999; margin-top: 8px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.8); pointer-events: none;
        }
        .tooltip-block { position: relative; }
        .tooltip-block:hover::after {
            content: attr(data-info); position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background: #0f172a; border: 1px solid rgba(255,255,255,0.2); color: #cbd5e1; padding: 12px; 
            border-radius: 12px; font-size: 11px; width: 220px; z-index: 9999; margin-top: 8px; 
            white-space: pre-wrap; box-shadow: 0 10px 30px rgba(0,0,0,0.9); pointer-events: none;
        }
    </style>
</head>
<body class="p-3 selection:bg-blue-500 selection:text-white">
    
    <div id="main-loader"><div class="loader-ring"></div><p id="loader-msg" class="mt-4 text-[11px] font-black text-blue-500 uppercase tracking-[2px] animate-pulse">Carregando Sistema...</p></div>

    <div id="popup-foto" class="viewer-overlay" onclick="fecharPopup('popup-foto')">
        <div class="viewer-content" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-white/10 flex justify-between bg-slate-900"><span class="text-xs font-bold text-white uppercase">Foto</span><button onclick="fecharPopup('popup-foto')"><i data-lucide="x" class="text-white w-4 h-4"></i></button></div>
            <div class="bg-black flex-1 flex items-center justify-center p-2"><img id="img-viewer" class="max-w-full max-h-[70vh] rounded-lg object-contain"></div>
        </div>
    </div>
    <div id="popup-gps" class="viewer-overlay" onclick="fecharPopup('popup-gps')">
        <div class="viewer-content !h-[80vh]" onclick="event.stopPropagation()">
            <div class="p-3 border-b border-white/10 flex justify-between bg-slate-900"><span class="text-xs font-bold text-white uppercase">Mapa</span><button onclick="fecharPopup('popup-gps')"><i data-lucide="x" class="text-white w-4 h-4"></i></button></div>
            <iframe id="iframe-gps" class="w-full h-full border-none bg-slate-800"></iframe>
        </div>
    </div>

    <div id="app-wrap" class="max-w-[420px] mx-auto relative z-10 transition-all duration-300 ease-out">
        <header class="flex justify-between items-center py-4 mb-2">
            <div><h1 class="text-2xl font-black italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400 uppercase tracking-tighter">ICAPHIDRIVE</h1><p class="text-[9px] text-slate-400 font-bold uppercase tracking-[0.3em] ml-1">By: Matheus Julio</p></div>
            <div class="flex gap-2">
                <button onclick="alternarModoPC()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors relative" data-tooltip="Modo Computador"><i data-lucide="monitor" class="w-4 h-4"></i></button>
                <button id="btn-sino" onclick="abrirModalMuralMotorista()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors relative" data-tooltip="Notificações"><i data-lucide="bell" class="w-4 h-4"></i><span id="notif-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-amber-500 rounded-full animate-ping"></span></button>
                <button onclick="acessoAdmin()" class="w-9 h-9 rounded-xl glass flex items-center justify-center text-slate-400 hover:text-white transition-colors relative" data-tooltip="Acesso Admin"><i data-lucide="shield-check" class="w-4 h-4"></i></button>
            </div>
        </header>

        <main id="tela-inicio" class="space-y-5">
            <div class="modal-container">
                <div class="flex justify-between items-center mb-6"><h2 class="text-lg font-black uppercase text-white flex gap-2 items-center"><i data-lucide="zap" class="text-cyan-400 fill-cyan-400/20"></i> Nova Rota</h2><button onclick="document.getElementById('modal-extrato-login').classList.remove('hidden')" class="px-3 py-1.5 bg-slate-800/50 hover:bg-slate-700 rounded-full text-[9px] font-bold uppercase text-cyan-400 border border-cyan-500/30 transition-all">Histórico</button></div>
                <div class="space-y-3">
                    <div class="relative"><select id="tipo-servico" class="input-style appearance-none font-bold text-slate-300 cursor-pointer"><option>Saida Dia</option><option>Apoio</option><option>Segunda Viagem</option></select><i data-lucide="chevron-down" class="absolute right-4 top-5 text-slate-500 pointer-events-none w-5 h-5"></i></div>
                    <input type="text" id="motorista" placeholder="Nome do Condutor" class="input-style placeholder-slate-500">
                    <input type="text" id="placa" placeholder="PLACA DO VEÍCULO" class="input-style uppercase tracking-widest font-bold placeholder-slate-500">
                    <input type="number" id="km-inicio" placeholder="KM Painel" class="input-style placeholder-slate-500 font-mono">
                    <label id="lbl-foto-inicio" class="file-box flex flex-col items-center justify-center w-full h-24 rounded-2xl cursor-pointer hover:border-cyan-500/50 transition-colors"><i data-lucide="camera" class="w-6 h-6 text-slate-400 mb-2"></i><span id="txt-foto" class="text-[9px] font-bold text-slate-400 uppercase">Foto Painel</span><input type="file" id="foto-inicio" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto', 'lbl-foto-inicio')"></label>
                    <button onclick="iniciarViagem()" class="btn-primary mt-1 flex items-center justify-center gap-2">Iniciar Rota <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                </div>
            </div>
            <button onclick="abrirTutorial()" class="w-full text-center text-[10px] font-bold text-slate-600 uppercase tracking-[2px] hover:text-slate-400 pb-4 flex justify-center gap-2 items-center"><i data-lucide="help-circle" class="w-3 h-3"></i> Como Usar</button>
        </main>

        <main id="tela-em-curso" class="hidden space-y-5">
            <div class="modal-container text-center border-amber-500/20 shadow-none">
                <div class="inline-flex items-center gap-2 mb-6 bg-amber-500/10 py-1.5 px-4 rounded-full border border-amber-500/20"><div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div><p id="info-viagem-ativa" class="text-amber-500 font-black text-[10px] uppercase tracking-widest"></p></div>
                <div class="py-8 bg-black/30 rounded-[24px] mb-6 border border-white/5"><div id="cronometro-motorista" class="text-5xl font-black text-white font-mono tracking-tighter">00:00:00</div><p class="text-[9px] text-slate-500 font-bold uppercase mt-2 tracking-widest">Tempo Decorrido</p></div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button onclick="abrirModalOcorrenciasMotorista()" class="p-3 bg-slate-800/40 hover:bg-slate-700/60 rounded-xl font-bold text-[9px] uppercase border border-white/10 text-slate-300 flex flex-col items-center gap-2 transition-all"><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-400"></i> Ocorrências</button>
                    <button onclick="location.reload()" class="p-3 bg-slate-800/40 hover:bg-slate-700/60 rounded-xl font-bold text-[9px] uppercase border border-white/10 text-slate-300 flex flex-col items-center gap-2 transition-all"><i data-lucide="refresh-cw" class="w-5 h-5 text-emerald-400"></i> Atualizar</button>
                </div>
                <div class="bg-slate-900/30 p-4 rounded-[20px] border border-white/5">
                    <input type="number" id="km-fim" placeholder="KM Final" class="input-style text-center mb-4 text-xl font-bold font-mono border-slate-700">
                    <label id="lbl-foto-fim" class="file-box flex flex-col items-center justify-center w-full h-20 rounded-xl mb-4 cursor-pointer hover:border-emerald-500/50 transition-colors"><div class="flex items-center gap-2 text-slate-400"><i data-lucide="camera" class="w-4 h-4"></i><span id="txt-foto-fim" class="text-[9px] font-bold uppercase">Foto Chegada</span></div><input type="file" id="foto-fim" accept="image/*" capture="environment" class="hidden" onchange="fotoTirada('txt-foto-fim', 'lbl-foto-fim')"></label>
                    <button onclick="encerrarViagem()" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-500 hover:to-red-700 p-4 rounded-xl font-black uppercase text-white flex items-center justify-center gap-2 shadow-lg transition-all"><i data-lucide="stop-circle" class="w-5 h-5"></i> Finalizar</button>
                    <button onclick="cancelarViagemManual()" class="w-full mt-3 text-red-500 hover:bg-red-500/10 p-3 rounded-xl font-bold uppercase text-[10px] border border-red-500/30 transition-all">Cancelar</button>
                </div>
            </div>
        </main>

        <main id="tela-admin" class="hidden pb-32">
            <div class="admin-header-glass">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <button onclick="mudarTela('inicio')" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl text-[10px] font-bold uppercase flex items-center gap-2 border border-white/10 shadow-lg relative" data-tooltip="Voltar ao Início"><i data-lucide="arrow-left" class="w-3 h-3"></i> Sair</button>
                    <div class="flex items-center gap-2 flex-wrap justify-end flex-1">
                        <div id="grid-controls" class="hidden bg-slate-800 rounded-lg p-1 border border-white/10"><select onchange="mudarGrade(this.value)" class="bg-transparent text-xs text-white font-bold outline-none cursor-pointer p-1"><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option></select></div>
                        <div class="flex gap-1 bg-slate-800/60 p-1 rounded-xl border border-white/10">
                            <button onclick="abrirModalConfigValores()" class="action-btn text-emerald-400 bg-emerald-500/10 hover:bg-emerald-500/20" data-tooltip="Preços"><i data-lucide="dollar-sign" class="w-4 h-4"></i></button>
                            <button onclick="abrirMonitoramento()" class="action-btn text-blue-400 bg-blue-500/10 hover:bg-blue-500/20" data-tooltip="Dashboard"><i data-lucide="activity" class="w-4 h-4"></i></button>
                            <button onclick="abrirModalGerarCodigo()" class="action-btn text-cyan-400 bg-cyan-500/10 hover:bg-cyan-500/20" data-tooltip="Senhas"><i data-lucide="key" class="w-4 h-4"></i></button>
                            <button onclick="abrirModalNotifAdmin()" class="action-btn text-amber-500 bg-amber-500/10 hover:bg-amber-500/20" data-tooltip="Avisos"><i data-lucide="megaphone" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex gap-1 bg-slate-800/60 p-1 rounded-xl border border-white/10">
                            <button onclick="document.getElementById('modal-export').classList.remove('hidden')" class="action-btn text-emerald-500 bg-emerald-500/10 hover:bg-emerald-500/20" data-tooltip="Exportar"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i></button>
                            <button onclick="document.getElementById('modal-importar-previsao').classList.remove('hidden')" class="action-btn text-purple-400 bg-purple-500/10 hover:bg-purple-500/20" data-tooltip="Importar"><i data-lucide="upload-cloud" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="w-full md:w-auto overflow-x-auto scrollbar-hide pb-1">
                        <div class="flex gap-2 min-w-max">
                            <button onclick="filtrarStatus('todos')" id="filt-todos" class="filter-btn active">Todos</button>
                            <button onclick="filtrarStatus('em_curso')" id="filt-em_curso" class="filter-btn">Em Rota</button>
                            <button onclick="filtrarStatus('finalizada')" id="filt-finalizada" class="filter-btn">Finalizados</button>
                            <button onclick="filtrarStatus('cancelada')" id="filt-cancelada" class="filter-btn !border-red-500/30 !text-red-400">Canceladas</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 md:flex md:w-auto">
                        <input type="date" id="admin-dt-ini" onchange="renderizarAdmin()" class="bg-slate-900/60 border border-white/10 rounded-xl p-2.5 text-white text-[10px] font-bold text-center uppercase outline-none w-full md:w-32">
                        <input type="date" id="admin-dt-fim" onchange="renderizarAdmin()" class="bg-slate-900/60 border border-white/10 rounded-xl p-2.5 text-white text-[10px] font-bold text-center uppercase outline-none w-full md:w-32">
                    </div>
                    <div class="relative w-full md:flex-1">
                        <i data-lucide="search" class="absolute left-3 top-3.5 text-slate-500 w-4 h-4"></i>
                        <input type="text" id="busca-admin" oninput="renderizarAdmin()" placeholder="Buscar..." class="w-full bg-slate-900/60 border border-white/10 rounded-xl py-2.5 pl-10 pr-3 text-xs text-white placeholder-slate-500 focus:border-blue-500 outline-none">
                    </div>
                </div>
            </div>
            <div id="lista-viagens" class="space-y-4 px-1 pt-2"></div>
        </main>

        <div id="modal-monitoramento" class="hidden fixed inset-0 bg-[#020617] z-[5000] flex flex-col overflow-hidden">
            <div class="relative z-10 flex flex-col md:flex-row justify-between items-center px-6 py-4 border-b border-white/5 bg-slate-900 shadow-xl gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center"><i data-lucide="activity" class="w-5 h-5 text-white"></i></div>
                    <div><h2 class="text-xl font-black text-white uppercase tracking-tighter">Command Center</h2><div class="flex items-center gap-2"><div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Tempo Real</p></div></div>
                </div>
                <div class="flex flex-col md:flex-row gap-2 items-center w-full md:w-auto">
                    <select id="mon-perfil" onchange="atualizarMonitoramento()" class="w-full md:w-auto bg-slate-800 text-white text-[10px] font-bold p-2 rounded-lg outline-none border border-white/10 uppercase cursor-pointer hover:bg-slate-700"><option value="TODOS">Todos os Veículos</option></select>
                    <div class="flex items-center gap-2 bg-slate-800/50 p-1.5 rounded-xl border border-white/10 w-full md:w-auto justify-center"><input type="date" id="mon-ini" class="bg-transparent text-white text-xs font-bold text-center outline-none cursor-pointer" onchange="atualizarMonitoramento()"><span class="text-slate-600 font-bold text-[10px]">ATÉ</span><input type="date" id="mon-fim" class="bg-transparent text-white text-xs font-bold text-center outline-none cursor-pointer" onchange="atualizarMonitoramento()"></div>
                    <button onclick="fecharModal('modal-monitoramento')" class="w-9 h-9 rounded-full bg-slate-800 flex items-center justify-center hover:bg-red-500/20 transition-all shrink-0"><i data-lucide="x" class="w-4 h-4 text-slate-400"></i></button>
                </div>
            </div>
            <div class="relative z-10 flex-1 grid grid-cols-12 grid-rows-12 gap-4 p-4 min-h-0 overflow-y-auto">
                <div class="col-span-6 md:col-span-3 row-span-2 bg-slate-900/60 rounded-2xl border border-white/5 p-4 flex items-center justify-between tooltip-block" data-info="TOTAL DE VIAGENS
Soma de todos os veículos que estão na rua agora + os que já finalizaram."><div><p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Total</p><h3 id="kpi-total" class="text-3xl font-black text-white">0</h3></div><i data-lucide="truck" class="w-5 h-5 text-blue-500"></i></div>
                <div class="col-span-6 md:col-span-3 row-span-2 bg-slate-900/60 rounded-2xl border border-white/5 p-4 flex items-center justify-between tooltip-block" data-info="VEÍCULOS ATIVOS
Quantidade de motoristas que iniciaram a viagem e ainda não finalizaram."><div><p class="text-[10px] text-amber-500/80 font-bold uppercase mb-1">Em Rota</p><h3 id="kpi-ativos" class="text-3xl font-black text-amber-500">0</h3></div><i data-lucide="map" class="w-5 h-5 text-amber-500 animate-pulse"></i></div>
                <div class="col-span-6 md:col-span-3 row-span-2 bg-emerald-900/20 rounded-2xl border border-emerald-500/20 p-4 flex items-center justify-between tooltip-block" data-info="FATURAMENTO
Cálculo: (KM x Valor) + Taxa Fixa. Considera estimativa para quem está na rua."><div><p class="text-[10px] text-emerald-400 font-bold uppercase mb-1">Faturamento</p><h3 id="kpi-faturamento" class="text-xl font-black text-white">R$ 0,00</h3></div><i data-lucide="dollar-sign" class="w-5 h-5 text-emerald-400"></i></div>
                <div class="col-span-6 md:col-span-3 row-span-2 bg-slate-900/60 rounded-2xl border border-white/5 p-4 flex items-center justify-between tooltip-block" data-info="QUILOMETRAGEM
Soma de toda a distância percorrida pela frota no período."><div><p class="text-[10px] text-cyan-400/80 font-bold uppercase mb-1">KM Total</p><h3 id="kpi-km-total" class="text-xl font-black text-cyan-400">0 KM</h3></div><i data-lucide="activity" class="w-5 h-5 text-cyan-500"></i></div>
                <div class="col-span-12 md:col-span-4 row-span-5 bg-slate-900/60 rounded-2xl border border-white/5 p-4 flex flex-col tooltip-block" data-info="FROTA
Distribuição por tipo de veículo."><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Frota</h4><div class="flex-1 relative"><canvas id="chart-status-realtime"></canvas></div></div>
                <div class="col-span-12 md:col-span-8 row-span-5 bg-slate-900/60 rounded-2xl border border-white/5 p-4 flex flex-col tooltip-block" data-info="RANKING FATURAMENTO
Placas que mais geraram receita no período selecionado."><h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Ranking de Faturamento (Top 10)</h4><div class="flex-1 relative"><canvas id="chart-ranking-realtime"></canvas></div></div>
                <div class="col-span-12 md:col-span-6 row-span-5 bg-slate-900/60 rounded-2xl border border-white/5 flex flex-col overflow-hidden tooltip-block" data-info="LISTA ATIVA
Veículos que estão rodando agora."><div class="p-3 border-b border-white/5 bg-white/[0.02]"><h3 class="text-xs font-black text-white uppercase">Veículos em Rota</h3></div><div id="lista-mon-ativos" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-hide"></div></div>
                <div class="col-span-12 md:col-span-6 row-span-5 bg-slate-900/60 rounded-2xl border border-white/5 flex flex-col overflow-hidden tooltip-block" data-info="FINALIZADOS
Últimas entregas concluídas."><div class="p-3 border-b border-white/5 bg-white/[0.02]"><h3 class="text-xs font-black text-white uppercase">Entregas Recentes</h3></div><div id="lista-mon-finalizados" class="flex-1 overflow-y-auto p-3 space-y-2 scrollbar-hide"></div></div>
            </div>
        </div>

        <div id="modal-notificacoes" class="hidden fixed inset-0 flex items-center justify-center glass z-[3500]"><div class="modal-container h-[60vh] flex flex-col"><div class="flex justify-between mb-6 border-b border-white/10 pb-3"><h3 class="font-black text-amber-500 uppercase text-sm">Mural de Avisos</h3><i data-lucide="x" class="text-slate-400 cursor-pointer hover:text-white" onclick="fecharModal('modal-notificacoes')"></i></div><div id="lista-notificacoes-motorista" class="space-y-3 overflow-y-auto pr-2 flex-1"></div></div></div>
        <div id="modal-ocorrencias-motorista" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container h-[70vh] flex flex-col"><div class="flex justify-between mb-4 border-b border-white/10 pb-3"><h3 class="font-bold text-white uppercase text-sm">Ocorrências da Viagem</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-ocorrencias-motorista')"></i></div><div id="lista-minhas-ocorrencias" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-1"></div><div class="border-t border-white/10 pt-4"><button onclick="document.getElementById('modal-complementos').classList.remove('hidden')" class="btn-primary !py-3 text-xs flex items-center justify-center gap-2"><i data-lucide="plus"></i> Nova Ocorrência</button></div></div></div>
        <div id="modal-complementos" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="font-bold uppercase text-sm text-white">Novo Evento</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-complementos')"></i></div><select id="comp-tipo" class="input-style mb-4 appearance-none text-sm cursor-pointer"><option>Observação</option><option>Abastecimento</option><option>Pedágio</option><option>Pneu Furado</option><option>Parada Policial</option></select><textarea id="comp-obs" placeholder="Detalhes..." class="input-style h-24 mb-6 text-sm resize-none"></textarea><button onclick="salvarObservacaoMotorista()" class="btn-primary !py-3 text-xs">SALVAR</button></div></div>
        <div id="modal-ver-obs" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container h-[60vh] flex flex-col"><div class="flex justify-between mb-4 border-b border-white/10 pb-3"><h3 class="font-bold text-blue-500 uppercase text-sm">Histórico</h3><i data-lucide="x" class="cursor-pointer text-slate-400" onclick="fecharModal('modal-ver-obs')"></i></div><div id="conteudo-obs-admin" class="space-y-3 overflow-auto flex-1"></div></div></div>
        <div id="modal-tabela-extrato" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]"><div class="modal-container !max-w-4xl h-[90vh] flex flex-col p-0 overflow-hidden bg-[#0f172a]"><div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-900"><div><h3 class="text-white font-black uppercase text-xs">Histórico</h3><p id="extrato-placa-titulo" class="text-[9px] text-cyan-400 font-bold uppercase mt-0.5">Carregando...</p></div><button onclick="fecharModal('modal-tabela-extrato')" class="hover:bg-white/10 p-2 rounded-full"><i data-lucide="x" class="text-slate-400 w-5 h-5"></i></button></div><div class="p-3 bg-slate-800/50 flex gap-2 items-center justify-between border-b border-white/5"><div class="flex gap-2"><input type="date" id="mot-data-ini" onchange="atualizarExtratoVisual()" class="bg-slate-900 text-white text-[10px] p-2 rounded-lg border border-white/10 outline-none uppercase"><input type="date" id="mot-data-fim" onchange="atualizarExtratoVisual()" class="bg-slate-900 text-white text-[10px] p-2 rounded-lg border border-white/10 outline-none uppercase"></div><button onclick="gerarExcelMotorista()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold px-4 py-2 rounded-lg uppercase transition-colors flex items-center gap-2"><i data-lucide="download" class="w-3 h-3"></i> Excel</button></div><div class="flex-1 overflow-auto bg-slate-950/50"><table class="w-full text-left border-collapse"><thead class="bg-slate-900/90 sticky top-0 z-10 backdrop-blur-sm"><tr><th class="p-3 text-[9px] uppercase text-slate-500 font-bold">Data</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold">Destino</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">KM</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">Total</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">Dif</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">Fotos</th><th class="p-3 text-[9px] uppercase text-slate-500 font-bold text-center">Wpp</th></tr></thead><tbody id="corpo-extrato" class="divide-y divide-white/5"></tbody></table></div></div></div>
        <div id="modal-config-valores" class="hidden fixed inset-0 flex items-center justify-center glass z-[4000]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="text-emerald-400 font-bold uppercase text-sm flex gap-2"><i data-lucide="dollar-sign"></i> Preços</h3><button onclick="fecharModal('modal-config-valores')"><i data-lucide="x" class="text-slate-400"></i></button></div><div class="space-y-3"><label class="text-[9px] text-slate-400 font-bold uppercase ml-2">Perfil</label><select id="cfg-perfil" onchange="carregarValoresInput()" class="input-style font-bold text-center appearance-none cursor-pointer"></select><div class="grid grid-cols-2 gap-3"><div><label class="text-[9px] text-slate-400 font-bold uppercase ml-2">R$/KM</label><input type="number" id="cfg-vlr-km" step="0.01" class="input-style text-center font-mono"></div><div><label class="text-[9px] text-slate-400 font-bold uppercase ml-2">Fixo</label><input type="number" id="cfg-vlr-fixo" step="0.01" class="input-style text-center font-mono"></div></div><button onclick="salvarConfigValor()" class="btn-primary !bg-emerald-600 hover:!bg-emerald-500">SALVAR</button><div class="mt-4 border-t border-white/10 pt-4"><div id="lista-config-valores" class="space-y-2 max-h-40 overflow-y-auto"></div></div></div></div></div>
        <div id="modal-importar-previsao" class="hidden fixed inset-0 flex items-center justify-center glass z-[1800]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="text-purple-400 font-bold uppercase text-sm flex gap-2"><i data-lucide="upload-cloud"></i> Importar (Pagé)</h3><button onclick="fecharModal('modal-importar-previsao')"><i data-lucide="x" class="text-slate-400"></i></button></div><input type="date" id="data-importacao" class="input-style mb-4 text-xs font-bold text-center cursor-pointer"><input type="file" id="file-previsao" accept=".xlsx" class="input-style mb-4 text-xs cursor-pointer"><button onclick="processarPlanilhaPrevisao()" class="btn-primary !bg-purple-600 hover:!bg-purple-500 mb-2">Processar</button></div></div>
        <div id="modal-export" class="hidden fixed inset-0 flex items-center justify-center glass z-[1800]"><div class="modal-container"><div class="flex justify-between mb-6"><h3 class="text-emerald-400 font-bold uppercase text-sm flex gap-2"><i data-lucide="database"></i> Dados</h3><button onclick="fecharModal('modal-export')"><i data-lucide="x" class="text-slate-400"></i></button></div><div class="grid grid-cols-2 gap-3 mb-6"><input type="date" id="data-exp-inicio" class="input-style !p-3 text-center !text-xs cursor-pointer"><input type="date" id="data-exp-fim" class="input-style !p-3 text-center !text-xs cursor-pointer"></div><button onclick="gerarExcelAdmin()" class="btn-primary !bg-emerald-600 hover:!bg-emerald-500 mb-3">Baixar Excel</button><button onclick="excluirPeriodoSelecionado()" class="w-full py-3 border border-red-500/30 bg-red-500/10 text-red-400 rounded-xl text-[10px] font-bold uppercase hover:bg-red-500/20">Excluir Período</button></div></div>
        <div id="modal-gerenciar-notif" class="hidden fixed inset-0 flex items-center justify-center glass z-[2500]"><div class="modal-container"><div class="flex justify-between mb-4"><h3 class="font-bold uppercase text-amber-500 text-xs flex gap-2"><i data-lucide="megaphone"></i> Novo Aviso</h3><i data-lucide="x" class="text-slate-400 cursor-pointer" onclick="fecharModal('modal-gerenciar-notif')"></i></div><textarea id="notif-texto" placeholder="Mensagem..." class="input-style h-24 mb-4 resize-none text-sm"></textarea><button onclick="salvarNotificacao()" class="btn-primary !bg-amber-600 hover:!bg-amber-500 mb-6 text-white text-xs !py-3">ENVIAR</button><div id="lista-notif-admin" class="max-h-40 overflow-auto space-y-2 pr-2"></div></div></div>
        <div id="modal-gerar-codigo" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]"><div class="modal-container text-center"><i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-gerar-codigo')"></i><h3 class="text-cyan-400 font-black uppercase text-sm mb-6">Acesso Condutor</h3><select id="gc-placa-select" class="input-style mb-4 font-bold text-center appearance-none cursor-pointer"></select><div id="display-codigo-gerado" class="hidden py-6 bg-black/40 rounded-2xl text-5xl font-black text-white tracking-[8px] mb-4 font-mono border border-cyan-500/20">0000</div><button onclick="processarGeracaoCodigo()" class="btn-primary mt-2">GERAR SENHA</button></div></div>
        <div id="modal-extrato-login" class="hidden fixed inset-0 flex items-center justify-center glass z-[2000]"><div class="modal-container text-center"><i data-lucide="x" class="absolute top-4 right-4 cursor-pointer text-slate-500 hover:text-white" onclick="fecharModal('modal-extrato-login')"></i><h3 class="text-white font-black uppercase text-sm mb-6">Acesso Histórico</h3><input type="text" id="login-placa-manual" placeholder="PLACA DO VEÍCULO" class="input-style mb-3 text-center uppercase font-bold tracking-widest"><input type="tel" id="login-codigo" placeholder="SENHA" class="input-style mb-6 text-center tracking-[10px] font-bold text-xl" maxlength="4"><button onclick="validarAcessoExtrato()" class="btn-primary">ACESSAR</button></div></div>
        <div id="modal-sucesso-viagem" class="hidden fixed inset-0 flex items-center justify-center glass z-[5000]"><div class="modal-container text-center border-emerald-500/30"><div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6"><i data-lucide="check" class="text-emerald-400 w-10 h-10"></i></div><h3 class="text-xl font-black text-white uppercase mb-2">Sucesso!</h3><p class="text-slate-400 text-xs mb-8">Viagem finalizada.</p><button id="btn-share-wpp" class="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold uppercase p-4 rounded-xl flex items-center justify-center gap-3 mb-3 text-xs transition-colors"><i data-lucide="message-circle" class="w-5 h-5"></i> Enviar WhatsApp</button><button onclick="location.reload()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold uppercase p-3 rounded-xl text-xs transition-colors">Voltar</button></div></div>
        <div id="modal-alerta-24h" class="hidden fixed inset-0 flex items-center justify-center bg-black/95 z-[9999]"><div class="modal-container border-red-500 text-center animate-pulse"><i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i><h2 class="text-2xl font-black text-red-500 uppercase mb-2">Atenção!</h2><p class="text-white text-sm mb-6">Viagem aberta há mais de 24h.</p><button onclick="document.getElementById('modal-alerta-24h').classList.add('hidden')" class="w-full bg-red-600 hover:bg-red-500 p-4 rounded-xl font-bold uppercase text-white">Entendi</button></div></div>
        <div id="modal-tutorial" class="hidden fixed inset-0 flex items-center justify-center glass z-[3000]"><div class="modal-container !max-w-md bg-[#0f172a] relative overflow-hidden"><button onclick="fecharModal('modal-tutorial')" class="absolute top-4 right-4 text-slate-500 hover:text-white z-20"><i data-lucide="x"></i></button><div id="tutorial-content" class="flex flex-col items-center justify-center text-center py-8"></div><div class="flex justify-between items-center mt-4 border-t border-white/5 pt-4"><button onclick="passoAnterior()" class="text-slate-400 hover:text-white text-xs font-bold uppercase flex items-center gap-1">Voltar</button><div id="tutorial-dots" class="flex gap-1"></div><button onclick="proximoPasso()" class="text-blue-400 hover:text-blue-300 text-xs font-bold uppercase flex items-center gap-1">Próximo</button></div></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, setDoc, updateDoc, Timestamp, arrayUnion, getDoc, getDocs, where, limit } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA3TviypEfSWilOz4_3TqJP1JwB7LIa49U", authDomain: "marcador-ponto-digital.firebaseapp.com", projectId: "marcador-ponto-digital", storageBucket: "marcador-ponto-digital.firebasestorage.app", messagingSenderId: "774324665760", appId: "1:774324665760:web:2c4e9c42eaaa347e32b8c5" };
        const app = initializeApp(firebaseConfig); 
        const db = getFirestore(app);

        // VARIÁVEIS GLOBAIS
        const PERFIS_PADRAO = { "FIORINO": { valorFrete: 268.00, valorKm: 1.12 }, "VAN": { valorFrete: 407.00, valorKm: 1.28 }, "VUC": { valorFrete: 440.00, valorKm: 1.35 }, "LEVE 3/4": { valorFrete: 528.00, valorKm: 1.54 }, "LEVE 3/4 ESPECIAL": { valorFrete: 545.00, valorKm: 1.60 }, "TOCO": { valorFrete: 880.00, valorKm: 1.67 }, "TRUCK": { valorFrete: 1012.00, valorKm: 1.87 } };
        let listaGlobalViagens = [], listaNotificacoes = [], filtroAdminAtual = 'todos', isFirstLoadNotif = true;
        let placaLogadaAtual = "";
        let globalPrecos = {};
        let globalPrevisoesHoje = {}; 
        let chartStatus = null, chartRanking = null, monitInterval = null;
        const bipSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); 
        let tutorialPasso = 0;
        let sistemaCarregado = false; 

        const tutorialSteps = [
            { titulo: "Bem-vindo!", texto: "O IcaphiDrive ajuda você a controlar suas entregas e viagens em tempo real, com cálculo automático de rotas.", icone: "truck" },
            { titulo: "Iniciar Rota", texto: "Preencha a placa, o KM inicial e tire uma foto do painel. Seus dados são salvos automaticamente.", icone: "play-circle" },
            { titulo: "Em Viagem", texto: "Acompanhe o tempo decorrido. Se precisar, registre ocorrências como paradas ou abastecimentos.", icone: "clock" },
            { titulo: "Finalizar", texto: "Ao chegar, informe o KM final e tire a foto. O sistema calcula a diferença da rota prevista.", icone: "check-circle" },
            { titulo: "Histórico", texto: "Acesse suas viagens passadas usando sua placa e senha (gere a senha com o administrador).", icone: "file-text" },
            { titulo: "Alertas", texto: "Fique atento ao sino no topo. Avisos importantes da empresa aparecerão ali.", icone: "bell" }
        ];

        // HELPERS
        const normalizarPlaca = (valor) => { if (!valor) return ""; return String(valor).toUpperCase().replace(/[^A-Z0-9]/g, ''); };
        const safeDate = (ts) => { if(!ts) return null; try{ if(ts.toDate) return ts.toDate(); if(ts.seconds) return new Date(ts.seconds*1000); return new Date(ts); }catch(e){return null;} };
        const safeStr = (v) => v ? String(v) : '';
        const safeNum = (v) => { const n = Number(v); return isNaN(n) ? 0 : n; };

        // CARREGA PREVISÕES DO DIA PARA MEMÓRIA
        const carregarPrevisoesDoDia = async () => {
            const hoje = new Date().toISOString().split('T')[0];
            const q = query(collection(db, "previsoes"), where("dataReferencia", "==", hoje));
            const snap = await getDocs(q);
            globalPrevisoesHoje = {};
            snap.forEach(d => {
                const data = d.data();
                if(data.rotas && data.rotas.length > 0) {
                    globalPrevisoesHoje[data.placa] = data.rotas;
                }
            });
            renderizarAdmin(); 
        };

        // IMPORTADOR PAGÉ
        window.processarPlanilhaPrevisao = async () => { 
            const dt = document.getElementById('data-importacao').value; 
            const file = document.getElementById('file-previsao').files[0]; 
            if(!dt || !file) return alert("Dados incompletos."); 
            showLoader(); 
            const reader = new FileReader(); 
            reader.onload = async (e) => { 
                try { 
                    const data = new Uint8Array(e.target.result); 
                    const workbook = XLSX.read(data, {type: 'array'}); 
                    const sheet = workbook.Sheets["BASE PAGÉ"] || workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, {header: 1}); 
                    
                    let mapaRotas = {};

                    json.forEach(row => { 
                        if(row.length > 2) { 
                            let rawPlaca = row[3] || row[1];
                            const placa = normalizarPlaca(rawPlaca);
                            
                            if(placa.length >= 5) {
                                let km = row[14];
                                if (km === undefined) km = row[12];
                                if (km === undefined) km = row[13];
                                let kmFinal = Number(km);
                                if(isNaN(kmFinal)) kmFinal = 0; 

                                let perf = "PADRÃO";
                                if(row[14] !== undefined) perf = row[4]; 
                                else if(row[12] !== undefined) perf = row[3]; 
                                else perf = row[4] || row[3]; 
                                perf = (perf || "PADRÃO").toString().toUpperCase().trim();
                                
                                const cid = (row[9] || row[8] || "").toString().toUpperCase().trim();
                                
                                if(!mapaRotas[placa]) mapaRotas[placa] = [];
                                const existe = mapaRotas[placa].find(r => r.km === kmFinal && r.cidades === cid);
                                if(!existe) {
                                    mapaRotas[placa].push({ km: kmFinal, perfil: perf, cidades: cid });
                                }
                            }
                        } 
                    });

                    let batchPromises = [];
                    for(const [placa, rotas] of Object.entries(mapaRotas)) {
                        batchPromises.push(setDoc(doc(db, "previsoes", `${placa}_${dt}`), { 
                            placa: placa, dataReferencia: dt, rotas: rotas, atualizadoEm: Date.now() 
                        }));
                    }
                    
                    await Promise.all(batchPromises); 
                    await carregarPrevisoesDoDia(); 
                    hideLoader(); 
                    alert(`Importação concluída! Processadas ${Object.keys(mapaRotas).length} placas.`); 
                    fecharModal('modal-importar-previsao'); 
                } catch(err) { hideLoader(); alert("Erro: " + err.message); } 
            }; 
            reader.readAsArrayBuffer(file); 
        };
        
        // INICIAR VIAGEM OTIMIZADO
        window.iniciarViagem = async () => { 
            const n = document.getElementById('motorista').value;
            const p = normalizarPlaca(document.getElementById('placa').value);
            const k = document.getElementById('km-inicio').value;
            const f = document.getElementById('foto-inicio').files[0];
            const t = document.getElementById('tipo-servico').value; 
            
            if(!n || !p || !k || !f) return alert("Preencha tudo!"); 
            
            showLoader("Obtendo Localização e Processando Foto..."); 
            
            try { 
                const [pos, fotoComprimida] = await Promise.all([
                    obterPosicao(),
                    comprimir(f)
                ]);

                showLoader("Buscando Previsões...");
                
                const hojeStr = new Date().toISOString().split('T')[0]; 
                let docPrev = null;
                try { docPrev = await getDoc(doc(db, "previsoes", `${p}_${hojeStr}`)); } catch(e){}

                let rotasPossiveis = [];
                let perfilEncontrado = "PADRÃO";
                let cidadesEncontradas = "";
                
                if(docPrev && docPrev.exists()) { 
                    const dados = docPrev.data();
                    if(dados.rotas && dados.rotas.length > 0) {
                        rotasPossiveis = dados.rotas;
                        perfilEncontrado = dados.rotas[0].perfil; 
                        cidadesEncontradas = dados.rotas[0].cidades;
                    }
                } else { 
                    const hist = await obterPerfilRecente(p); 
                    if(hist) perfilEncontrado = hist; 
                } 

                showLoader("Salvando Dados...");

                const docRef = await addDoc(collection(db, "viagens"), { 
                    nome: n, placa: p, kmInicio: Number(k), fotoInicio: fotoComprimida, dataInicio: Timestamp.now(), locInicio: `${pos.coords.latitude},${pos.coords.longitude}`, 
                    status: "em_curso", tipoServico: t, historico_obs: [], 
                    rotasPossiveis: rotasPossiveis, 
                    perfilVeiculo: perfilEncontrado,
                    rotaCidades: cidadesEncontradas
                }); 
                
                localStorage.setItem('v_id', docRef.id); 
                location.reload(); 
            } catch (e) { hideLoader(); alert("Erro: " + e.message); } 
        };

        // UI & HELPERS
        window.fecharModal = (id) => document.getElementById(id).classList.add('hidden');
        window.mudarTela = (t) => { if(localStorage.getItem('v_id') && t !== 'em-curso') return; document.querySelectorAll('main').forEach(m => m.classList.add('hidden')); document.getElementById('tela-'+t).classList.remove('hidden'); if(window.lucide) lucide.createIcons(); };
        window.fotoTirada = (id, idc) => { document.getElementById(id).innerText = 'OK, ANEXADO'; document.getElementById(idc).classList.add('attached'); };
        
        const showLoader = (msg = "Carregando...") => { 
            document.getElementById('loader-msg').innerText = msg;
            document.getElementById('main-loader').style.display = 'flex'; 
            setTimeout(() => document.getElementById('main-loader').style.opacity = '1', 10); 
        };
        const hideLoader = () => { const l = document.getElementById('main-loader'); l.style.opacity = '0'; setTimeout(() => l.style.display = 'none', 500); };
        
        window.abrirTutorial = () => { tutorialPasso = 0; renderizarTutorial(); document.getElementById('modal-tutorial').classList.remove('hidden'); };
        window.renderizarTutorial = () => { const s = tutorialSteps[tutorialPasso]; document.getElementById('tutorial-content').innerHTML = `<div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mb-4 mx-auto"><i data-lucide="${s.icone}" class="w-8 h-8 text-blue-400"></i></div><h3 class="text-xl font-black text-white uppercase mb-2">${s.titulo}</h3><p class="text-sm text-slate-400 px-4">${s.texto}</p>`; document.getElementById('tutorial-dots').innerHTML = tutorialSteps.map((_, i) => `<div class="w-2 h-2 rounded-full ${i === tutorialPasso ? 'bg-blue-500' : 'bg-slate-700'}"></div>`).join(''); if(window.lucide) lucide.createIcons(); };
        window.proximoPasso = () => { if(tutorialPasso < tutorialSteps.length - 1) { tutorialPasso++; renderizarTutorial(); } else { fecharModal('modal-tutorial'); } };
        window.passoAnterior = () => { if(tutorialPasso > 0) { tutorialPasso--; renderizarTutorial(); } };

        window.alternarModoPC = () => { const w = document.getElementById('app-wrap'), l = document.getElementById('lista-viagens'), c = document.getElementById('grid-controls'); w.classList.toggle('max-w-[420px]'); w.classList.toggle('w-full-pc'); w.classList.toggle('!max-w-full'); l.classList.toggle('grid-pc'); l.classList.toggle('space-y-4'); if(w.classList.contains('w-full-pc')) c.classList.remove('hidden'); else c.classList.add('hidden'); };
        window.mudarGrade = (n) => document.documentElement.style.setProperty('--pc-cols', n);
        window.filtrarStatus = (s) => { filtroAdminAtual = s; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); document.getElementById('filt-'+s).classList.add('active'); renderizarAdmin(); };
        window.fecharPopup = (id) => document.getElementById(id).classList.remove('active');
        window.verFoto = (u) => { if(!u) return alert("Indisponível"); document.getElementById('img-viewer').src = u; document.getElementById('popup-foto').classList.add('active'); };
        window.verGps = (c) => { if(!c || c==='0,0') return alert("Indisponível"); const [lat,lon] = c.split(','); document.getElementById('iframe-gps').src = `https://maps.google.com/maps?q=${lat},${lon}&z=15&output=embed`; document.getElementById('popup-gps').classList.add('active'); };

        // RENDERIZAÇÃO ADMIN (CORRIGIDA - DADOS FANTASMAS)
        window.renderizarAdmin = () => {
            const container = document.getElementById('lista-viagens');
            const busca = document.getElementById('busca-admin').value.toLowerCase();
            const dtIniStr = document.getElementById('admin-dt-ini').value;
            const dtFimStr = document.getElementById('admin-dt-fim').value;
            
            let dados = listaGlobalViagens.filter(v => {
                const matchBusca = safeStr(v.nome).toLowerCase().includes(busca) || safeStr(v.placa).toLowerCase().includes(busca);
                const matchStatus = filtroAdminAtual === 'todos' || v.status === filtroAdminAtual;
                let matchData = true;
                if(dtIniStr && dtFimStr && v.dataInicio) {
                    const d = safeDate(v.dataInicio);
                    const i = new Date(dtIniStr + "T00:00:00");
                    const f = new Date(dtFimStr + "T23:59:59");
                    matchData = d >= i && d <= f;
                }
                return matchBusca && matchStatus && matchData;
            });

            if(!busca && !dtIniStr && filtroAdminAtual === 'todos') dados = dados.slice(0, 50);

            if(dados.length === 0) { container.innerHTML = `<div class="text-center py-10"><p class="text-slate-500 text-sm font-bold">Nenhuma viagem encontrada.</p></div>`; return; }

            container.innerHTML = dados.map(v => {
                const isE = v.status === 'em_curso', isC = v.status === 'cancelada', isF = v.status === 'finalizada';
                const dIni = safeDate(v.dataInicio), dFim = safeDate(v.dataFim);
                const kmIni = safeNum(v.kmInicio), kmFim = v.kmFim ? safeNum(v.kmFim) : 0;
                const kmTotal = v.kmFim ? (kmFim - kmIni).toFixed(1) : 0;
                
                let placaNorm = normalizarPlaca(v.placa);
                let rotaImportadaRecente = globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0];
                
                // Prioridade 1: Dados salvos na viagem
                // Prioridade 2: Dados da planilha de HOJE (se existir)
                // Prioridade 3: Histórico (apenas para perfil, NUNCA para cidade/km)
                
                let perfilExibir = v.perfilVeiculo || (rotaImportadaRecente ? rotaImportadaRecente.perfil : "PADRÃO");
                
                let cidadeExibir = v.rotaCidades; 
                if(!cidadeExibir && rotaImportadaRecente) cidadeExibir = rotaImportadaRecente.cidades;
                
                let kmMetaExibir = (v.rotasPossiveis && v.rotasPossiveis[0]) ? v.rotasPossiveis[0].km : 0;
                if(kmMetaExibir === 0 && rotaImportadaRecente) kmMetaExibir = rotaImportadaRecente.km;

                // Se não tem info nem na viagem nem na planilha de hoje, deixa VAZIO
                if(!v.rotaCidades && !rotaImportadaRecente) {
                    cidadeExibir = null;
                    kmMetaExibir = 0;
                }
                
                let alertaDuplicidade = "";
                let rotasParaVerificar = (v.rotasPossiveis && v.rotasPossiveis.length > 0) ? v.rotasPossiveis : (globalPrevisoesHoje[placaNorm] || []);
                
                if(rotasParaVerificar.length > 1 && isE) {
                    const options = rotasParaVerificar.map((r, i) => `<option value="${i}" ${v.rotaIndexSelected === i ? 'selected' : ''}>${r.km || '0'}km - ${r.cidades || 'S/ Cidade'} (${r.perfil})</option>`).join('');
                    alertaDuplicidade = `<div class="mb-3 bg-amber-500/10 border border-amber-500/30 p-2 rounded-lg animate-pulse"><p class="text-[9px] text-amber-500 font-bold uppercase mb-1 flex items-center gap-1"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Duplicidade: Escolha a Rota</p><select onchange="selecionarRotaDuplicada('${v.id}', this.value)" class="w-full bg-slate-900 text-white text-[10px] p-1 rounded border border-white/10 outline-none uppercase font-bold cursor-pointer hover:bg-slate-800"><option value="">Selecione...</option>${options}</select></div>`;
                }

                let metaHtml = "";
                // Só mostra diferença se tiver META definida
                if(kmMetaExibir > 0 && isF) { 
                    const diff = kmTotal - kmMetaExibir;
                    const color = diff > 0 ? "text-red-400" : "text-emerald-400";
                    const sinal = diff > 0 ? "+" : "";
                    metaHtml = `<div class="mt-2 bg-slate-900/50 p-2 rounded-lg border border-white/5 text-[9px] uppercase font-bold flex justify-between"><span class="text-slate-500">Meta: <span class="text-white">${Math.round(kmMetaExibir)}</span></span><span class="${color}">Dif: ${sinal}${Math.round(diff)} km</span></div>`;
                } else if (!cidadeExibir && !kmMetaExibir && !isC) {
                    metaHtml = `<div class="mt-2 bg-slate-900/50 p-2 rounded-lg border border-white/5 text-[9px] uppercase font-bold text-center text-slate-500"><i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i> SEM ROTA / IMPORTAÇÃO</div>`;
                }

                let tagsHtml = "";
                if(perfilExibir) tagsHtml += `<span class="bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded text-[10px] mr-1 border border-blue-500/30 uppercase">${perfilExibir}</span>`;
                if(cidadeExibir) tagsHtml += `<span class="bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded text-[10px] border border-purple-500/30 uppercase max-w-[150px] truncate inline-block align-bottom" title="${cidadeExibir}">${cidadeExibir}</span>`;

                let financeiroHtml = "";
                const perfilPreco = globalPrecos[perfilExibir] || PERFIS_PADRAO[perfilExibir] || { valorKm: 0, valorFrete: 0 };
                
                if(perfilPreco.valorKm > 0 || perfilPreco.valorFrete > 0) {
                    let kmBase = 0;
                    let labelFin = "";
                    let colorFin = "";
                    let mostrar = false;
                    const temInformacao = cidadeExibir || (kmMetaExibir > 0);

                    if(isE) {
                        // Se não tem informação de rota, calcula apenas o FRETE (kmBase = 0)
                        kmBase = temInformacao ? (kmMetaExibir || 0) : 0;
                        labelFin = "ESTIMADO";
                        colorFin = "text-amber-500";
                        mostrar = true;
                    } else if (isF) {
                        kmBase = kmTotal;
                        labelFin = "FATURAMENTO";
                        colorFin = "text-emerald-400";
                        mostrar = true;
                    }

                    if(mostrar && !isC) {
                        const valKm = kmBase * perfilPreco.valorKm;
                        const total = valKm + perfilPreco.valorFrete;
                        financeiroHtml = `<div class="mt-3 bg-slate-900/50 border border-white/5 p-2 rounded-lg flex justify-between items-center"><div class="flex flex-col text-left"><span class="text-[8px] ${colorFin} font-bold uppercase">${labelFin}</span><span class="text-[8px] text-slate-500">Frete (${perfilPreco.valorFrete}) + Km (${valKm.toFixed(0)})</span></div><div class="text-right"><span class="text-xs font-black text-white">R$ ${total.toFixed(2)}</span></div></div>`;
                    }
                }
                
                return `
                <div class="admin-card ${isE ? 'em-curso' : ''} ${isC ? 'cancelada' : ''}">
                    <div class="flex justify-between items-start mb-2"><div>${isE ? '<span class="text-amber-500 bg-amber-500/10 px-2 py-0.5 rounded text-[9px] font-black uppercase">EM ROTA</span>' : isC ? '<span class="text-red-500 bg-red-500/10 px-2 py-0.5 rounded text-[9px] font-black uppercase">CANCELADA</span>' : '<span class="text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded text-[9px] font-black uppercase">FINALIZADA</span>'} <span class="text-[9px] text-slate-500 uppercase font-bold ml-1">• ${v.tipoServico || 'Geral'}</span><h2 class="text-lg font-black uppercase text-white leading-tight mt-1">${v.nome || 'Motorista'}</h2><p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">${v.placa || 'PLACA'}</p></div><div class="flex gap-1"><button onclick="compartilharWpp('${v.id}')" class="text-emerald-400 bg-emerald-500/10 p-2 rounded-lg hover:bg-emerald-500/20" data-tooltip="WhatsApp"><i data-lucide="message-circle" class="w-4 h-4"></i></button><button onclick="excluirCard('${v.id}')" class="text-red-400 bg-red-500/10 p-2 rounded-lg hover:bg-red-500/20" data-tooltip="Excluir"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>
                    <div>
                        ${alertaDuplicidade}
                        <div class="mb-3 font-bold flex flex-wrap gap-1">${tagsHtml}</div>
                        <div class="flex justify-between items-center mb-4 px-1 text-[9px] font-bold text-slate-400 uppercase"><div class="flex flex-col"><span>Saída: ${dIni ? dIni.toLocaleDateString() : '--'}</span><span class="text-blue-400">${dIni ? dIni.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '--:--'}</span></div><div class="w-8 h-[1px] bg-white/10"></div><div class="flex flex-col text-right"><span>Chegada: ${dFim ? dFim.toLocaleDateString() : '...'}</span><span class="text-emerald-400">${dFim ? dFim.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '...'}</span></div></div>
                        <div class="grid grid-cols-3 gap-2 text-center mb-2 bg-slate-900/50 p-2 rounded-xl border border-white/5"><div><p class="text-[8px] text-slate-500 uppercase font-bold mb-0.5">Início</p><p class="font-bold text-white text-sm font-mono">${kmIni}</p></div><div class="border-l border-white/5"><p class="text-[8px] text-slate-500 uppercase font-bold mb-0.5">Fim</p><p class="font-bold text-white text-sm font-mono">${v.kmFim || '-'}</p></div><div class="border-l border-white/5"><p class="text-[8px] text-cyan-500 uppercase font-bold mb-0.5">Total</p><p class="font-bold text-cyan-400 text-sm font-mono">${v.kmFim ? kmTotal : '-'}</p></div></div>
                        ${metaHtml}
                        ${financeiroHtml}
                        <div id="admin-timer-${v.id}" class="text-2xl font-black text-center mb-4 ${isE ? 'text-amber-500' : 'text-slate-600'} font-mono tracking-tighter drop-shadow-sm mt-4">${isE ? '00:00:00' : (v.duracao || '--')}</div>
                    </div>
                    <div class="mt-auto">
                        <div class="grid grid-cols-2 gap-2 text-[9px] font-bold uppercase"><div class="flex flex-col gap-2"><button onclick="verGps('${v.locInicio}')" class="glass p-2 rounded-lg flex items-center justify-center gap-2 text-slate-400 hover:text-white w-full"><i data-lucide="map-pin" class="w-3 h-3 text-blue-500"></i> GPS Início</button><button onclick="verFoto('${v.fotoInicio}')" class="glass p-2 rounded-lg flex items-center justify-center gap-2 text-slate-400 hover:text-white w-full"><i data-lucide="image" class="w-3 h-3 text-blue-500"></i> Foto Início</button></div><div class="flex flex-col gap-2"><button onclick="verGps('${v.locFim}')" class="glass p-2 rounded-lg flex items-center justify-center gap-2 text-slate-400 hover:text-white w-full"><i data-lucide="map-pin" class="w-3 h-3 text-red-500"></i> GPS Fim</button>${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="glass p-2 rounded-lg flex items-center justify-center gap-2 text-slate-400 hover:text-white w-full"><i data-lucide="image" class="w-3 h-3 text-red-500"></i> Foto Fim</button>` : ''}</div></div>
                        <button onclick="abrirObsAdmin('${v.id}')" class="w-full mt-3 bg-slate-800/50 text-slate-400 text-[9px] py-2 rounded-lg hover:bg-slate-800 uppercase font-bold border border-white/5">${v.historico_obs?.length > 0 ? `<span class="text-amber-400">Ver ${v.historico_obs.length} Ocorrências</span>` : 'Nenhuma Ocorrência'}</button>
                    </div>
                </div>`;
            }).join('');
            if(window.lucide) lucide.createIcons();
        };

        window.selecionarRotaDuplicada = async (viagemId, index) => {
            if(index === "") return;
            showLoader();
            await updateDoc(doc(db, "viagens", viagemId), { rotaIndexSelected: Number(index) });
            hideLoader();
        };

        // ENCERRAR VIAGEM OTIMIZADO
        window.encerrarViagem = async () => {
            const id = localStorage.getItem('v_id'); if(!id) return;
            const kf = document.getElementById('km-fim').value, ff = document.getElementById('foto-fim').files[0];
            if(!kf || !ff) return alert("Preencha KM final e Foto.");
            
            showLoader("Processando Dados Finais...");
            
            try {
                const docRef = doc(db, "viagens", id);
                const [snap, pos, fotoComprimida] = await Promise.all([
                    getDoc(docRef),
                    obterPosicao(),
                    comprimir(ff)
                ]);

                showLoader("Salvando e Finalizando...");

                const v = snap.data();
                const duracao = document.getElementById('cronometro-motorista').innerText;
                
                const dInicio = safeDate(v.dataInicio);
                const diffMin = (Date.now() - dInicio.getTime()) / 60000;
                let status = "finalizada", msg = "";
                if(diffMin < 20) { status = "cancelada"; msg = "Viagem muito curta. Cancelada."; }
                
                let placaNorm = normalizarPlaca(v.placa);
                let rotaFinal = (v.rotasPossiveis && v.rotasPossiveis.length > 0) ? 
                    ((v.rotaIndexSelected !== undefined) ? v.rotasPossiveis[v.rotaIndexSelected] : v.rotasPossiveis[0]) : 
                    (globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0] ? globalPrevisoesHoje[placaNorm][0] : {});

                await updateDoc(docRef, { 
                    kmFim: Number(kf), fotoFim: fotoComprimida, status: status, duracao: duracao, dataFim: Timestamp.now(), 
                    locFim: `${pos.coords.latitude},${pos.coords.longitude}`,
                    perfilVeiculo: rotaFinal.perfil || v.perfilVeiculo || "PADRÃO",
                    rotaCidades: rotaFinal.cidades || ""
                });
                
                localStorage.removeItem('v_id'); hideLoader();
                if(status === 'cancelada') { alert(msg); location.reload(); }
                else {
                    const totalRodado = (Number(kf) - v.kmInicio).toFixed(1);
                    let txtPrev = "";
                    if(rotaFinal.km !== undefined && rotaFinal.km > 0) {
                        const diff = totalRodado - rotaFinal.km;
                        txtPrev = `%0A🎯 Meta: ${Math.round(rotaFinal.km)}km%0A📊 Dif: ${diff>0?"+":""}${Math.round(diff)}km`;
                    }
                    if(rotaFinal.cidades) txtPrev += `%0A🏙️ Rota: ${rotaFinal.cidades}`;

                    const txt = `*RELATÓRIO DE VIAGEM*%0A---------------------------%0A🚗 Veículo: ${v.placa}%0A👤 Condutor: ${v.nome}%0A📝 Tipo: ${v.tipoServico}%0A📅 Data: ${dInicio.toLocaleDateString()}%0A⏰ Saída: ${dInicio.toLocaleTimeString()}%0A🏁 Chegada: ${new Date().toLocaleTimeString()}%0A---------------------------%0A▶ KM Inicial: ${v.kmInicio}%0A⏹ KM Final: ${kf}%0A📏 Total: ${totalRodado} km%0A⏱ Duração: ${duracao}${txtPrev}`;
                    document.getElementById('btn-share-wpp').onclick = () => window.open(`https://api.whatsapp.com/send?text=${txt}`); 
                    document.getElementById('modal-sucesso-viagem').classList.remove('hidden');
                }
            } catch(e) { hideLoader(); alert("Erro: " + e.message); }
        };

        window.compartilharWpp = (id) => { 
            const v = listaGlobalViagens.find(x => x.id === id); 
            const dIni = safeDate(v.dataInicio);
            const kmFim = v.kmFim || '...';
            const total = v.kmFim ? (v.kmFim - v.kmInicio).toFixed(1) : '...';
            
            let placaNorm = normalizarPlaca(v.placa);
            let rotaAtiva = (v.rotasPossiveis && v.rotasPossiveis.length > 0) ? 
                ((v.rotaIndexSelected !== undefined) ? v.rotasPossiveis[v.rotaIndexSelected] : v.rotasPossiveis[0]) : 
                (globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0] ? globalPrevisoesHoje[placaNorm][0] : {});

            let txtPrev = "";
            if(rotaAtiva && rotaAtiva.km !== undefined && rotaAtiva.km > 0 && v.kmFim) {
                const diff = (v.kmFim - v.kmInicio) - rotaAtiva.km;
                txtPrev = `%0A🎯 Meta: ${Math.round(rotaAtiva.km)}km%0A📊 Dif: ${diff>0 ? "+" : ""}${Math.round(diff)}km`;
            }
            if(rotaAtiva && rotaAtiva.cidades) txtPrev += `%0A🏙️ Rota: ${rotaAtiva.cidades}`;
            
            const txt = `*RESUMO FROTA*%0A---------------------------%0A🚗 Placa: ${v.placa}%0A👤 Motorista: ${v.nome}%0A📝 Tipo: ${v.tipoServico}%0A📅 Data: ${dIni.toLocaleDateString()}%0A⏰ Saída: ${dIni.toLocaleTimeString()}%0A🏁 Chegada: ${v.dataFim ? safeDate(v.dataFim).toLocaleTimeString() : 'Em curso'}%0A---------------------------%0A▶ KM Inicial: ${v.kmInicio}%0A⏹ KM Final: ${kmFim}%0A📏 Total: ${total} km%0A⏱ Tempo: ${v.duracao || '--'}${txtPrev}`;
            window.open(`https://api.whatsapp.com/send?text=${txt}`); 
        };

        // EXPORTAÇÃO EXCEL PROFISSIONAL
        const prepararDadosExportacao = (dados) => {
            return dados.map(v => {
                const dIni = safeDate(v.dataInicio);
                const dFim = safeDate(v.dataFim);
                const kmTotal = (v.kmFim && v.kmInicio) ? (v.kmFim - v.kmInicio) : 0;
                
                let placaNorm = normalizarPlaca(v.placa);
                let rota = (v.rotasPossiveis && v.rotasPossiveis[0]) ? v.rotasPossiveis[0] : 
                           (globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0]);
                
                const kmMeta = rota ? safeNum(rota.km) : 0;
                const difKm = (v.kmFim && kmMeta > 0) ? (kmTotal - kmMeta) : 0;

                return {
                    "DATA": dIni ? dIni.toLocaleDateString() : "-",
                    "HORA SAÍDA": dIni ? dIni.toLocaleTimeString() : "-",
                    "HORA CHEGADA": dFim ? dFim.toLocaleTimeString() : "-",
                    "MOTORISTA": v.nome || "-",
                    "PLACA": v.placa || "-",
                    "TIPO SERVIÇO": v.tipoServico || "-",
                    "PERFIL": v.perfilVeiculo || "-",
                    "ROTA / CIDADES": v.rotaCidades || "-",
                    "KM INICIAL": v.kmInicio || 0,
                    "KM FINAL": v.kmFim || 0,
                    "KM RODADO": kmTotal,
                    "KM META (PREVISÃO)": kmMeta || 0,
                    "DIFERENÇA KM": difKm, // Positivo = rodou a mais, Negativo = economizou
                    "STATUS": v.status ? v.status.toUpperCase() : "-"
                };
            });
        };

        const gerarExcelComEstilo = (dados, nomeArquivo) => {
            const dadosFormatados = prepararDadosExportacao(dados);
            const ws = XLSX.utils.json_to_sheet(dadosFormatados);
            
            // Tenta ajustar largura das colunas (Auto-Width Simples)
            const wscols = Object.keys(dadosFormatados[0] || {}).map(k => ({wch: k.length + 5}));
            ws['!cols'] = wscols;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Relatório");
            XLSX.writeFile(wb, nomeArquivo);
        };

        window.gerarExcelAdmin = async () => { 
            const ini = document.getElementById('data-exp-inicio').value; 
            const fim = document.getElementById('data-exp-fim').value; 
            if(!ini || !fim) return alert("Selecione datas."); 
            showLoader(); 
            const dIni = new Date(ini+"T00:00:00"); 
            const dFim = new Date(fim+"T23:59:59"); 
            const q = query(collection(db, "viagens"), where("dataInicio", ">=", Timestamp.fromDate(dIni)), where("dataInicio", "<=", Timestamp.fromDate(dFim)), orderBy("dataInicio", "desc")); 
            const snaps = await getDocs(q); 
            
            gerarExcelComEstilo(snaps.docs.map(d=>d.data()), `Relatorio_Frota_${ini}.xlsx`); 
            hideLoader(); 
        };

        window.gerarExcelMotorista = async () => { 
            if(!placaLogadaAtual) return; 
            showLoader(); 
            gerarExcelComEstilo(listaGlobalViagens.filter(v=>v.placa===placaLogadaAtual), `Extrato_${placaLogadaAtual}.xlsx`); 
            hideLoader(); 
        };

        window.excluirPeriodoSelecionado = async () => { const ini = document.getElementById('data-exp-inicio').value; const fim = document.getElementById('data-exp-fim').value; if(confirm("Apagar tudo neste período?")) { showLoader(); const dIni = new Date(ini+"T00:00:00"); const dFim = new Date(fim+"T23:59:59"); const q = query(collection(db, "viagens"), where("dataInicio", ">=", Timestamp.fromDate(dIni)), where("dataInicio", "<=", Timestamp.fromDate(dFim))); const snaps = await getDocs(q); await Promise.all(snaps.docs.map(d => deleteDoc(doc(db, "viagens", d.id)))); hideLoader(); alert("Feito."); } };
        window.validarAcessoExtrato = async () => { const p = document.getElementById('login-placa-manual').value.toUpperCase().trim(); const c = document.getElementById('login-codigo').value.trim(); const dr = await getDoc(doc(db, "codigos_acesso", p)); if(dr.exists() && String(dr.data().codigo) === c) { placaLogadaAtual = p; document.getElementById('extrato-placa-titulo').innerText = "Veículo: " + p; fecharModal('modal-extrato-login'); document.getElementById('modal-tabela-extrato').classList.remove('hidden'); if(!document.getElementById('mot-data-ini').value) { const h = new Date(); document.getElementById('mot-data-ini').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('mot-data-fim').value = h.toISOString().split('T')[0]; } atualizarExtratoVisual(); } else { alert("Acesso negado."); } };
        
        window.atualizarExtratoVisual = () => { 
            if(!placaLogadaAtual) return; 
            const iniStr = document.getElementById('mot-data-ini').value; 
            const fimStr = document.getElementById('mot-data-fim').value; 
            let dIni = null, dFim = null; 
            if(iniStr && fimStr) { dIni = new Date(iniStr + "T00:00:00"); dFim = new Date(fimStr + "T23:59:59"); } 
            
            const historico = listaGlobalViagens.filter(v => { 
                const matchPlaca = v.placa.toUpperCase().trim() === placaLogadaAtual; 
                let matchData = true; 
                if(dIni && dFim) { const d = safeDate(v.dataInicio); matchData = d && d >= dIni && d <= dFim; } 
                return matchPlaca && matchData; 
            }).sort((a,b) => safeDate(b.dataInicio) - safeDate(a.dataInicio)); 
            
            document.getElementById('corpo-extrato').innerHTML = historico.map(v => { 
                let placaNorm = normalizarPlaca(v.placa);
                // Lógica igual à exportação para garantir consistência
                let rota = (v.rotasPossiveis && v.rotasPossiveis[0]) ? v.rotasPossiveis[0] : (globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0]);
                const kmMeta = rota ? safeNum(rota.km) : 0;
                const kmTotal = (v.kmFim && v.kmInicio) ? (v.kmFim - v.kmInicio) : 0;
                const diffKm = (v.kmFim && kmMeta > 0) ? (kmTotal - kmMeta) : null; 
                
                return `<tr class="border-b border-white/5 hover:bg-white/5"><td class="p-3 text-[10px] text-white font-bold">${safeDate(v.dataInicio)?.toLocaleDateString()}<br><span class="text-slate-400 font-normal uppercase text-[9px]">${v.nome}</span></td><td class="p-3 text-[9px] text-slate-300 max-w-[80px] truncate">${v.rotaCidades || '-'}</td><td class="p-3 text-center text-[10px] text-slate-300 font-mono">${v.kmInicio} / ${v.kmFim || '...'}</td><td class="p-3 text-center text-[10px] text-white font-black font-mono">${v.kmFim ? kmTotal.toFixed(1) : '-'}</td><td class="p-3 text-center text-[10px] font-bold font-mono ${diffKm !== null && diffKm > 0 ? 'text-red-400' : 'text-emerald-400'}">${diffKm !== null ? (diffKm>0 ? '+'+diffKm.toFixed(0) : diffKm.toFixed(0)) : '-'}</td><td class="p-3 text-center flex justify-center gap-1"><button onclick="verFoto('${v.fotoInicio}')" class="p-1.5 bg-blue-500/10 text-blue-400 rounded-lg hover:bg-blue-500/20"><i data-lucide="log-out" class="w-3 h-3"></i></button>${v.fotoFim ? `<button onclick="verFoto('${v.fotoFim}')" class="p-1.5 bg-emerald-500/10 text-emerald-400 rounded-lg hover:bg-emerald-500/20"><i data-lucide="flag" class="w-3 h-3"></i></button>` : ''}</td><td class="p-3 text-center"><button onclick="compartilharWpp('${v.id}')" class="p-1.5 bg-emerald-500/20 text-emerald-500 rounded-lg"><i data-lucide="message-circle" class="w-3 h-3"></i></button></td></tr>`; 
            }).join(''); if(window.lucide) lucide.createIcons(); 
        };

        window.abrirModalOcorrenciasMotorista = () => { document.getElementById('modal-ocorrencias-motorista').classList.remove('hidden'); renderizarMinhasOcorrencias(); };
        window.renderizarMinhasOcorrencias = async () => { const id = localStorage.getItem('v_id'); const docRef = doc(db, "viagens", id); const snap = await getDoc(docRef); if(snap.exists()) { const obs = snap.data().historico_obs || []; const lista = document.getElementById('lista-minhas-ocorrencias'); if(obs.length === 0) { lista.innerHTML = "<p class='text-center text-slate-500 text-xs py-4'>Nenhuma ocorrência registrada.</p>"; return; } lista.innerHTML = obs.map((o, idx) => `<div class="bg-slate-800/50 p-3 rounded-xl border border-white/5 relative"><div class="flex justify-between items-start mb-1"><span class="text-[10px] text-cyan-400 font-bold uppercase">${o.tipo}</span><span class="text-[9px] text-slate-500 font-mono">${o.hora}</span></div><p class="text-xs text-slate-300 pr-6">${o.texto}</p><div class="flex gap-2 mt-3 justify-end border-t border-white/5 pt-2"><button onclick="excluirOcorrencia(${idx})" class="text-red-400 text-[10px] font-bold uppercase hover:bg-red-500/10 px-2 py-1 rounded">Excluir</button></div></div>`).join(''); if(window.lucide) lucide.createIcons(); } };
        window.excluirOcorrencia = async (index) => { if(!confirm("Excluir esta ocorrência?")) return; const id = localStorage.getItem('v_id'); const docRef = doc(db, "viagens", id); const snap = await getDoc(docRef); if(snap.exists()) { let obs = snap.data().historico_obs || []; obs.splice(index, 1); await updateDoc(docRef, { historico_obs: obs }); renderizarMinhasOcorrencias(); } };
        
        window.acessoAdmin = () => { if(prompt("Senha:") === "60010774") mudarTela('admin'); };
        window.abrirModalConfigValores = () => { document.getElementById('modal-config-valores').classList.remove('hidden'); document.getElementById('cfg-perfil').innerHTML = Object.keys(PERFIS_PADRAO).map(k => `<option value="${k}">${k}</option>`).join(''); carregarValoresInput(); renderizarListaPrecos(); };
        window.carregarValoresInput = () => { const perfil = document.getElementById('cfg-perfil').value; const dados = globalPrecos[perfil] || { ...PERFIS_PADRAO[perfil], perfil: perfil }; document.getElementById('cfg-vlr-km').value = dados.valorKm; document.getElementById('cfg-vlr-fixo').value = dados.valorFrete; };
        window.salvarConfigValor = async () => { const perfil = document.getElementById('cfg-perfil').value; const vKm = parseFloat(document.getElementById('cfg-vlr-km').value); const vFixo = parseFloat(document.getElementById('cfg-vlr-fixo').value); if(!perfil || isNaN(vKm) || isNaN(vFixo)) return alert("Preencha todos os campos corretamente."); showLoader(); await setDoc(doc(db, "config_precos", perfil), { perfil: perfil, valorKm: vKm, valorFrete: vFixo, atualizadoEm: Date.now() }); hideLoader(); alert("Valor atualizado com sucesso!"); await carregarConfigPrecos(); renderizarListaPrecos(); };
        const carregarConfigPrecos = async () => { const snap = await getDocs(collection(db, "config_precos")); globalPrecos = {}; Object.keys(PERFIS_PADRAO).forEach(k => { globalPrecos[k] = { ...PERFIS_PADRAO[k], perfil: k }; }); snap.forEach(d => { globalPrecos[d.id] = d.data(); }); document.getElementById('mon-perfil').innerHTML = `<option value="TODOS">Todos os Veículos</option>` + Object.keys(globalPrecos).map(k=>`<option value="${k}">${k}</option>`).join(''); };
        const renderizarListaPrecos = () => { document.getElementById('lista-config-valores').innerHTML = Object.values(globalPrecos).map(p => `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/10"><span class="text-xs font-bold text-white">${p.perfil}</span><span class="text-[10px] text-emerald-400 font-mono">R$${p.valorKm}/km + R$${p.valorFrete}</span></div>`).join(''); };
        window.salvarObservacaoMotorista = async () => { const id = localStorage.getItem('v_id'); await updateDoc(doc(db, "viagens", id), { historico_obs: arrayUnion({tipo: document.getElementById('comp-tipo').value, texto: document.getElementById('comp-obs').value, hora: new Date().toLocaleTimeString()}) }); fecharModal('modal-complementos'); renderizarMinhasOcorrencias(); alert("Salvo!"); };
        window.abrirObsAdmin = (id) => { const v = listaGlobalViagens.find(x => x.id === id); document.getElementById('conteudo-obs-admin').innerHTML = v.historico_obs?.map(o=>`<div class='p-3 bg-slate-900 border border-white/10 rounded-lg mb-2'><p class='text-[9px] text-cyan-500 font-bold uppercase'>${o.tipo} • ${o.hora}</p><p class='text-xs text-slate-300'>${o.texto}</p></div>`).join('') || "<p class='text-center text-slate-500 text-xs py-4'>Sem registros.</p>"; document.getElementById('modal-ver-obs').classList.remove('hidden'); };
        window.excluirCard = async(id) => { if(confirm("Apagar?")) await deleteDoc(doc(db, "viagens", id)); };
        window.abrirModalGerarCodigo = () => { const p = [...new Set(listaGlobalViagens.map(v => v.placa.trim().toUpperCase()).filter(x=>x))].sort(); document.getElementById('gc-placa-select').innerHTML = p.map(x => `<option>${x}</option>`).join(''); document.getElementById('display-codigo-gerado').classList.add('hidden'); document.getElementById('modal-gerar-codigo').classList.remove('hidden'); };
        window.processarGeracaoCodigo = async () => { const p = document.getElementById('gc-placa-select').value; if(!p) return alert("Nenhuma placa."); const c = Math.floor(1000+Math.random()*9000); await setDoc(doc(db, "codigos_acesso", p), { codigo: String(c), placa: p }); document.getElementById('display-codigo-gerado').innerText = c; document.getElementById('display-codigo-gerado').classList.remove('hidden'); };
        
        window.abrirModalNotifAdmin = () => { document.getElementById('modal-gerenciar-notif').classList.remove('hidden'); renderizarNotificacoesAdmin(); };
        window.abrirModalMuralMotorista = () => { document.getElementById('modal-notificacoes').classList.remove('hidden'); document.getElementById('notif-badge').classList.add('hidden'); try{bipSound.play().catch(e=>{});}catch(e){} };
        window.renderizarNotificacoesAdmin = () => { document.getElementById('lista-notif-admin').innerHTML = listaNotificacoes.map(n => `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/10 mb-2"><span class="text-[10px] text-slate-300 w-4/5">${n.texto}</span><button onclick="excluirNotificacao('${n.id}')" class="text-red-400"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div>`).join(''); if(window.lucide) lucide.createIcons(); };
        window.salvarNotificacao = async () => { const t = document.getElementById('notif-texto').value; if(t) { await addDoc(collection(db, "notificacoes"), { texto: t, criadoEm: Date.now() }); document.getElementById('notif-texto').value = ""; } };
        window.excluirNotificacao = async (id) => { if(confirm("Excluir?")) await deleteDoc(doc(db, "notificacoes", id)); };
        
        window.abrirMonitoramento = () => { const hoje = new Date().toISOString().split('T')[0]; if(!document.getElementById('mon-ini').value) { document.getElementById('mon-ini').value = hoje; document.getElementById('mon-fim').value = hoje; } document.getElementById('modal-monitoramento').classList.remove('hidden'); setTimeout(atualizarMonitoramento, 100); if(monitInterval) clearInterval(monitInterval); monitInterval = setInterval(atualizarMonitoramento, 5000); };
        
        window.atualizarMonitoramento = () => { 
            const ini = document.getElementById('mon-ini').value, fim = document.getElementById('mon-fim').value; if(!ini || !fim) return;
            const perfilSel = document.getElementById('mon-perfil').value;
            const dIni = new Date(ini+"T00:00:00"), dFim = new Date(fim+"T23:59:59");
            
            let dados = listaGlobalViagens.filter(v => {
                const d = safeDate(v.dataInicio);
                const dataOk = d && d >= dIni && d <= dFim;
                const perfilOk = perfilSel === "TODOS" || v.perfilVeiculo === perfilSel;
                return dataOk && perfilOk;
            });

            const emRota = dados.filter(v => v.status === 'em_curso');
            const finalizados = dados.filter(v => v.status === 'finalizada');
            
            let totalFat = 0, totalKm = 0, dist = {};
            let ranking = {}; 
            
            const calcularFatViagem = (v, kmReal, isEstimativa) => {
                let valor = 0;
                let perfil = v.perfilVeiculo;
                
                if(isEstimativa) {
                    let placaNorm = normalizarPlaca(v.placa);
                    let rota = (v.rotasPossiveis && v.rotasPossiveis[0]) ? v.rotasPossiveis[0] : (globalPrevisoesHoje[placaNorm] && globalPrevisoesHoje[placaNorm][0]);
                    if(rota) {
                        kmReal = rota.km || 0;
                        perfil = rota.perfil || perfil;
                    }
                }

                if(perfil) {
                    const p = globalPrecos[perfil] || PERFIS_PADRAO[perfil] || {valorKm:0, valorFrete:0}; 
                    valor = (kmReal * p.valorKm) + p.valorFrete;
                }
                return { valor, perfil };
            };

            finalizados.forEach(v => { 
                const km = (v.kmFim||0) - (v.kmInicio||0); 
                totalKm += km; 
                const { valor, perfil } = calcularFatViagem(v, km, false);
                totalFat += valor;
                if(perfil) dist[perfil] = (dist[perfil]||0)+1;
                const chave = v.placa || "DESCONHECIDO";
                ranking[chave] = (ranking[chave] || 0) + valor;
            });

            emRota.forEach(v => { 
                const { valor, perfil } = calcularFatViagem(v, 0, true);
                totalFat += valor;
                if(perfil) dist[perfil] = (dist[perfil]||0)+1;
                const chave = v.placa || "DESCONHECIDO";
                ranking[chave] = (ranking[chave] || 0) + valor;
            });
            
            document.getElementById('kpi-total').innerText = emRota.length + finalizados.length;
            document.getElementById('kpi-ativos').innerText = emRota.length;
            document.getElementById('kpi-faturamento').innerText = totalFat.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('kpi-km-total').innerText = totalKm.toFixed(0) + " KM";
            
            document.getElementById('lista-mon-ativos').innerHTML = emRota.map(v => `<div class="bg-slate-800/40 p-2 rounded-lg border border-white/5 mb-1 flex justify-between"><div><span class="font-bold text-white text-[10px]">${v.placa}</span><br><span class="text-[9px] text-slate-400">${v.nome}</span></div><span class="text-amber-500 font-mono font-bold text-xs">${calcularTempo(safeDate(v.dataInicio).getTime())}</span></div>`).join('');
            document.getElementById('lista-mon-finalizados').innerHTML = finalizados.map(v => `<div class="bg-slate-800/40 p-2 rounded-lg border border-white/5 mb-1 flex justify-between"><div><span class="font-bold text-white text-[10px]">${v.placa}</span><br><span class="text-[9px] text-emerald-400">OK</span></div><span class="text-white font-mono font-bold text-xs">${(v.kmFim-v.kmInicio).toFixed(0)} KM</span></div>`).join('');
            
            if(chartStatus) chartStatus.destroy();
            chartStatus = new Chart(document.getElementById('chart-status-realtime').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(dist), datasets: [{ data: Object.values(dist), backgroundColor: ['#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#8b5cf6'], borderWidth: 0 }] }, options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: {size: 9} } } }, maintainAspectRatio: false } });
            
            if(chartRanking) chartRanking.destroy();
            const rankingArray = Object.entries(ranking).sort((a,b) => b[1] - a[1]).slice(0, 10); // TOP 10
            chartRanking = new Chart(document.getElementById('chart-ranking-realtime').getContext('2d'), { 
                type: 'bar', 
                data: { 
                    labels: rankingArray.map(r => r[0]), 
                    datasets: [{ 
                        label: 'Faturamento (R$)', 
                        data: rankingArray.map(r => r[1]), 
                        backgroundColor: '#06b6d4', 
                        borderRadius: 4 
                    }] 
                }, 
                options: { 
                    indexAxis: 'y', 
                    scales: { 
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {size: 9} } }, 
                        y: { grid: { display: false }, ticks: { color: '#fff', font: {size: 10, weight: 'bold'} } } 
                    }, 
                    plugins: { legend: { display: false } }, 
                    maintainAspectRatio: false 
                } 
            });
        };
        const calcularTempo = (i) => { const d = Math.floor((Date.now()-i)/1000); return new Date(d*1000).toISOString().substr(11,8); };
        const obterPosicao = () => new Promise((resolve) => { 
            if (!navigator.geolocation) { resolve({coords: {latitude:0, longitude:0}}); return; }
            const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve(pos), 
                () => resolve({coords: {latitude:0, longitude:0}}), 
                options
            );
        });
        const obterPerfilRecente = async (placa) => { const q = query(collection(db, "previsoes"), where("placa", "==", placa), orderBy("atualizadoEm", "desc"), limit(1)); const snap = await getDocs(q); return !snap.empty && snap.docs[0].data().rotas && snap.docs[0].data().rotas.length > 0 ? snap.docs[0].data().rotas[0].perfil : null; };
        const verificarViagemLonga = async (dataInicioTimestamp) => { const agora = Date.now(); const inicio = safeDate(dataInicioTimestamp).getTime(); if((agora - inicio)/(1000*60*60) > 24) document.getElementById('modal-alerta-24h').classList.remove('hidden'); };
        const comprimir = (f) => new Promise((resolve, reject) => { const url = URL.createObjectURL(f); const img = new Image(); img.onload = () => { URL.revokeObjectURL(url); const maxW = 800; let w = img.width, h = img.height; if (w > maxW) { h = Math.round(h * (maxW / w)); w = maxW; } const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', 0.6)); }; img.onerror = reject; img.src = url; });
        window.cancelarViagemManual = async () => { if(!confirm("Cancelar viagem?")) return; showLoader(); try { const id = localStorage.getItem('v_id'); const duracao = document.getElementById('cronometro-motorista').innerText; await updateDoc(doc(db, "viagens", id), { status: "cancelada", duracao: duracao, dataFim: Timestamp.now(), motivoCancelamento: "Manual" }); localStorage.removeItem('v_id'); hideLoader(); location.reload(); } catch (e) { hideLoader(); alert("Erro: " + e.message); } };

        // Listeners
        onSnapshot(query(collection(db, "viagens"), orderBy("dataInicio", "desc")), (snap) => { 
            listaGlobalViagens = snap.docs.map(d => ({ id: d.id, ...d.data() })); 
            renderizarAdmin(); 
            if(!document.getElementById('modal-monitoramento').classList.contains('hidden')) atualizarMonitoramento(); 
            if(!sistemaCarregado) { sistemaCarregado = true; hideLoader(); }
        });

        onSnapshot(collection(db, "notificacoes"), (snap) => { 
            listaNotificacoes = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.criadoEm - a.criadoEm); 
            document.getElementById('lista-notificacoes-motorista').innerHTML = listaNotificacoes.map(n => `<div class='p-3 bg-white/5 rounded-xl border-l-2 border-amber-500 mb-2'><p class='text-[9px] text-amber-500 font-bold mb-1'>${new Date(n.criadoEm).toLocaleDateString()}</p><p class='text-xs text-slate-300'>${n.texto}</p></div>`).join(''); 
            if(!document.getElementById('modal-gerenciar-notif').classList.contains('hidden')) renderizarNotificacoesAdmin(); 
            if (!isFirstLoadNotif && snap.docChanges().some(c => c.type === 'added')) { 
                document.getElementById('notif-badge').classList.remove('hidden');
                try { bipSound.play().catch(e=>{}); } catch(e){}
            } 
            isFirstLoadNotif = false; 
        });

        setInterval(() => { listaGlobalViagens.filter(v => v.status === 'em_curso').forEach(v => { const el = document.getElementById(`admin-timer-${v.id}`); if(el) el.innerText = calcularTempo(safeDate(v.dataInicio).getTime()); }); }, 1000);
        
        window.addEventListener('load', async () => { 
            if(window.lucide) lucide.createIcons(); 
            setTimeout(() => { if(!sistemaCarregado) hideLoader(); }, 5000);

            await carregarConfigPrecos(); 
            await carregarPrevisoesDoDia();
            const vid = localStorage.getItem('v_id'); 
            if(vid) { 
                try { 
                    // ATUALIZAÇÃO: Monitoramento em Tempo Real para o Motorista
                    const unsub = onSnapshot(doc(db, "viagens", vid), (docSnap) => {
                        if(docSnap.exists()) {
                            const data = docSnap.data();
                            
                            // SE FOI CANCELADA, RESETA
                            if(data.status === 'cancelada') {
                                alert("🛑 VIAGEM CANCELADA PELO GESTOR!");
                                localStorage.removeItem('v_id');
                                location.reload();
                                return;
                            }
                            
                            // SE ESTÁ EM CURSO, MOSTRA
                            if(data.status === 'em_curso') {
                                mudarTela('em-curso'); 
                                document.getElementById('info-viagem-ativa').innerText = "EM ROTA: " + data.placa; 
                                verificarViagemLonga(data.dataInicio); 
                            } else {
                                localStorage.removeItem('v_id'); 
                                location.reload();
                            }
                        } else {
                            // Documento sumiu (excluído)
                            localStorage.removeItem('v_id');
                            location.reload();
                        }
                    });

                    // Intervalo para cronometro local (visual apenas)
                    const s = await getDoc(doc(db, "viagens", vid));
                    if(s.exists()) {
                        setInterval(() => document.getElementById('cronometro-motorista').innerText = calcularTempo(safeDate(s.data().dataInicio).getTime()), 1000);
                    }
                } catch(e) {} 
            } 
            if(window.innerWidth > 768) {
                if(!document.getElementById('app-wrap').classList.contains('w-full-pc')){
                    alternarModoPC();
                }
            }
        });
    </script>
</body>
</html>
